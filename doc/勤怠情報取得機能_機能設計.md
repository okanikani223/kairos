# 勤怠情報取得機能 機能設計

## 1. 機能概要

勤怠情報取得機能は、指定した年月の勤怠情報をシステムから取得するためのAPIです。この機能により、ユーザーは過去の勤怠記録を確認したり、提出用のデータを取得したりすることができます。勤怠情報が存在しない場合は、404エラーを返します。勤怠情報の自動作成は「自動勤怠情報作成機能」として別途提供されます。

## 2. API仕様

### 2.1 エンドポイント
```
GET /api/v1/attendances
GET /api/v1/attendances/{year}
GET /api/v1/attendances/{year}/{month}
```

### 2.2 リクエストパラメータ
| パラメータ名 | 型 | 説明 | 必須 | 例 |
|-----------|------|------|------|-----|
| year | Number | 取得対象の年 | いいえ | 2025 |
| month | String | 取得対象の月（2桁、0埋め） | いいえ | 06 |

### 2.3 レスポンス形式
```json
{
  "success": true,
  "attendances": [
    {
      "id": "550e8400-e29b-41d4-a716-446655440000",
      "year": 2025,
      "month": 6,
      "userId": "550e8400-e29b-41d4-a716-446655441234",
      "details": [
      {
        "id": "550e8400-e29b-41d4-a716-446655440002",
        "date": "2025-06-01",
        "holiday": false,
        "leave": "",
        "startDateTime": "2025-06-01T09:00:00+09:00",
        "endDateTime": "2025-06-01T18:00:00+09:00",
        "restHour": "1.0",
        "workHour": "8.0",
        "overHour": "0.0",
        "note": ""
      },
      // 以下、月内の日数分の勤怠詳細が続く
    ],
    "summary": {
      "totalWorkDays": "20",
      "totalPaidLeaveDays": "1",
      "totalCompensatoryDays": "0",
      "totalSpecialLeaveDays": "0",
      "totalWorkHours": "160.0",
      "totalOverHours": "2.5",
      "totalHolidayWorkHours": "0.0"
    },
    "created": false
    }
    // 年月指定がない場合は複数の年月の勤怠情報が含まれる
  ]
}
```

| フィールド | 型 | 説明 |
|---------|------|------|
| success | Boolean | 処理成功フラグ |
| attendances | Array | 勤怠情報オブジェクトの配列 |
| attendances[].id | String (UUID) | 勤怠情報ID |
| attendances[].year | Number | 対象年 |
| attendances[].month | Number | 対象月 |
| attendances[].userId | String (UUID) | ユーザーID |
| attendances[].details | Array | 日毎の勤怠詳細の配列 |
| attendances[].summary | Object | 勤怠情報のサマリ |
| attendances[].created | Boolean | 新規作成されたかどうか（true: 自動作成された、false: 既存データ） |

### 2.4 エラーレスポンス
```json
{
  "success": false,
  "error": {
    "code": "UNAUTHORIZED_ACCESS",
    "message": "この勤怠情報へのアクセス権限がありません"
  }
}
```

## 3. 機能詳細

### 3.1 勤怠情報の取得
- 年月の指定に基づいて、以下のルールで勤怠情報をデータベースから検索:
  - 年月の指定がない場合: ユーザーの全ての作成済み勤怠情報を取得
  - 年のみ指定の場合: 指定された年の全ての月の作成済み勤怠情報を取得
  - 年月の指定がある場合: 指定された年月の勤怠情報のみを取得
- 勤怠情報が存在する場合は、その情報を返却
- 勤怠情報が存在しない場合は、404 Not Foundエラーを返却

### 3.3 勤怠情報のサマリ計算
- 日毎の勤怠情報から月次のサマリ情報を計算
  - 総勤務日数
  - 総有給休暇日数
  - 総代休日数
  - 総特別休暇日数
  - 総勤務時間
  - 総残業時間
  - 総休日出勤時間

## 4. セキュリティ要件

### 4.1 共通セキュリティ基盤
**参照**: セキュリティ要件記載標準 3節
- 認証・認可: JWT ベース認証、役割ベースアクセス制御
- 通信セキュリティ: HTTPS必須、CORS設定
- 監査・ログ: アクセスログ、操作ログ、セキュリティログ

### 4.2 機能固有セキュリティ要件

#### 4.2.1 アクセス制御
**所有者ベースアクセス制御**:
- 基本原則: ユーザーは自分のデータのみアクセス可能
- 例外権限: 管理者権限・上司権限による他ユーザーデータアクセス
- 権限チェック: APIレベル・サービスレベルでの二重チェック

**階層的アクセス制御**:
- 上司権限: 配下社員のデータアクセス権限
- 部門制限: 同一部門内のデータアクセス制限
- 人事権限: 人事部門による全社員データアクセス

#### 4.2.2 データ保護
**勤怠情報閲覧権限**:
- 本人、管理者、および権限を付与された者のみアクセス可能
- バージョン管理: 編集履歴を保持
- 機密性確保: 勤怠データの適切なアクセス制御

## 5. 機能特有の非機能要件

### 5.1 エラー処理に関する要件
- 勤怠情報が存在しない場合は、HTTPステータスコード404と適切なエラーメッセージを返却する
- 複数年月のデータ取得時、一部の年月のデータが存在しない場合は、存在するデータのみを返却する

## 6. 技術的実装詳細

### 6.1 勤務判定アルゴリズム
- **参照先**: [勤務判定アルゴリズム統一標準.md - 3.3 勤務時間判定アルゴリズム](./勤務判定アルゴリズム統一標準.md#33-勤務時間判定アルゴリズム)
- **用途**: 位置情報データから勤務開始・終了時刻を判定
- **処理概要**:
  1. 位置情報をタイムスタンプでソート
  2. 規定勤務地近辺（100m以内）の時間帯を特定
  3. 位置情報不足時はユーザー設定の規定時間をフォールバック値として使用
- **フォールバック条件**: ユーザー勤怠設定の`regulationStartTime`、`regulationEndTime`を基準値として使用

### 5.2 休暇判定ロジック
- **参照先**: [勤務判定アルゴリズム統一標準.md - 3.4 休暇自動判定アルゴリズム](./勤務判定アルゴリズム統一標準.md#34-休暇自動判定アルゴリズム)
- **用途**: 勤務記録から休暇種別の自動判定
- **判定条件**:
  - 勤務開始・終了記録がない平日は未入力と判定
  - 祝日・休日マスタと照合し、休日判定
  - 規定休憩時間を基準とした午前・午後有給の自動判定
  - 有給や代休の残日数を参照した休暇種別決定

## 6. 拡張性考慮事項

### 6.1 将来的な拡張可能性
- カレンダー情報との連携による休暇予定の自動反映
- 複数の規定勤務地に対応した勤怠判定ロジックの拡張

### 6.2 制限事項
- 複数の規定勤務地を短時間で移動する場合の判定精度に限界がある
- 在宅勤務など規定勤務地以外での勤務は自動判定が困難

## 7. テスト方針
- 単体テスト: 勤怠時間判定ロジックのテスト
- API統合テスト: リクエスト/レスポンスの整合性確認
- ケーステスト: 様々な勤務パターンでの自動判定精度の検証
- データ欠損テスト: 位置情報が部分的に欠損している場合の挙動確認

## 8. 依存関係

### 8.1 システム内依存
- **位置情報登録機能**：勤怠判定のための位置情報データ参照
- **ユーザー勤怠設定参照仕様**：UserAttendanceSettingモデルからの設定情報取得
  - 詳細仕様：`ユーザー勤怠設定参照仕様_機能設計.md`参照
  - 参照項目：regulationStartTime, regulationEndTime, regulationWorkHours等
  - 使用場面：自動作成時のデフォルト値取得、勤務判定アルゴリズム

### 8.2 外部依存
- 祝日マスタAPI：休日判定
- タイムゾーン管理ライブラリ：時刻計算

---

## 変更履歴
| 日付 | 変更者 | 変更内容 |
|-----|-------|---------|
| 2025/06/08 | カーン | 初版作成 - 勤怠情報取得機能の基本設計 |
| 2025/06/08 | カーン | 用語統一対応 - プロジェクト用語集に基づく用語の標準化 |
| 2025/06/08 | カーン | UserAttendanceSetting依存関係の明確化 |

※このドキュメントは開発の進行に合わせて随時更新されます。
