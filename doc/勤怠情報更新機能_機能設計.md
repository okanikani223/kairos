# 勤怠情報更新機能 機能設計

<!-- ドキュメント情報 -->
**作成日**: 2025/06/08  
**最終更新**: 2025/06/09  
**バージョン**: 1.1  
**担当者**: カーン  
**レビュー状況**: レビュー中  

## 関連文書
- [勤怠情報取得機能_機能設計.md](./勤怠情報取得機能_機能設計.md)
- [勤怠情報登録機能_機能設計.md](./勤怠情報登録機能_機能設計.md)
- [勤怠情報削除機能_機能設計.md](./勤怠情報削除機能_機能設計.md)
- [ドキュメント構造統一標準.md](./ドキュメント構造統一標準.md)

## 1. 機能概要

### 1.1 機能の目的・背景

勤怠情報更新機能は、既存の月次勤怠情報を柔軟に修正するためのAPIです。従業員の勤務実態の変更、入力ミスの修正、承認プロセス後の調整など、勤怠管理における変更要求に対応します。

**主要目的**：
- 既存勤怠データの正確性担保
- 効率的な勤怠修正プロセスの提供
- データ整合性を保持した更新処理
- 変更履歴の適切な記録

### 1.2 機能スコープ

**対象範囲**：
- 月次勤怠情報の全体更新
- 日次勤怠詳細の部分更新
- 自動再生成による一括更新
- 勤怠集計値の自動再計算

**除外範囲**：
- 承認済み勤怠の無制限更新（権限制御対象）
- 過去3か月以前のデータ更新
- 他ユーザーの勤怠データ更新（管理者権限除く）

### 1.3 前提条件・制約事項

**前提条件**：
- 更新対象の勤怠情報が既に存在すること
- 適切な認証・認可が行われていること
- 更新権限を有するユーザーであること

**制約事項**：
- 提出済み勤怠の更新は管理者承認が必要
- 過去データの更新期限は3か月以内
- 同時更新による競合状態の制御
- データ整合性を損なう更新の禁止

## 2. 要件・制約事項

### 2.1 機能要件

#### 2.1.1 更新パターン
- **全体更新（PUT）**: 月次勤怠データの完全置換
- **部分更新（PATCH）**: 特定フィールドのみの更新
- **詳細更新（PATCH detail）**: 日次データの個別更新
- **自動再生成**: generateOptionsを使用した再計算

#### 2.1.2 データ操作
- 勤怠詳細の追加・更新・削除
- 集計値の自動再計算
- 変更履歴の記録
- 関連データの整合性維持

#### 2.1.3 検証処理
- 更新データのバリデーション
- 業務ルールの適用
- 権限チェック
- 競合状態の検出・解決

### 2.2 非機能要件

#### 2.2.1 性能要件
- レスポンス時間: 3秒以内
- 同時更新処理: 50件/分
- データ整合性: ACID特性の保証

#### 2.2.2 可用性要件
- 稼働率: 99.9%
- 障害復旧時間: 4時間以内
- データ損失防止: 楽観的ロック制御

### 2.3 技術的制約

#### 2.3.1 システム制約
- HTTP メソッド: PUT, PATCH のみサポート
- データ形式: JSON
- 文字エンコーディング: UTF-8
- タイムゾーン: JST（+09:00）固定

#### 2.3.2 セキュリティ制約
- JWT認証必須
- HTTPS通信必須
- 操作ログ記録必須
- 個人情報保護対応

### 2.4 業務制約

#### 2.4.1 更新ルール
- 本人または管理者のみ更新可能
- 承認済みデータは承認者による解除後に更新
- 法定労働時間を超える更新は警告表示
- 過去データ更新は期限内のみ

#### 2.4.2 データ品質
- 必須項目の維持
- 計算値の自動整合
- 参照整合性の保持
- 監査証跡の保持

## 3. 業務フロー・ユースケース

### 3.1 基本フロー

#### 3.1.1 全体更新フロー
```
1. ユーザーが更新対象の勤怠情報を指定
2. システムが既存データの存在確認
3. ユーザーが新しい勤怠データを送信
4. システムがバリデーション実行
5. データベースでトランザクション開始
6. 既存データの論理削除
7. 新データの登録
8. 集計値の再計算
9. トランザクションコミット
10. 更新結果をレスポンス
```

#### 3.1.2 部分更新フロー
```
1. ユーザーが更新項目を指定
2. システムが現在データの取得
3. 楽観的ロック確認
4. 指定項目のみ更新
5. 関連計算値の自動更新
6. 変更履歴の記録
7. 更新結果の返却
```

### 3.2 代替フロー

#### 3.2.1 自動再生成フロー
```
1. ユーザーが再生成オプションを指定
2. 既存の手動データを保持
3. 位置情報データの再取得
4. 自動計算ロジックの再実行
5. 手動修正項目の保持
6. 新規計算値の適用
```

#### 3.2.2 競合解決フロー
```
1. 更新要求の受信
2. バージョン番号の確認
3. 競合検出時の警告表示
4. ユーザーによる競合解決選択
5. 最新データでの再更新
```

### 3.3 例外フロー

#### 3.3.1 権限エラーフロー
```
1. 権限不足の検出
2. 403 Forbidden エラーの返却
3. 適切な権限申請ガイダンス表示
```

#### 3.3.2 データ競合フロー
```
1. 楽観的ロック競合の検出
2. 409 Conflict エラーの返却
3. 最新データの提示
4. ユーザーによる再更新促進
```

## 4. API仕様

### 4.1 エンドポイント
```
PUT /api/v1/attendances/{attendanceId}
PATCH /api/v1/attendances/{attendanceId}
PATCH /api/v1/attendances/{attendanceId}/details/{detailId}
```

### 4.2 リクエスト形式

#### 4.2.1 全体更新リクエスト（PUT）
月次勤怠情報全体を新しいデータで置き換えます。
```json
{
  "year": 2025,
  "month": 6,
  "details": [
    {
      "date": "2025-06-01",
      "holiday": false,
      "leave": "",
      "startDateTime": "2025-06-01T09:00:00+09:00",
      "endDateTime": "2025-06-01T18:00:00+09:00",
      "restHour": "1.0",
      "workHour": "8.0",
      "overHour": "0.0",
      "note": "修正済み"
    }
  ]
}
```

#### 4.2.2 部分更新リクエスト（PATCH）
月次勤怠情報の一部を更新します。
```json
{
  "updateType": "partial",
  "details": [
    {
      "id": "550e8400-e29b-41d4-a716-446655440002",
      "date": "2025-06-01",
      "startDateTime": "2025-06-01T09:15:00+09:00",
      "endDateTime": "2025-06-01T18:30:00+09:00",
      "note": "時刻修正"
    },
    {
      "date": "2025-06-02",
      "holiday": false,
      "leave": "午前有給",
      "startDateTime": "2025-06-02T13:00:00+09:00",
      "endDateTime": "2025-06-02T18:00:00+09:00",
      "restHour": "0.0",
      "workHour": "5.0",
      "overHour": "0.0",
      "note": "午前有給追加"
    }
  ]
}
```

#### 4.2.3 自動再生成リクエスト（PATCH）
位置情報を基に勤怠情報を再生成します。
```json
{
  "updateType": "regenerate",
  "targetDates": ["2025-06-01", "2025-06-02", "2025-06-03"],
  "generateOptions": {
    "useLocationData": true,
    "fallbackToRegulation": true,
    "autoLeaveDetection": true
  },
  "preserveManualEdits": true
}
```

#### 4.2.4 詳細更新リクエスト（PATCH detail）
特定の日次詳細データのみを更新します。
```json
{
  "startDateTime": "2025-06-01T09:15:00+09:00",
  "endDateTime": "2025-06-01T18:30:00+09:00",
  "note": "出社時刻修正"
}
```

### 4.3 レスポンス形式

#### 4.3.1 更新成功レスポンス
```json
{
  "success": true,
  "attendance": {
    "id": "550e8400-e29b-41d4-a716-446655440000",
    "year": 2025,
    "month": 6,
    "userId": "550e8400-e29b-41d4-a716-446655441234",
    "details": [
      {
        "id": "550e8400-e29b-41d4-a716-446655440002",
        "date": "2025-06-01",
        "holiday": false,
        "leave": "",
        "startDateTime": "2025-06-01T09:15:00+09:00",
        "endDateTime": "2025-06-01T18:30:00+09:00",
        "restHour": "1.0",
        "workHour": "8.25",
        "overHour": "0.25",
        "note": "時刻修正",
        "autoGenerated": false,
        "lastModified": "2025-06-08T15:30:00+09:00"
      }
    ],
    "summary": {
      "totalWorkDays": "20",
      "totalPaidLeaveDays": "1",
      "totalCompensatoryDays": "0",
      "totalSpecialLeaveDays": "0",
      "totalWorkHours": "162.25",
      "totalOverHours": "2.75",
      "totalHolidayWorkHours": "0.0"
    },
    "version": 3,
    "updatedAt": "2025-06-08T15:30:00+09:00",
    "updateMethod": "partial"
  },
  "changedFields": ["startDateTime", "endDateTime", "workHour", "overHour", "note"],
  "recalculatedSummary": true
}
```

## 5. データ仕様

### 5.1 データモデル

#### 5.1.1 更新対象エンティティ
- **attendance**: 月次勤怠データの主エンティティ
- **attendanceDetail**: 日次勤怠データの子エンティティ
- **attendanceHistory**: 変更履歴の監査エンティティ
- **summary**: 集計データの派生エンティティ

#### 5.1.2 バージョン管理
```
- version: Number (楽観的ロック用バージョン番号)
- lastModified: DateTime (最終更新日時)
- modifiedBy: UUID (更新者ID)
- changeReason: String (変更理由)
```

### 5.2 バリデーション仕様

#### 5.2.1 更新権限検証
- **所有者確認**: ユーザーIDの一致または管理者権限
- **承認状態確認**: 提出済みデータの更新制限
- **期限確認**: 過去データ更新期限のチェック

#### 5.2.2 データ整合性検証
- **楽観的ロック**: バージョン番号による競合検出
- **参照整合性**: 外部キー制約の維持
- **業務ルール**: 時間計算の正確性確認

#### 5.2.3 変更内容検証
- **必須項目**: 必須フィールドの欠損チェック
- **データ型**: 型安全性の確認
- **範囲制限**: 有効値範囲の検証

### 5.3 データ変換仕様

#### 5.3.1 差分計算
- **変更検出**: 既存データとの差分抽出
- **影響範囲**: 変更による関連項目の特定
- **再計算対象**: 自動計算が必要な項目の識別

#### 5.3.2 履歴記録
- **変更前値**: 更新前データの保存
- **変更後値**: 更新後データの記録
- **変更理由**: 更新理由の記録

## 6. 業務ロジック

### 6.1 主要アルゴリズム

#### 6.1.1 部分更新アルゴリズム
```
1. 既存データの取得
2. バージョン番号の確認
3. 変更項目の特定
4. 影響する関連項目の計算
5. トランザクション開始
6. データ更新実行
7. 集計値の再計算
8. 履歴レコード作成
9. バージョン番号の更新
10. トランザクションコミット
```

#### 6.1.2 自動再生成アルゴリズム
```
1. 対象日付の特定
2. 手動編集項目の保護設定確認
3. 位置情報データの再取得
4. 自動計算ロジックの再実行
5. 手動編集項目との統合
6. 整合性チェック
7. 更新実行
```

### 6.2 計算式・判定ロジック

#### 6.2.1 時間再計算
```
// 労働時間の再計算
workHour = (endDateTime - startDateTime) - restHour
overHour = max(0, workHour - standardWorkHour)

// 集計値の再計算
totalWorkHours = sum(details.workHour)
totalOverHours = sum(details.overHour)
```

#### 6.2.2 変更影響度判定
```
// 高影響度変更（集計値再計算必要）
highImpactFields = ["startDateTime", "endDateTime", "restHour", "leave"]

// 中影響度変更（関連項目更新必要）
mediumImpactFields = ["holiday", "workHour", "overHour"]

// 低影響度変更（該当項目のみ）
lowImpactFields = ["note"]
```

### 6.3 業務ルール

#### 6.3.1 更新制限ルール
- 提出済み勤怠は管理者承認後のみ更新可
- 過去3か月以前のデータは更新不可
- 労働基準法違反となる更新は警告表示
- 同時編集による競合は後勝ちを防止

#### 6.3.2 データ保護ルール
- 手動編集項目の自動上書き防止
- 重要な変更は変更理由の記録必須
- 削除操作は論理削除のみ
- 監査証跡の完全保持

## 7. セキュリティ・権限制御

### 7.1 認証・認可

#### 7.1.1 API認証
- **認証方式**: JWTトークンベース
- **権限スコープ**: attendance:update, attendance:admin
- **トークン検証**: 署名・有効期限・権限確認

#### 7.1.2 更新権限
- **基本権限**: 本人の勤怠データのみ更新可能
- **管理者権限**: 全ユーザーの勤怠データ更新可能
- **代理権限**: 事前承認された代理更新
- **承認権限**: 提出済みデータの承認解除

### 7.2 データ保護

#### 7.2.1 楽観的ロック制御
- **バージョン管理**: 更新毎のバージョン番号増加
- **競合検出**: 更新時のバージョン番号チェック
- **競合解決**: ユーザーへの選択肢提示

#### 7.2.2 変更追跡
- **操作ログ**: 全更新操作の詳細記録
- **変更履歴**: データ変更の完全な追跡
- **アクセス制御**: 履歴データへの制限アクセス

### 7.3 監査・コンプライアンス

#### 7.3.1 変更監査
- **変更証跡**: WHO、WHEN、WHAT、WHYの記録
- **承認フロー**: 重要変更の承認プロセス
- **不正検出**: 異常な更新パターンの検出

#### 7.3.2 データ完全性
- **バックアップ**: 更新前データの自動バックアップ
- **復元機能**: 変更履歴からの復元
- **整合性チェック**: 定期的なデータ整合性確認

## 8. エラーハンドリング・例外処理

### 8.1 エラー分類

#### 8.1.1 更新関連エラー
- **409 Conflict**: バージョン競合、データ重複
- **412 Precondition Failed**: 楽観的ロック失敗
- **422 Unprocessable Entity**: 業務ルール違反
- **423 Locked**: リソースロック中

#### 8.1.2 権限関連エラー
- **401 Unauthorized**: 認証失敗
- **403 Forbidden**: 更新権限不足
- **404 Not Found**: 更新対象データ不存在

### 8.2 エラーレスポンス形式

#### 8.2.1 バージョン競合エラー
```json
{
  "success": false,
  "error": {
    "code": "VERSION_CONFLICT",
    "message": "データが他のユーザーにより更新されています",
    "details": {
      "currentVersion": 5,
      "requestVersion": 3,
      "lastModified": "2025-06-08T14:30:00+09:00",
      "lastModifiedBy": "user456"
    },
    "resolution": {
      "action": "REFRESH_AND_RETRY",
      "latestData": {
        // 最新データの提供
      }
    }
  }
}
```

#### 8.2.2 業務ルール違反エラー
```json
{
  "success": false,
  "error": {
    "code": "BUSINESS_RULE_VIOLATION",
    "message": "労働基準法に違反する可能性があります",
    "details": [
      {
        "field": "overHour",
        "violation": "OVERTIME_LIMIT_EXCEEDED",
        "message": "月間残業時間が上限を超過しています",
        "currentValue": "65.5",
        "limitValue": "45.0"
      }
    ],
    "severity": "WARNING",
    "allowOverride": true
  }
}
```

### 8.3 例外処理戦略

#### 8.3.1 競合解決
- **自動マージ**: 非競合項目の自動統合
- **ユーザー選択**: 競合項目のユーザー選択
- **強制上書き**: 管理者権限による強制更新

#### 8.3.2 ロールバック処理
- **部分失敗**: 関連更新の全体ロールバック
- **システムエラー**: 自動復旧機能
- **データ復元**: 履歴からの復元機能

## 9. 非機能要件

### 9.1 性能要件

#### 9.1.1 レスポンス性能
- **単一更新**: 2秒以内
- **一括更新**: 5秒以内（100件まで）
- **自動再生成**: 10秒以内

#### 9.1.2 同時実行性能
- **同時更新**: 100ユーザー
- **競合処理**: 1秒以内の競合検出
- **ロック待機**: 最大30秒

### 9.2 可用性要件

#### 9.2.1 システム可用性
- **稼働率**: 99.9%
- **障害復旧**: 4時間以内
- **データ保護**: 零損失保証

#### 9.2.2 障害対応
- **自動フェイルオーバー**: 30秒以内
- **データレプリケーション**: リアルタイム同期
- **バックアップ**: 15分間隔の増分バックアップ

### 9.3 保守性要件

#### 9.3.1 監視・運用
- **パフォーマンス監視**: レスポンス時間、スループット
- **エラー監視**: エラー率、エラーパターン
- **リソース監視**: CPU、メモリ、ディスク使用率

#### 9.3.2 保守機能
- **ログ管理**: 構造化ログ、ログローテーション
- **デバッグ支援**: トレース機能、デバッグモード
- **メンテナンス**: 計画停止、ローリングアップデート

## 10. テスト仕様

### 10.1 テスト方針

#### 10.1.1 テスト戦略
- **単体テスト**: 更新ロジック、計算処理のテスト
- **結合テスト**: API、データベース連携のテスト
- **E2Eテスト**: ユーザーシナリオベースのテスト
- **性能テスト**: 負荷、ストレス、耐久性テスト

#### 10.1.2 テスト観点
- **機能テスト**: 正常系、異常系、境界値
- **セキュリティテスト**: 認証、認可、脆弱性
- **データ整合性テスト**: 同時実行、競合処理
- **ユーザビリティテスト**: 操作性、エラーメッセージ

### 10.2 テストケース

#### 10.2.1 正常系テスト
1. **全体更新**: 有効データでの完全置換
2. **部分更新**: 特定フィールドの個別更新
3. **自動再生成**: generateOptionsによる再計算
4. **権限確認**: 適切な権限での更新実行

#### 10.2.2 異常系テスト
1. **バージョン競合**: 同時更新による競合状態
2. **権限エラー**: 不正な権限での更新試行
3. **データ不整合**: 無効なデータでの更新
4. **システムエラー**: DB接続エラー、タイムアウト

#### 10.2.3 境界値テスト
1. **時間境界**: 日跨ぎ、月跨ぎの時間処理
2. **データサイズ**: 最大・最小データでの処理
3. **同時実行**: 上限ユーザーでの同時更新
4. **期限境界**: 更新期限ギリギリでの処理

### 10.3 テストデータ

#### 10.3.1 基本テストデータ
```json
{
  "existingAttendance": {
    "id": "test-attendance-001",
    "version": 2,
    "year": 2025,
    "month": 6,
    "userId": "test-user-001"
  },
  "updateRequest": {
    "details": [
      {
        "date": "2025-06-01",
        "startDateTime": "2025-06-01T09:15:00+09:00",
        "note": "修正テスト"
      }
    ]
  }
}
```

#### 10.3.2 競合テストデータ
```json
{
  "conflictScenario": {
    "user1Update": {
      "version": 2,
      "field": "startDateTime",
      "value": "09:15:00"
    },
    "user2Update": {
      "version": 2,
      "field": "endDateTime", 
      "value": "18:30:00"
    }
  }
}
```

## 11. 実装ノート・技術的詳細

### 11.1 技術アーキテクチャ

#### 11.1.1 システム構成
- **アプリケーション層**: Node.js + Express + TypeScript
- **ビジネスロジック層**: Domain-Driven Design パターン
- **データアクセス層**: TypeORM + PostgreSQL
- **キャッシュ層**: Redis（セッション、一時データ）

#### 11.1.2 更新処理アーキテクチャ
- **Command Pattern**: 更新処理の統一化
- **Strategy Pattern**: 更新タイプ別の処理分岐
- **Observer Pattern**: 変更イベントの通知
- **Transaction Script**: データ整合性の保証

### 11.2 実装上の注意点

#### 11.2.1 パフォーマンス最適化
- **差分更新**: 変更項目のみの更新実行
- **バッチ処理**: 複数項目の一括更新
- **インデックス活用**: 効率的なクエリ実行
- **キャッシュ戦略**: 頻繁アクセスデータのキャッシュ

#### 11.2.2 データ整合性
- **ACID特性**: トランザクションによる整合性保証
- **楽観的ロック**: バージョン管理による競合制御
- **参照整合性**: 外部キー制約の適切な設定
- **制約チェック**: アプリケーション層での事前検証

#### 11.2.3 拡張性・保守性
- **レイヤー分離**: 責任範囲の明確な分離
- **依存性注入**: 疎結合な設計
- **設定外部化**: 環境依存設定の分離
- **ログ設計**: 追跡可能な詳細ログ

### 11.3 開発・運用ツール

#### 11.3.1 開発支援ツール
- **型安全性**: TypeScript strict mode
- **コード品質**: ESLint + Prettier + Husky
- **テスト**: Jest + Supertest + Factory Bot
- **API仕様**: OpenAPI 3.0 + Swagger UI

#### 11.3.2 運用支援ツール
- **監視**: Prometheus + Grafana + AlertManager
- **ログ**: Winston + Fluentd + Elasticsearch
- **トレーシング**: Jaeger（分散トレーシング）
- **メトリクス**: StatsD + InfluxDB

### 11.4 セキュリティ実装

#### 11.4.1 認証・認可
- **JWT実装**: jose ライブラリ使用
- **権限チェック**: デコレーターパターン
- **セッション管理**: Redis ベースセッション
- **CSRF対策**: SameSite Cookie + トークン

#### 11.4.2 データ保護
- **入力検証**: Joi バリデーション
- **SQLインジェクション対策**: パラメータ化クエリ
- **XSS対策**: DOMPurify によるサニタイズ
- **暗号化**: 機密データの AES-256 暗号化

---

## 変更履歴
| 日付 | 変更者 | 変更内容 |
|-----|-------|---------|
| 2025/06/08 | カーン | 初版作成 - 勤怠情報更新機能の基本設計 |
| 2025/06/08 | カーン | 楽観的ロック制御とバージョン管理の詳細追加 |
| 2025/06/09 | システム | ドキュメント構造統一標準（Level B）適用 - 11章構成への再編成、セキュリティ・エラーハンドリング・テスト仕様の体系化 |

※このドキュメントは開発の進行に合わせて随時更新されます。

**動作制御**：
- **参照先**: [generateOptions統一仕様.md - 3. オプション別動作仕様](./generateOptions統一仕様.md#3-オプション別動作仕様)
- **処理概要**: 位置情報使用可否、規定時間フォールバック、自動休暇判定の各種制御

**バリデーション**：
- **参照先**: [generateOptions統一仕様.md - 2.3 バリデーション仕様](./generateOptions統一仕様.md#23-バリデーション仕様)

#### 2.2.4 個別詳細更新リクエスト（PATCH detail）
特定の日の勤怠詳細のみを更新します。
```json
{
  "startDateTime": "2025-06-01T09:30:00+09:00",
  "endDateTime": "2025-06-01T18:15:00+09:00",
  "restHour": "1.0",
  "note": "個別修正"
}
```

### 2.3 リクエストパラメータ詳細

#### 2.3.1 共通パラメータ
| フィールド | 型 | 説明 | 必須 |
|---------|------|------|------|
| attendanceId | String (UUID) | 更新対象の勤怠情報ID（URLパス） | はい |
| detailId | String (UUID) | 更新対象の勤怠詳細ID（URLパス、個別更新時のみ） | 条件付き |

#### 2.3.2 部分更新パラメータ
| フィールド | 型 | 説明 | 必須 |
|---------|------|------|------|
| updateType | String | 更新タイプ（"partial", "regenerate"） | はい |
| details | Array | 更新する勤怠詳細（partial時） | 条件付き |
| targetDates | Array | 再生成対象日付（regenerate時） | 条件付き |
| generateOptions | Object | 自動生成オプション（regenerate時） | いいえ |

**generateOptionsパラメータ詳細**：

**基本仕様**：
- **参照先**: [generateOptions統一仕様.md](./generateOptions統一仕様.md)
- **必須性**: 任意（省略時はデフォルト値適用）
- **適用条件**: `updateType: "regenerate"`時のみ使用

**パラメータ定義**：
- **参照先**: [generateOptions統一仕様.md - 2.1 パラメータ定義](./generateOptions統一仕様.md#21-パラメータ定義)

**バリデーション仕様**：
- **参照先**: [generateOptions統一仕様.md - 2.3 バリデーション仕様](./generateOptions統一仕様.md#23-バリデーション仕様)

#### 2.3.3 勤怠詳細更新項目
| フィールド | 型 | 説明 | 更新可能 |
|---------|------|------|---------|
| id | String (UUID) | 勤怠詳細ID（既存レコード特定用） | 参照のみ |
| date | String | 日付（YYYY-MM-DD） | いいえ※1 |
| holiday | Boolean | 休日フラグ | はい |
| leave | String | 休暇種別 | はい |
| startDateTime | String | 勤怠開始時刻（ISO 8601） | はい |
| endDateTime | String | 勤怠終了時刻（ISO 8601） | はい |
| restHour | String | 休憩時間 | はい |
| workHour | String | 勤務時間 | はい※2 |
| overHour | String | 残業時間 | はい※2 |
| note | String | 備考 | はい |

**更新制限**：
- ※1 日付の変更は不可。別日のデータとして新規作成が必要
- ※2 workHour、overHourは手動指定も可能だが、通常は他の時刻項目から自動計算

### 2.4 レスポンス形式
```json
{
  "success": true,
  "attendance": {
    "id": "550e8400-e29b-41d4-a716-446655440000",
    "year": 2025,
    "month": 6,
    "userId": "550e8400-e29b-41d4-a716-446655441234",
    "details": [
      {
        "id": "550e8400-e29b-41d4-a716-446655440002",
        "date": "2025-06-01",
        "holiday": false,
        "leave": "",
        "startDateTime": "2025-06-01T09:30:00+09:00",
        "endDateTime": "2025-06-01T18:15:00+09:00",
        "restHour": "1.0",
        "workHour": "7.75",
        "overHour": "0.0",
        "note": "個別修正",
        "autoGenerated": false,
        "updatedAt": "2025-06-08T14:30:00+09:00"
      }
    ],
    "summary": {
      "totalWorkDays": "20",
      "totalPaidLeaveDays": "1",
      "totalCompensatoryDays": "0",
      "totalSpecialLeaveDays": "0",
      "totalWorkHours": "159.75",
      "totalOverHours": "2.5",
      "totalHolidayWorkHours": "0.0"
    },
    "updatedAt": "2025-06-08T14:30:00+09:00",
    "lastUpdateType": "partial"
  }
}
```

| フィールド | 型 | 説明 |
|---------|------|------|
| success | Boolean | 処理成功フラグ |
| attendance | Object | 更新後の勤怠情報オブジェクト |
| attendance.lastUpdateType | String | 最後の更新タイプ（"full", "partial", "regenerate"） |
| details[].updatedAt | String | 詳細レコードの最終更新日時 |

### 2.5 エラーレスポンス

#### 2.5.1 勤怠情報未存在エラー
```json
{
  "success": false,
  "error": {
    "code": "ATTENDANCE_NOT_FOUND",
    "message": "指定された勤怠情報が見つかりません",
    "details": "attendanceId: 550e8400-e29b-41d4-a716-446655440000"
  }
}
```

#### 2.5.2 勤怠詳細未存在エラー
```json
{
  "success": false,
  "error": {
    "code": "ATTENDANCE_DETAIL_NOT_FOUND",
    "message": "指定された勤怠詳細が見つかりません",
    "details": "detailId: 550e8400-e29b-41d4-a716-446655440002"
  }
}
```

#### 2.5.3 不正な更新データエラー
```json
{
  "success": false,
  "error": {
    "code": "INVALID_UPDATE_DATA",
    "message": "更新データに不正な値が含まれています",
    "details": [
      {
        "field": "details[0].startDateTime",
        "message": "終了時刻より後の時刻は指定できません"
      },
      {
        "field": "details[1].date",
        "message": "日付の変更はサポートされていません"
      }
    ]
  }
}
```

#### 2.5.4 権限不足エラー
```json
{
  "success": false,
  "error": {
    "code": "UPDATE_PERMISSION_DENIED",
    "message": "この勤怠情報を更新する権限がありません",
    "details": "自分の勤怠情報のみ更新可能です"
  }
}
```

#### 2.5.5 確定済み勤怠情報更新エラー
```json
{
  "success": false,
  "error": {
    "code": "ATTENDANCE_ALREADY_SUBMITTED",
    "message": "提出済みの勤怠情報は更新できません",
    "details": "提出を取り消してから更新してください"
  }
}
```

## 3. 機能詳細

### 3.1 全体更新（PUT）
- 既存の勤怠情報を完全に新しいデータで置き換え
- 指定されていない日の詳細は削除される
- サマリ情報は新しい詳細から再計算
- 楽観的ロックによる競合回避

#### 3.1.1 全体更新の処理フロー
```javascript
function updateAttendanceFull(attendanceId, newData) {
  // 1. 既存データの存在確認と権限チェック
  const existingAttendance = getAttendanceById(attendanceId);
  validateUpdatePermission(existingAttendance);
  
  // 2. 提出済みステータスの確認
  if (existingAttendance.status === 'submitted') {
    throw new Error('ATTENDANCE_ALREADY_SUBMITTED');
  }
  
  // 3. 新しいデータのバリデーション
  validateAttendanceData(newData);
  
  // 4. トランザクション内で更新実行
  return executeTransaction(() => {
    // 既存の詳細をすべて削除
    deleteAttendanceDetails(attendanceId);
    
    // 新しい詳細を挿入
    const newDetails = insertAttendanceDetails(attendanceId, newData.details);
    
    // サマリを再計算
    const summary = calculateSummary(newDetails);
    
    // 勤怠情報のメタデータを更新
    updateAttendanceMetadata(attendanceId, {
      summary: summary,
      updatedAt: new Date(),
      lastUpdateType: 'full'
    });
    
    return getAttendanceById(attendanceId);
  });
}
```

### 3.2 部分更新（PATCH）
- 指定された日の詳細のみを更新
- 未指定の詳細は既存のまま保持
- サマリ情報は変更された詳細を反映して再計算
- 新しい日の詳細も追加可能

#### 3.2.1 部分更新の処理フロー
```javascript
function updateAttendancePartial(attendanceId, updateData) {
  // 1. 既存データの取得と権限チェック
  const existingAttendance = getAttendanceById(attendanceId);
  validateUpdatePermission(existingAttendance);
  
  // 2. 更新データのバリデーション
  validatePartialUpdateData(updateData);
  
  // 3. 更新対象の詳細を特定
  const updatedDetails = [];
  for (const detailUpdate of updateData.details) {
    if (detailUpdate.id) {
      // 既存詳細の更新
      const existingDetail = getAttendanceDetailById(detailUpdate.id);
      const updatedDetail = mergeDetailData(existingDetail, detailUpdate);
      updatedDetails.push(updateAttendanceDetail(updatedDetail));
    } else if (detailUpdate.date) {
      // 新規詳細の追加
      const newDetail = createAttendanceDetail(attendanceId, detailUpdate);
      updatedDetails.push(newDetail);
    }
  }
  
  // 4. サマリの再計算
  const allDetails = getAllAttendanceDetails(attendanceId);
  const summary = calculateSummary(allDetails);
  
  // 5. メタデータの更新
  updateAttendanceMetadata(attendanceId, {
    summary: summary,
    updatedAt: new Date(),
    lastUpdateType: 'partial'
  });
  
  return getAttendanceById(attendanceId);
}
```

### 3.3 自動再生成更新
- 指定された日の詳細を位置情報から再生成
- 既存の手動修正データは上書きされる（警告表示）
- 位置情報が不足している場合は規定時間やエラーで対応

#### 3.3.1 自動再生成の処理フロー
```javascript
function updateAttendanceRegenerate(attendanceId, regenerateData) {
  // 1. 既存データの取得と権限チェック
  const existingAttendance = getAttendanceById(attendanceId);
  validateUpdatePermission(existingAttendance);
  
  // 2. 対象日付のバリデーション
  validateTargetDates(regenerateData.targetDates, existingAttendance);
  
  // 3. ユーザー設定の取得
  const userSettings = getUserAttendanceSetting(existingAttendance.userId);
  
  // 4. 各対象日について再生成実行
  const regeneratedDetails = [];
  for (const targetDate of regenerateData.targetDates) {
    // 位置情報の取得
    const locationData = getLocationDataByDate(
      existingAttendance.userId, 
      targetDate
    );
    
    // 勤怠詳細の自動生成
    const newDetail = generateDailyAttendance(
      new Date(targetDate),
      locationData,
      userSettings,
      regenerateData.generateOptions
    );
    
    // 既存詳細の更新または新規作成
    const existingDetail = findDetailByDate(existingAttendance.details, targetDate);
    if (existingDetail) {
      regeneratedDetails.push(updateAttendanceDetail({
        ...existingDetail,
        ...newDetail,
        autoGenerated: true,
        updatedAt: new Date()
      }));
    } else {
      regeneratedDetails.push(createAttendanceDetail(attendanceId, {
        ...newDetail,
        autoGenerated: true
      }));
    }
  }
  
  // 5. サマリの再計算とメタデータ更新
  const allDetails = getAllAttendanceDetails(attendanceId);
  const summary = calculateSummary(allDetails);
  
  updateAttendanceMetadata(attendanceId, {
    summary: summary,
    updatedAt: new Date(),
    lastUpdateType: 'regenerate'
  });
  
  return getAttendanceById(attendanceId);
}
```

### 3.4 個別詳細更新
- 特定の日の勤怠詳細のみを対象とした更新
- 最も軽量で高速な更新方法
- 時刻修正や備考追加などの用途

### 3.5 データ整合性の保証
- 楽観的ロック機能による同時更新の競合回避
- 時刻の論理的整合性チェック（開始時刻 < 終了時刻）
- 勤務時間の自動再計算と妥当性検証
- サマリ情報の自動更新

## 4. セキュリティ要件

### 4.1 共通セキュリティ基盤
**参照**: セキュリティ要件記載標準 3節
- 認証・認可: JWT ベース認証、役割ベースアクセス制御
- 通信セキュリティ: HTTPS必須、CORS設定
- 監査・ログ: アクセスログ、操作ログ、セキュリティログ

### 4.2 機能固有セキュリティ要件

#### 4.2.1 アクセス制御
**所有者ベースアクセス制御**:
- 基本原則: ユーザーは自分のデータのみアクセス可能
- 例外権限: 管理者権限・上司権限による他ユーザーデータアクセス
- 権限チェック: APIレベル・サービスレベルでの二重チェック

**階層的アクセス制御**:
- 上司権限: 配下社員のデータアクセス権限
- 部門制限: 同一部門内のデータアクセス制限
- 人事権限: 人事部門による全社員データアクセス

#### 4.2.2 データ保護
**更新権限制御**:
- 本人のみ更新可能: ユーザーは自分の勤怠情報のみ更新可能
- 管理者権限: システム管理者は全ユーザーの勤怠情報を更新可能
- 提出済み勤怠の保護: 提出済みの勤怠情報は更新不可

**データ整合性**:
- 監査ログ: 更新操作の完全な監査ログを記録
- データバックアップ: 更新前のデータのバックアップを自動保存
- 楽観的ロック: 同時更新制御による整合性保証

## 5. パフォーマンス要件

### 5.1 応答時間
- **個別詳細更新**: 200ms以内
- **部分更新（5日以内）**: 500ms以内
- **全体更新**: 1秒以内
- **自動再生成**: 2秒以内

### 5.2 同時処理
- **同時更新リクエスト**: ユーザーあたり最大3リクエスト/秒
- **楽観的ロック**: 競合発生時の適切なエラーレスポンス
- **トランザクション処理**: ACID特性の保証

## 6. エラーハンドリング

### 6.1 主要エラーケース
| エラーコード | HTTPステータス | 説明 | 対応方法 |
|------------|---------------|-----|---------|
| ATTENDANCE_NOT_FOUND | 404 | 対象の勤怠情報が存在しない | 正しいattendanceIdを指定 |
| ATTENDANCE_DETAIL_NOT_FOUND | 404 | 対象の勤怠詳細が存在しない | 正しいdetailIdを指定 |
| INVALID_UPDATE_DATA | 400 | 更新データの形式や値が不正 | 正しいデータ形式で再送信 |
| UPDATE_PERMISSION_DENIED | 403 | 更新権限なし | 本人の勤怠情報か確認 |
| ATTENDANCE_ALREADY_SUBMITTED | 409 | 提出済み勤怠情報の更新 | 提出取り消し後に更新 |
| OPTIMISTIC_LOCK_ERROR | 409 | 楽観的ロック競合 | 最新データを取得して再試行 |
| INSUFFICIENT_LOCATION_DATA | 422 | 再生成に必要な位置情報不足 | 手動更新または位置情報追加 |

## 7. テスト方針

### 7.1 単体テスト
- **更新タイプテスト**: 手動・自動・部分・全体更新の詳細検証
- **データバリデーション**: 全パラメータの境界値・形式・組み合わせテスト
- **権限チェック**: 詳細な権限パターンと例外ケースの確認
- **サマリ再計算**: 複雑な計算アルゴリズムの精度・境界値テスト
- **業務ロジック**: 複雑な業務ルールの網羅的検証
- **エラーハンドリング**: 例外系を含む全エラーケースの処理確認
- **状態管理**: データ状態変化のテスト

### 7.2 統合テスト
- **API エンドポイント**: 全エンドポイントの統合テスト
- **複数システム連携**: 詳細な連携パターンの統合確認
- **権限制御**: 全権限パターンと例外ケースの確認
- **データベース**: 複雑なトランザクション・整合性の確認
- **ワークフロー**: 更新業務フロー全体のエンドツーエンドテスト
- **楽観的ロック**: 同時更新シナリオの詳細テスト
- **監査ログ**: 監査データ記録の完全性確認

### 7.3 パフォーマンステスト
- **負荷テスト**: 詳細な負荷パターンでの性能確認
- **ストレステスト**: 限界値テストでの挙動確認
- **応答時間**: 詳細な基準時間での処理完了確認
- **同時処理**: 複雑な同時実行シナリオの性能測定
- **リソース使用量**: メモリ・CPU使用量の監視・測定

### 7.4 特別テスト
- **データ移行テスト**: 既存データとの整合性確認
- **セキュリティテスト**: 詳細なセキュリティ検証
- **障害テスト**: 障害シミュレーションでの復旧確認

## 8. 依存関係

### 8.1 システム内依存
- **勤怠情報登録機能**：勤怠情報の基本構造とバリデーション
- **勤怠情報取得機能**：既存データの参照
- **位置情報登録機能**：自動再生成時の位置情報参照
- **ユーザー勤怠設定参照仕様**：UserAttendanceSettingモデルからの設定情報取得
  - 詳細仕様：`ユーザー勤怠設定参照仕様_機能設計.md`参照
  - 参照項目：regulationStartTime, regulationEndTime, regulationWorkHours等
  - 使用場面：自動再生成更新時の規定時間取得

### 8.2 外部依存
- 祝日マスタAPI：休日判定（再生成時）
- タイムゾーン管理ライブラリ：時刻計算
- 日付処理ライブラリ：カレンダー計算

---

## 変更履歴
| 日付 | 変更者 | 変更内容 |
|-----|-------|---------|
| 2025/06/08 | カーン | 初版作成 - 勤怠情報更新機能の詳細設計 |

※このドキュメントは開発の進行に合わせて随時更新されます。
