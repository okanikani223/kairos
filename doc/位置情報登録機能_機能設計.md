# 位置情報登録機能 機能設計

## 1. 機能概要

位置情報登録機能は、ユーザーの現在地をシステムに記録するためのAPIです。この機能により、勤怠情報の自動作成のための基礎データが提供されます。位置情報はスマートフォンやPCなどのデバイスから定期的に送信され、サーバーに保存されます。

## 2. API仕様

### 2.1 エンドポイント
```
POST /api/v1/locations
```

### 2.2 リクエスト形式
```json
{
  "latitude": "35.681236",
  "longitude": "139.767125",
  "accuracy": 15.0
}
```

| フィールド | 型 | 説明 | 必須 |
|---------|------|------|------|
| latitude | String | 緯度情報 | はい |
| longitude | String | 経度情報 | はい |
| accuracy | Number | 位置精度（メートル） | いいえ |

### 2.3 レスポンス形式
```json
{
  "success": true,
  "locationId": "550e8400-e29b-41d4-a716-446655440000",
  "recordedAt": "2025-06-01T09:00:00+09:00"
}
```

| フィールド | 型 | 説明 |
|---------|------|------|
| success | Boolean | 処理成功フラグ |
| locationId | String (UUID) | 作成された位置情報のID |
| recordedAt | String (ISO8601) | サーバー側で記録した時間 |

### 2.4 エラーレスポンス
```json
{
  "success": false,
  "error": {
    "code": "INVALID_LOCATION",
    "message": "位置情報が不正です"
  }
}
```

## 3. 機能詳細

### 3.1 位置情報の検証
- 緯度・経度の値が有効な範囲内か確認（緯度: -90〜90、経度: -180〜180）
- 精度が一定の閾値以下であるか確認（例：精度が100m以上の場合は警告または情報として記録）

### 3.2 位置情報の保存
- 受け取った位置情報をデータベースに保存
- サーバー側でタイムスタンプを付与
- 関連するユーザーIDと紐付け（認証情報から取得）

### 3.3 自動勤務情報生成のための準備
- 位置情報の登録をトリガーとして、必要に応じて勤怠情報作成プロセスを非同期で開始
- 登録された位置情報を使用して、近接する勤怠情報提出先を後続の処理で判定可能にする

## 4. 非機能要件

### 4.1 パフォーマンス要件
- API応答時間: 平均500ms以内
- 同時リクエスト処理: 最大100リクエスト/秒

### 4.2 セキュリティ要件
- 通信は必ずHTTPS（TLS 1.2以上）で行う
- リクエスト認証: JWT認証必須
- 位置情報データは暗号化して保存

### 4.3 可用性要件
- 稼働率: 99.9%（月間ダウンタイム約43分以内）
- バックアップ: 日次

## 5. 技術的実装詳細

### 5.1 距離計算アルゴリズム
Haversine公式を使用して地球上の2点間の距離を計算（勤怠情報作成処理で使用）

```javascript
function calculateDistance(lat1, lon1, lat2, lon2) {
  const R = 6371e3; // 地球の半径（メートル）
  const φ1 = lat1 * Math.PI/180;
  const φ2 = lat2 * Math.PI/180;
  const Δφ = (lat2-lat1) * Math.PI/180;
  const Δλ = (lon2-lon1) * Math.PI/180;

  const a = Math.sin(Δφ/2) * Math.sin(Δφ/2) +
          Math.cos(φ1) * Math.cos(φ2) *
          Math.sin(Δλ/2) * Math.sin(Δλ/2);
  const c = 2 * Math.atan2(Math.sqrt(a), Math.sqrt(1-a));

  return R * c; // メートル単位の距離
}
```

### 5.2 バッチ処理オプション
- 位置情報の登録頻度を調整可能に設計（例：出勤・退勤予想時刻の前後は高頻度、その他の時間帯は低頻度）
- 勤怠情報作成のトリガーを定期バッチ処理としても実行可能に設計

## 6. 拡張性考慮事項

### 6.1 将来的な拡張可能性
- 位置情報の履歴表示機能
- 位置情報の精度向上のため、Wi-Fi、携帯電話基地局情報等の併用
- 複数デバイスからの情報統合機能

### 6.2 制限事項
- GPS信号が取得できない環境（地下など）での動作制限
- バッテリー消費を考慮した最適な位置情報取得頻度の設定必要性

## 7. テスト方針
- 単体テスト: 位置情報の検証ロジックのテスト
- API統合テスト: リクエスト/レスポンスの整合性確認
- 負荷テスト: 同時多数リクエスト時の挙動確認
