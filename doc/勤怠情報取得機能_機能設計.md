# 勤怠情報取得機能 機能設計

**作成日**: 2025/06/08  
**最終更新**: 2025/06/09  
**バージョン**: 1.1.0  
**担当者**: カーン  
**レビュー状況**: Draft

## 関連文書
- [ドキュメント構造統一標準](ドキュメント構造統一標準.md) - 文書構造の基本方針
- [勤務判定アルゴリズム統一標準](勤務判定アルゴリズム統一標準.md) - アルゴリズムの詳細仕様
- [ユーザー勤怠設定参照仕様_機能設計](ユーザー勤怠設定参照仕様_機能設計.md) - 依存する設定情報仕様

## 1. 機能概要

### 1.1 機能の目的・背景
勤怠情報取得機能は、指定した年月の勤怠情報をシステムから取得するためのAPIです。この機能により、ユーザーは過去の勤怠記録を確認したり、提出用のデータを取得したりすることができます。

### 1.2 機能スコープ
- 年月指定による勤怠情報の取得
- 勤怠データが存在しない場合の適切な404エラー返却
- 勤怠データのサマリ情報（合計勤務日数、有給取得日数等）の計算と提供

### 1.3 前提条件・制約事項
- 勤怠情報の自動作成は「自動勤怠情報作成機能」として別途提供される
- 認証済みユーザーのみが自身の勤怠情報にアクセス可能
- 複数年月のデータ取得時、一部年月のデータが存在しない場合は存在するデータのみを返却

## 2. 要件・制約事項

### 2.1 機能要件
- 年・月パラメータによる勤怠情報のフィルタリング取得
- 勤怠データ詳細（日毎の開始・終了時刻、休憩時間、勤務時間等）の提供
- 月次サマリ情報（総勤務日数、有給取得日数等）の自動計算

### 2.2 非機能要件

#### 2.2.1 パフォーマンス要件
**応答時間**: 300ms以内（単純取得）
**同時処理**: 100リクエスト/秒まで対応

#### 2.2.2 セキュリティ要件
**参照**: セキュリティ要件記載標準 3節（共通基盤要件）
- JWT認証必須
- 役割ベースアクセス制御

#### 2.2.3 エラーハンドリング
- HTTP標準ステータスコード使用
- 構造化エラーレスポンス
- ユーザー向けエラーメッセージ

#### 2.2.4 ログ要件
- アクセスログ記録必須
- エラーログ詳細記録
- パフォーマンスログ出力

### 2.3 技術的制約
- RESTful API設計に準拠
- JSON形式でのデータ交換
- ISO 8601形式での日時表現

### 2.4 業務制約
- 所有者ベースアクセス制御: ユーザーは自身の勤怠情報のみアクセス可能
- データ機密性: 勤怠データの適切なアクセス制御が必要

## 3. 業務フロー・ユースケース

### 3.1 基本フロー
1. ユーザーが年月を指定して勤怠情報取得をリクエスト
2. システムが認証・認可チェックを実行
3. 指定された年月の勤怠データを検索
4. 勤怠データ詳細とサマリ情報を計算
5. JSON形式でレスポンスを返却

### 3.2 代替フロー
- 年月パラメータ未指定時: 現在月のデータを取得
- 複数年月指定時: 存在するデータのみを返却

### 3.3 例外フロー
- 勤怠データ不存在時: 404エラーを返却
- 権限不足時: 403エラーを返却
- 不正パラメータ時: 400エラーを返却

## 4. API仕様

### 4.1 エンドポイント定義
```
GET /api/v1/attendances
GET /api/v1/attendances/{year}
GET /api/v1/attendances/{year}/{month}
```

### 4.2 リクエスト仕様
| パラメータ名 | 型 | 説明 | 必須 | 例 |
|-----------|------|------|------|-----|
| year | Number | 取得対象の年 | いいえ | 2025 |
| month | String | 取得対象の月（2桁、0埋め） | いいえ | 06 |

### 4.3 レスポンス仕様
```json
{
  "success": true,
  "attendances": [
    {
      "id": "550e8400-e29b-41d4-a716-446655440000",
      "year": 2025,
      "month": 6,
      "userId": "550e8400-e29b-41d4-a716-446655441234",
      "details": [
      {
        "id": "550e8400-e29b-41d4-a716-446655440002",
        "date": "2025-06-01",
        "holiday": false,
        "leave": "",
        "startDateTime": "2025-06-01T09:00:00+09:00",
        "endDateTime": "2025-06-01T18:00:00+09:00",
        "restHour": "1.0",
        "workHour": "8.0",
        "overHour": "0.0",
        "note": ""
      },
      // 以下、月内の日数分の勤怠詳細が続く
    ],
    "summary": {
      "totalWorkDays": "20",
      "totalPaidLeaveDays": "1",
      "totalCompensatoryDays": "0",
      "totalSpecialLeaveDays": "0",
      "totalWorkHours": "160.0",
      "totalOverHours": "2.5",
      "totalHolidayWorkHours": "0.0"
    },
    "created": false
    }
    // 年月指定がない場合は複数の年月の勤怠情報が含まれる
  ]
}
```

| フィールド | 型 | 説明 |
|---------|------|------|
| success | Boolean | 処理成功フラグ |
| attendances | Array | 勤怠情報オブジェクトの配列 |
| attendances[].id | String (UUID) | 勤怠情報ID |
| attendances[].year | Number | 対象年 |
| attendances[].month | Number | 対象月 |
| attendances[].userId | String (UUID) | ユーザーID |
| attendances[].details | Array | 日毎の勤怠詳細の配列 |
| attendances[].summary | Object | 勤怠情報のサマリ |
| attendances[].created | Boolean | 新規作成されたかどうか（true: 自動作成された、false: 既存データ） |

### 4.4 HTTPステータスコード
| ステータスコード | 説明 |
|----------------|------|
| 200 OK | 勤怠情報の取得に成功 |
| 400 Bad Request | リクエストパラメータが不正 |
| 401 Unauthorized | 認証情報が無効 |
| 403 Forbidden | アクセス権限がない |
| 404 Not Found | 指定された勤怠情報が存在しない |
| 500 Internal Server Error | サーバー内部エラー |

## 5. データ仕様

### 5.1 データモデル
勤怠情報取得機能で扱うデータモデルの詳細仕様

#### AttendanceData
| フィールド名 | 型 | 必須 | 説明 |
|------------|------|------|------|
| id | String | ○ | 勤怠情報ID（UUID形式） |
| year | Number | ○ | 対象年 |
| month | Number | ○ | 対象月 |
| userId | String | ○ | ユーザーID |
| details | AttendanceDetail[] | ○ | 日毎勤怠詳細 |
| summary | AttendanceSummary | ○ | 月次サマリ |

#### AttendanceDetail
| フィールド名 | 型 | 必須 | 説明 |
|------------|------|------|------|
| id | String | ○ | 勤怠詳細ID |
| date | String | ○ | 対象日（YYYY-MM-DD形式） |
| holiday | Boolean | ○ | 休日フラグ |
| leave | String | － | 休暇種別 |
| startDateTime | String | － | 勤務開始時刻（ISO 8601形式） |
| endDateTime | String | － | 勤務終了時刻（ISO 8601形式） |
| restHour | String | － | 休憩時間 |
| workHour | String | － | 勤務時間 |
| overHour | String | － | 残業時間 |
| note | String | － | 備考 |

### 5.2 バリデーション仕様
- year: 1900以上、現在年+10以下
- month: 01-12の範囲、2桁0埋め形式
- 日時フィールド: ISO 8601形式準拠

### 5.3 データ変換仕様
- 内部的な時刻データを日本時間（JST）でレスポンス
- 数値型の時間データを文字列形式で出力（小数点1桁まで）

## 6. 業務ロジック

### 6.1 主要アルゴリズム
#### 勤務判定アルゴリズム
- **参照先**: [勤務判定アルゴリズム統一標準.md - 3.3 勤務時間判定アルゴリズム](./勤務判定アルゴリズム統一標準.md#33-勤務時間判定アルゴリズム)
- **用途**: 位置情報データから勤務開始・終了時刻を判定

#### 休暇判定ロジック
- **参照先**: [勤務判定アルゴリズム統一標準.md - 3.4 休暇自動判定アルゴリズム](./勤務判定アルゴリズム統一標準.md#34-休暇自動判定アルゴリズム)
- **用途**: 勤務記録から休暇種別の自動判定

### 6.2 計算式・判定ロジック
#### サマリ計算ロジック
- 総勤務日数: holiday=falseかつworkHour>0の日数
- 有給取得日数: leave="有給"の日数
- 総勤務時間: workHourの合計値

### 6.3 業務ルール
- 位置情報不足時はユーザー設定の規定時間をフォールバック値として使用
- 祝日・休日マスタと照合し、休日判定を実施
- 規定休憩時間を基準とした午前・午後有給の自動判定

## 7. セキュリティ・権限制御

### 7.1 認証・認可要件
- JWT認証による本人確認
- 所有者ベースアクセス制御: ユーザーは自身の勤怠情報のみアクセス可能

### 7.2 データアクセス制御
- ユーザーIDによるデータフィルタリング
- クロスユーザーアクセスの防止

### 7.3 セキュリティ考慮事項
- 勤怠データの機密性確保
- ログ出力時の個人情報マスキング

## 8. エラーハンドリング・例外処理

### 8.1 エラー分類
- **クライアントエラー**: 不正なリクエストパラメータ
- **認証エラー**: 認証情報の不備
- **データエラー**: 勤怠情報の不存在
- **システムエラー**: 内部処理エラー

### 8.2 エラーレスポンス
```json
{
  "success": false,
  "error": {
    "code": "ATTENDANCE_NOT_FOUND", 
    "message": "指定された年月の勤怠情報が見つかりません"
  }
}
```

### 8.3 ログ出力仕様
- 情報レベル: 正常な勤怠情報取得処理
- 警告レベル: データ不存在、パラメータ不正
- エラーレベル: システム内部エラー

## 9. テスト仕様
- **リソース使用率**: CPU 50%以下、メモリ 70%以下（通常時）
- **ログ保持期間**: 30日間

## 10. テスト仕様

### 10.1 テスト方針
- **単体テスト**: 勤怠時間判定ロジックの正常系・異常系テスト
- **統合テスト**: API統合テスト、認証・認可機能確認
- **パフォーマンステスト**: 負荷テスト、応答時間確認

### 10.2 テストケース
#### 基本機能テスト
- 年月パラメータの境界値テスト
- エラーハンドリング: データ不存在・権限エラーケースの確認

#### 統合テスト
- リクエスト/レスポンスの整合性確認
- 所有者ベースアクセス制御の確認

### 10.3 テストデータ
- 正常系: 標準的な勤怠データパターン
- 異常系: データ不存在、権限不正パターン

## 11. 実装ノート・技術的詳細

### 11.1 実装上の注意点
- 複数年月のデータ取得時、一部の年月のデータが存在しない場合は、存在するデータのみを返却
- フォールバック条件: ユーザー勤怠設定の`regulationStartTime`、`regulationEndTime`を基準値として使用

### 11.2 技術的詳細
#### 依存関係
- **システム内依存**：
  - 位置情報登録機能：勤怠判定のための位置情報データ参照
  - ユーザー勤怠設定参照仕様：UserAttendanceSettingモデルからの設定情報取得
- **外部依存**：
  - 祝日マスタAPI：休日判定
  - タイムゾーン管理ライブラリ：時刻計算

### 11.3 パフォーマンス考慮事項
- データベースクエリの最適化
- 必要なインデックスの設定（userId, year, month）
- キャッシュ戦略の検討（月次サマリデータ）

---

## 変更履歴
| 日付 | 変更者 | 変更内容 |
|-----|-------|---------|
| 2025/06/08 | カーン | 初版作成 - 勤怠情報取得機能の基本設計 |
| 2025/06/08 | カーン | 用語統一対応 - プロジェクト用語集に基づく用語の標準化 |
| 2025/06/08 | カーン | UserAttendanceSetting依存関係の明確化 |
| 2025/06/09 | カーン | ドキュメント構造統一標準適用 - Level B標準構造への再構成 |
