# 勤怠情報提出先更新機能 機能設計

## ドキュメントヘッダー

| 項目 | 内容 |
|------|------|
| 作成日 | 2025/06/08 |
| 最終更新 | 2025/06/08 |
| バージョン | 2.0.0 |
| 担当者 | カーン |
| レビュー状況 | ドキュメント構造統一適用済み |
| 構造適用レベル | Level B（11章構成） |

## 関連文書

- [ドキュメント構造統一標準.md](./ドキュメント構造統一標準.md) - Level B標準構造
- [勤怠情報提出先取得機能_機能設計.md](./勤怠情報提出先取得機能_機能設計.md) - 関連機能
- [勤怠情報提出先登録機能_機能設計.md](./勤怠情報提出先登録機能_機能設計.md) - 関連機能
- [勤怠情報提出先削除機能_機能設計.md](./勤怠情報提出先削除機能_機能設計.md) - 関連機能

## 1. 機能概要

### 1.1 機能の目的
勤怠情報提出先更新機能は、既存の勤怠情報提出先（会社・組織）の情報を更新するためのAPIです。この機能では、会社名、位置情報、規定勤務時間、所属期間などの情報を部分的または全体的に更新することができます。

### 1.2 主要機能
- **全体更新（PUT）**: 提出先の全ての情報を一括で更新
- **部分更新（PATCH）**: 提出先の一部の情報のみを更新
- **楽観的ロック**: 同時更新による競合状態の制御
- **入力値検証**: データ整合性とビジネスルールの確保

### 1.3 利用シーン
- 勤務先の基本情報変更時
- 勤務時間・休憩時間の変更時
- 所属期間の変更・延長時
- 勤務地の移転・変更時

## 2. 要件・制約事項

### 2.1 機能要件
- **FR001**: 提出先の全ての情報を一括更新できること（PUT方式）
- **FR002**: 提出先の一部の情報のみを更新できること（PATCH方式）
- **FR003**: 更新前に入力値の妥当性を検証すること
- **FR004**: 他のユーザーによる同時更新を検出・制御すること
- **FR005**: 更新操作の監査ログを記録すること

### 2.2 非機能要件
- **NFR001**: 全体更新処理は800ms以内で完了すること
- **NFR002**: 部分更新処理は500ms以内で完了すること
- **NFR003**: 楽観的ロックによる安全な同時更新制御を実装すること
- **NFR004**: 適切な権限制御により不正アクセスを防止すること

### 2.3 制約事項
- **CON001**: ユーザーは自分の提出先のみ更新可能
- **CON002**: 管理者権限を持つユーザーは他ユーザーの提出先も更新可能
- **CON003**: 所属期間の開始日は終了日より前でなければならない
- **CON004**: 勤務開始時刻は勤務終了時刻より前でなければならない
- **CON005**: 位置情報は有効な緯度・経度の範囲内でなければならない

### 2.4 前提条件
- **PRE001**: 更新対象の提出先が既に存在すること
- **PRE002**: リクエストユーザーが適切に認証されていること
- **PRE003**: リクエストユーザーが対象提出先への更新権限を持つこと

## 3. 業務フロー・ユースケース

### 3.1 基本更新フロー
```
[ユーザー] → [権限確認] → [入力値検証] → [楽観的ロック確認] → [データ更新] → [監査ログ記録] → [レスポンス返却]
```

### 3.2 全体更新ユースケース
1. **ユーザー認証**: JWT認証による本人確認
2. **権限確認**: 提出先の所有権限を確認
3. **入力値検証**: 全項目の妥当性を検証
4. **楽観的ロック**: 同時更新の競合チェック
5. **データ更新**: 全ての項目を新しい値で更新
6. **監査ログ**: 更新操作を記録
7. **レスポンス**: 更新後のデータを返却

### 3.3 部分更新ユースケース
1. **ユーザー認証**: JWT認証による本人確認
2. **権限確認**: 提出先の所有権限を確認
3. **入力値検証**: 指定項目のみの妥当性を検証
4. **楽観的ロック**: 同時更新の競合チェック
5. **データ更新**: 指定された項目のみを新しい値で更新
6. **監査ログ**: 更新操作を記録
7. **レスポンス**: 更新後のデータを返却

### 3.4 エラーハンドリングフロー
```
[エラー発生] → [エラー種別判定] → [適切なHTTPステータス設定] → [エラーレスポンス生成] → [ログ記録] → [レスポンス返却]
```

## 4. API仕様

### 4.1 エンドポイント

#### 4.1.1 全体更新
```
PUT /api/v1/companies/{companyId}
```

#### 4.1.2 部分更新
```
PATCH /api/v1/companies/{companyId}
```

### 4.2 リクエスト形式

#### 4.2.1 全体更新リクエスト（PUT）
```json
{
  "companyName": "株式会社サンプル（更新版）",
  "location": {
    "latitude": "35.6895",
    "longitude": "139.6917"
  },
  "regulationStartTime": "08:30",
  "regulationEndTime": "17:30",
  "regulationRestStartTime": "12:00",
  "regulationRestEndTime": "13:00",
  "affiliationStartDate": "2025-01-01",
  "affiliationEndDate": "2025-12-31"
}
```

#### 4.2.2 部分更新リクエスト（PATCH）
```json
{
  "companyName": "株式会社サンプル（更新版）",
  "regulationStartTime": "08:30",
  "regulationEndTime": "17:30"
}
```

### 4.3 パスパラメータ

| パラメータ名 | 型 | 必須 | 説明 |
|------------|---|-----|-----|
| companyId | String | ○ | 更新対象の会社ID（UUID形式） |

### 4.4 リクエストパラメータ

| パラメータ名 | 型 | PUT必須 | PATCH必須 | 説明 |
|------------|---|---------|-----------|-----|
| companyName | String | ○ | × | 会社名（1文字以上100文字以内） |
| location | Object | ○ | × | 勤務地の位置情報 |
| location.latitude | String | ○ | × | 緯度（-90.0～90.0の範囲） |
| location.longitude | String | ○ | × | 経度（-180.0～180.0の範囲） |
| regulationStartTime | String | ○ | × | 規定勤務開始時刻（HH:mm形式） |
| regulationEndTime | String | ○ | × | 規定勤務終了時刻（HH:mm形式） |
| regulationRestStartTime | String | × | × | 規定休憩開始時刻（HH:mm形式） |
| regulationRestEndTime | String | × | × | 規定休憩終了時刻（HH:mm形式） |
| affiliationStartDate | String | ○ | × | 所属開始日（YYYY-MM-DD形式） |
| affiliationEndDate | String | × | × | 所属終了日（YYYY-MM-DD形式、null可） |

### 4.5 レスポンス形式

#### 4.5.1 成功レスポンス（200 OK）
```json
{
  "status": "success",
  "data": {
    "company": {
      "id": "12345678-1234-1234-1234-123456789abc",
      "companyName": "株式会社サンプル（更新版）",
      "location": {
        "latitude": "35.6895",
        "longitude": "139.6917"
      },
      "regulationStartTime": "08:30",
      "regulationEndTime": "17:30",
      "regulationRestStartTime": "12:00",
      "regulationRestEndTime": "13:00",
      "affiliationStartDate": "2025-01-01",
      "affiliationEndDate": "2025-12-31",
      "createdAt": "2025-06-08T10:30:00+09:00",
      "updatedAt": "2025-06-08T15:45:00+09:00"
    }
  }
}
```

#### 4.5.2 エラーレスポンス（400 Bad Request）
```json
{
  "status": "error",
  "error": {
    "code": "VALIDATION_ERROR",
    "message": "入力データに不正な値が含まれています",
    "details": [
      {
        "field": "regulationStartTime",
        "message": "規定勤務開始時刻は終了時刻より前に設定してください"
      }
    ]
  }
}
```

#### 4.5.3 データ未存在レスポンス（404 Not Found）
```json
{
  "status": "error",
  "error": {
    "code": "COMPANY_NOT_FOUND",
    "message": "指定された勤怠情報提出先が見つかりません"
  }
}
```

#### 4.5.4 楽観的ロックエラー（409 Conflict）
```json
{
  "status": "error",
  "error": {
    "code": "OPTIMISTIC_LOCK_ERROR",
    "message": "データが他のユーザーによって更新されています。最新データを取得して再度実行してください"
  }
}
```

### 4.6 HTTPステータスコード

| ステータスコード | 説明 |
|---------------|-----|
| 200 OK | 更新が正常に完了した |
| 400 Bad Request | リクエストパラメータに不正な値が含まれている |
| 401 Unauthorized | 認証が必要、または認証に失敗した |
| 403 Forbidden | リクエストしたリソースへのアクセス権限がない |
| 404 Not Found | 指定されたリソースが見つからない |
| 409 Conflict | 楽観的ロックエラーまたは重複データエラー |
| 500 Internal Server Error | サーバー内部エラー |

## 5. データ仕様

### 5.1 データモデル
```typescript
interface AttendanceDestination {
  id: string;                    // 提出先ID（必須）
  name: string;                  // 提出先名称（必須）
  type: 'internal' | 'external'; // 提出先種別（必須）
  settings: {
    // 内部提出先設定
    department?: {
      id: string;
      name: string;
    };
    // 外部提出先設定
    external?: {
      apiEndpoint: string;
      authMethod: 'token' | 'oauth';
      credentials: object;
    };
  };
  isActive: boolean;             // 有効/無効フラグ
  createdAt: Date;              // 作成日時
  updatedAt: Date;              // 更新日時
  version: number;              // バージョン番号
}
```

### 5.2 データベーススキーマ
```sql
-- 勤怠情報提出先テーブル
CREATE TABLE attendance_destinations (
  id VARCHAR(36) PRIMARY KEY,
  name VARCHAR(255) NOT NULL,
  type ENUM('internal', 'external') NOT NULL,
  settings JSON NOT NULL,
  is_active BOOLEAN DEFAULT TRUE,
  created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
  updated_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP,
  version INT DEFAULT 1,
  INDEX idx_type (type),
  INDEX idx_is_active (is_active)
);
```

### 5.3 バリデーション仕様
- **必須項目**: id, name, type
- **文字数制限**: name（1-255文字）
- **型制約**: type（'internal' | 'external'）
- **settingsバリデーション**: typeに応じた構造検証
- **一意性制約**: name（同一ユーザー内で重複不可）

## 6. 業務ロジック

### 6.1 更新処理フロー
1. **リクエスト受信・認証**
   - ユーザー認証・認可確認
   - リクエストパラメータ検証

2. **既存データ取得・検証**
   - 提出先IDによる既存レコード取得
   - 所有者権限確認
   - レコード存在確認

3. **データ更新処理**
   - 部分更新/全体更新の判定
   - バリデーション実行
   - バージョン管理（楽観ロック）

4. **データ永続化**
   - データベース更新実行
   - 更新日時・バージョン番号更新
   - トランザクション管理

### 6.2 部分更新ロジック
```typescript
// 部分更新処理
const updateFields = Object.keys(updateData);
const allowedFields = ['name', 'type', 'settings', 'isActive'];
const validFields = updateFields.filter(field => allowedFields.includes(field));

// 変更検出とマージ
const mergedData = { ...existingData, ...pick(updateData, validFields) };
```

### 6.3 バージョン管理ロジック
- **楽観ロック**: versionフィールドによる競合検出
- **更新時バージョンインクリメント**: 成功時にversion + 1
- **競合検出**: 更新時のversion不一致でエラー

## 7. セキュリティ・権限制御

### 7.1 認証・認可
- **JWT認証**: Bearer tokenによるユーザー認証
- **所有者権限**: 自身が作成した提出先のみ更新可能
- **管理者権限**: 全ての提出先更新可能（将来拡張）

### 7.2 データ保護
- **入力サニタイゼーション**: XSS対策
- **SQLインジェクション対策**: パラメータ化クエリ使用
- **機密情報保護**: credentials情報の暗号化保存

### 7.3 アクセス制御
```typescript
// 権限チェック関数
async function checkUpdatePermission(userId: string, destinationId: string): Promise<boolean> {
  const destination = await getDestinationById(destinationId);
  return destination?.ownerId === userId || isAdmin(userId);
}
```

### 7.4 監査ログ
- **更新操作ログ**: ユーザー、更新内容、タイムスタンプ
- **失敗ログ**: 認証失敗、権限不足、バリデーションエラー

## 8. エラーハンドリング・例外処理

### 8.1 エラー分類
| エラーコード | HTTPステータス | 説明 | 対応方法 |
|------------|---------------|------|---------|
| DEST_NOT_FOUND | 404 | 提出先が存在しない | IDを確認して再実行 |
| PERMISSION_DENIED | 403 | 更新権限なし | 所有者権限を確認 |
| VALIDATION_ERROR | 400 | バリデーションエラー | 入力データを修正 |
| VERSION_CONFLICT | 409 | バージョン競合 | 最新データ取得後再実行 |
| DUPLICATE_NAME | 409 | 名称重複 | 別の名称を指定 |

### 8.2 エラーレスポンス仕様
```json
{
  "error": {
    "code": "VALIDATION_ERROR",
    "message": "バリデーションエラーが発生しました",
    "details": [
      {
        "field": "name",
        "message": "名称は1文字以上255文字以下で入力してください"
      }
    ],
    "timestamp": "2024-12-07T10:30:00Z",
    "requestId": "req_123456789"
  }
}
```

### 8.3 例外処理フロー
1. **バリデーション例外**: 入力値チェック時
2. **権限例外**: 認可チェック時
3. **データ例外**: DB操作時（デッドロック、制約違反）
4. **システム例外**: 予期しないエラー

## 9. 非機能要件

### 9.1 パフォーマンス要件
- **レスポンス時間**: 平均200ms以下、最大1秒以内
- **スループット**: 100リクエスト/秒対応
- **同時接続数**: 1000接続まで対応

### 9.2 可用性要件
- **稼働率**: 99.9%以上
- **障害復旧時間**: 5分以内
- **データ整合性**: ACID特性保証

### 9.3 拡張性要件
- **ユーザー数**: 10万ユーザーまで対応
- **データ件数**: 100万件まで対応
- **水平スケーリング**: ロードバランサー対応

### 9.4 保守性要件
- **ログレベル**: DEBUG/INFO/WARN/ERROR
- **監視項目**: レスポンス時間、エラー率、リソース使用率
- **バックアップ**: 日次自動バックアップ

## 10. テスト仕様

### 10.1 単体テスト
```typescript
describe('勤怠情報提出先更新機能', () => {
  test('正常系: 部分更新', async () => {
    const updateData = { name: '新しい提出先名' };
    const result = await updateDestination('dest-123', updateData);
    expect(result.name).toBe('新しい提出先名');
  });

  test('異常系: 存在しない提出先', async () => {
    await expect(updateDestination('invalid-id', {}))
      .rejects.toThrow('DEST_NOT_FOUND');
  });
});
```

### 10.2 統合テスト
- **API統合テスト**: リクエスト〜レスポンスまでの全体フロー
- **データベース統合テスト**: トランザクション整合性確認
- **外部システム統合テスト**: 外部提出先連携確認

### 10.3 パフォーマンステスト
- **負荷テスト**: 想定負荷での動作確認
- **ストレステスト**: 限界負荷での動作確認
- **耐久テスト**: 長時間運転での安定性確認

### 10.4 セキュリティテスト
- **認証テスト**: 不正アクセス防止確認
- **権限テスト**: 適切な認可制御確認
- **入力値テスト**: SQLインジェクション・XSS対策確認

## 11. 実装ノート・技術的詳細

### 11.1 技術スタック
- **フレームワーク**: Express.js/Fastify
- **データベース**: MySQL 8.0
- **ORM**: Prisma/TypeORM
- **バリデーション**: Joi/Yup
- **認証**: JWT + bcrypt

### 11.2 データベース最適化
```sql
-- インデックス戦略
CREATE INDEX idx_user_destinations ON attendance_destinations(owner_id, is_active);
CREATE INDEX idx_updated_at ON attendance_destinations(updated_at);

-- パーティショニング（将来対応）
-- ALTER TABLE attendance_destinations PARTITION BY RANGE(YEAR(created_at));
```

### 11.3 キャッシュ戦略
- **Redis活用**: 頻繁にアクセスされる提出先データ
- **キャッシュキー**: `dest:${destinationId}`
- **TTL**: 1時間（更新時は即座に無効化）

### 11.4 ロギング実装
```typescript
const logger = createLogger({
  level: process.env.LOG_LEVEL || 'info',
  format: combine(timestamp(), json()),
  transports: [
    new transports.File({ filename: 'error.log', level: 'error' }),
    new transports.File({ filename: 'combined.log' })
  ]
});

// 更新操作ログ
logger.info('Destination updated', {
  userId,
  destinationId,
  updatedFields: Object.keys(updateData),
  timestamp: new Date().toISOString()
});
```

### 11.5 モニタリング
- **メトリクス収集**: Prometheus + Grafana
- **分散トレーシング**: Jaeger/Zipkin
- **アラート設定**: エラー率5%超過、レスポンス時間1秒超過

### 11.6 デプロイメント
- **コンテナ化**: Docker + Docker Compose
- **CI/CD**: GitHub Actions
- **ブルーグリーンデプロイ**: ダウンタイムなし更新
- **ヘルスチェック**: `/health`エンドポイント

---

## 変更履歴
| バージョン | 日付 | 変更者 | 変更内容 |
|----------|------|--------|---------|
| 1.0.0 | 2024-XX-XX | 開発チーム | 初版作成 |
| 2.0.0 | 2025-06-09 | システム | Level B標準構造適用、ドキュメント構造統一 |
