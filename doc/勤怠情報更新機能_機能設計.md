# 勤怠情報更新機能 機能設計

## 1. 機能概要

勤怠情報更新機能は、既存の月次勤怠情報を部分的または全体的に更新するためのAPIです。この機能は日毎の勤怠詳細の個別更新、複数日の一括更新、および自動再生成による全体更新をサポートします。勤怠情報の修正、追加、時間調整などの用途で使用されます。

## 2. API仕様

### 2.1 エンドポイント
```
PUT /api/v1/attendances/{attendanceId}
PATCH /api/v1/attendances/{attendanceId}
PATCH /api/v1/attendances/{attendanceId}/details/{detailId}
```

### 2.2 リクエスト形式

#### 2.2.1 全体更新リクエスト（PUT）
月次勤怠情報全体を新しいデータで置き換えます。
```json
{
  "year": 2025,
  "month": 6,
  "details": [
    {
      "date": "2025-06-01",
      "holiday": false,
      "leave": "",
      "startDateTime": "2025-06-01T09:00:00+09:00",
      "endDateTime": "2025-06-01T18:00:00+09:00",
      "restHour": "1.0",
      "workHour": "8.0",
      "overHour": "0.0",
      "note": "修正済み"
    }
  ]
}
```

#### 2.2.2 部分更新リクエスト（PATCH）
月次勤怠情報の一部を更新します。
```json
{
  "updateType": "partial",
  "details": [
    {
      "id": "550e8400-e29b-41d4-a716-446655440002",
      "date": "2025-06-01",
      "startDateTime": "2025-06-01T09:15:00+09:00",
      "endDateTime": "2025-06-01T18:30:00+09:00",
      "note": "時刻修正"
    },
    {
      "date": "2025-06-02",
      "holiday": false,
      "leave": "午前有給",
      "startDateTime": "2025-06-02T13:00:00+09:00",
      "endDateTime": "2025-06-02T18:00:00+09:00",
      "restHour": "0.0",
      "workHour": "5.0",
      "overHour": "0.0",
      "note": "午前有給追加"
    }
  ]
}
```

#### 2.2.3 自動再生成リクエスト（PATCH）
位置情報を基に勤怠情報を再生成します。
```json
{
  "updateType": "regenerate",
  "targetDates": ["2025-06-01", "2025-06-02", "2025-06-03"],
  "generateOptions": {
    "useLocationData": true,
    "fallbackToRegulation": true,
    "autoLeaveDetection": true
  }
}
```

#### 2.2.4 個別詳細更新リクエスト（PATCH detail）
特定の日の勤怠詳細のみを更新します。
```json
{
  "startDateTime": "2025-06-01T09:30:00+09:00",
  "endDateTime": "2025-06-01T18:15:00+09:00",
  "restHour": "1.0",
  "note": "個別修正"
}
```

### 2.3 リクエストパラメータ詳細

#### 2.3.1 共通パラメータ
| フィールド | 型 | 説明 | 必須 |
|---------|------|------|------|
| attendanceId | String (UUID) | 更新対象の勤怠情報ID（URLパス） | はい |
| detailId | String (UUID) | 更新対象の勤怠詳細ID（URLパス、個別更新時のみ） | 条件付き |

#### 2.3.2 部分更新パラメータ
| フィールド | 型 | 説明 | 必須 |
|---------|------|------|------|
| updateType | String | 更新タイプ（"partial", "regenerate"） | はい |
| details | Array | 更新する勤怠詳細（partial時） | 条件付き |
| targetDates | Array | 再生成対象日付（regenerate時） | 条件付き |
| generateOptions | Object | 自動生成オプション（regenerate時） | いいえ |

#### 2.3.3 勤怠詳細更新項目
| フィールド | 型 | 説明 | 更新可能 |
|---------|------|------|---------|
| id | String (UUID) | 勤怠詳細ID（既存レコード特定用） | 参照のみ |
| date | String | 日付（YYYY-MM-DD） | いいえ※1 |
| holiday | Boolean | 休日フラグ | はい |
| leave | String | 休暇種別 | はい |
| startDateTime | String | 勤怠開始時刻（ISO 8601） | はい |
| endDateTime | String | 勤怠終了時刻（ISO 8601） | はい |
| restHour | String | 休憩時間 | はい |
| workHour | String | 勤務時間 | はい※2 |
| overHour | String | 残業時間 | はい※2 |
| note | String | 備考 | はい |

**更新制限**：
- ※1 日付の変更は不可。別日のデータとして新規作成が必要
- ※2 workHour、overHourは手動指定も可能だが、通常は他の時刻項目から自動計算

### 2.4 レスポンス形式
```json
{
  "success": true,
  "attendance": {
    "id": "550e8400-e29b-41d4-a716-446655440000",
    "year": 2025,
    "month": 6,
    "userId": "550e8400-e29b-41d4-a716-446655441234",
    "details": [
      {
        "id": "550e8400-e29b-41d4-a716-446655440002",
        "date": "2025-06-01",
        "holiday": false,
        "leave": "",
        "startDateTime": "2025-06-01T09:30:00+09:00",
        "endDateTime": "2025-06-01T18:15:00+09:00",
        "restHour": "1.0",
        "workHour": "7.75",
        "overHour": "0.0",
        "note": "個別修正",
        "autoGenerated": false,
        "updatedAt": "2025-06-08T14:30:00+09:00"
      }
    ],
    "summary": {
      "totalWorkDays": "20",
      "totalPaidLeaveDays": "1",
      "totalCompensatoryDays": "0",
      "totalSpecialLeaveDays": "0",
      "totalWorkHours": "159.75",
      "totalOverHours": "2.5",
      "totalHolidayWorkHours": "0.0"
    },
    "updatedAt": "2025-06-08T14:30:00+09:00",
    "lastUpdateType": "partial"
  }
}
```

| フィールド | 型 | 説明 |
|---------|------|------|
| success | Boolean | 処理成功フラグ |
| attendance | Object | 更新後の勤怠情報オブジェクト |
| attendance.lastUpdateType | String | 最後の更新タイプ（"full", "partial", "regenerate"） |
| details[].updatedAt | String | 詳細レコードの最終更新日時 |

### 2.5 エラーレスポンス

#### 2.5.1 勤怠情報未存在エラー
```json
{
  "success": false,
  "error": {
    "code": "ATTENDANCE_NOT_FOUND",
    "message": "指定された勤怠情報が見つかりません",
    "details": "attendanceId: 550e8400-e29b-41d4-a716-446655440000"
  }
}
```

#### 2.5.2 勤怠詳細未存在エラー
```json
{
  "success": false,
  "error": {
    "code": "ATTENDANCE_DETAIL_NOT_FOUND",
    "message": "指定された勤怠詳細が見つかりません",
    "details": "detailId: 550e8400-e29b-41d4-a716-446655440002"
  }
}
```

#### 2.5.3 不正な更新データエラー
```json
{
  "success": false,
  "error": {
    "code": "INVALID_UPDATE_DATA",
    "message": "更新データに不正な値が含まれています",
    "details": [
      {
        "field": "details[0].startDateTime",
        "message": "終了時刻より後の時刻は指定できません"
      },
      {
        "field": "details[1].date",
        "message": "日付の変更はサポートされていません"
      }
    ]
  }
}
```

#### 2.5.4 権限不足エラー
```json
{
  "success": false,
  "error": {
    "code": "UPDATE_PERMISSION_DENIED",
    "message": "この勤怠情報を更新する権限がありません",
    "details": "自分の勤怠情報のみ更新可能です"
  }
}
```

#### 2.5.5 確定済み勤怠情報更新エラー
```json
{
  "success": false,
  "error": {
    "code": "ATTENDANCE_ALREADY_SUBMITTED",
    "message": "提出済みの勤怠情報は更新できません",
    "details": "提出を取り消してから更新してください"
  }
}
```

## 3. 機能詳細

### 3.1 全体更新（PUT）
- 既存の勤怠情報を完全に新しいデータで置き換え
- 指定されていない日の詳細は削除される
- サマリ情報は新しい詳細から再計算
- 楽観的ロックによる競合回避

#### 3.1.1 全体更新の処理フロー
```javascript
function updateAttendanceFull(attendanceId, newData) {
  // 1. 既存データの存在確認と権限チェック
  const existingAttendance = getAttendanceById(attendanceId);
  validateUpdatePermission(existingAttendance);
  
  // 2. 提出済みステータスの確認
  if (existingAttendance.status === 'submitted') {
    throw new Error('ATTENDANCE_ALREADY_SUBMITTED');
  }
  
  // 3. 新しいデータのバリデーション
  validateAttendanceData(newData);
  
  // 4. トランザクション内で更新実行
  return executeTransaction(() => {
    // 既存の詳細をすべて削除
    deleteAttendanceDetails(attendanceId);
    
    // 新しい詳細を挿入
    const newDetails = insertAttendanceDetails(attendanceId, newData.details);
    
    // サマリを再計算
    const summary = calculateSummary(newDetails);
    
    // 勤怠情報のメタデータを更新
    updateAttendanceMetadata(attendanceId, {
      summary: summary,
      updatedAt: new Date(),
      lastUpdateType: 'full'
    });
    
    return getAttendanceById(attendanceId);
  });
}
```

### 3.2 部分更新（PATCH）
- 指定された日の詳細のみを更新
- 未指定の詳細は既存のまま保持
- サマリ情報は変更された詳細を反映して再計算
- 新しい日の詳細も追加可能

#### 3.2.1 部分更新の処理フロー
```javascript
function updateAttendancePartial(attendanceId, updateData) {
  // 1. 既存データの取得と権限チェック
  const existingAttendance = getAttendanceById(attendanceId);
  validateUpdatePermission(existingAttendance);
  
  // 2. 更新データのバリデーション
  validatePartialUpdateData(updateData);
  
  // 3. 更新対象の詳細を特定
  const updatedDetails = [];
  for (const detailUpdate of updateData.details) {
    if (detailUpdate.id) {
      // 既存詳細の更新
      const existingDetail = getAttendanceDetailById(detailUpdate.id);
      const updatedDetail = mergeDetailData(existingDetail, detailUpdate);
      updatedDetails.push(updateAttendanceDetail(updatedDetail));
    } else if (detailUpdate.date) {
      // 新規詳細の追加
      const newDetail = createAttendanceDetail(attendanceId, detailUpdate);
      updatedDetails.push(newDetail);
    }
  }
  
  // 4. サマリの再計算
  const allDetails = getAllAttendanceDetails(attendanceId);
  const summary = calculateSummary(allDetails);
  
  // 5. メタデータの更新
  updateAttendanceMetadata(attendanceId, {
    summary: summary,
    updatedAt: new Date(),
    lastUpdateType: 'partial'
  });
  
  return getAttendanceById(attendanceId);
}
```

### 3.3 自動再生成更新
- 指定された日の詳細を位置情報から再生成
- 既存の手動修正データは上書きされる（警告表示）
- 位置情報が不足している場合は規定時間やエラーで対応

#### 3.3.1 自動再生成の処理フロー
```javascript
function updateAttendanceRegenerate(attendanceId, regenerateData) {
  // 1. 既存データの取得と権限チェック
  const existingAttendance = getAttendanceById(attendanceId);
  validateUpdatePermission(existingAttendance);
  
  // 2. 対象日付のバリデーション
  validateTargetDates(regenerateData.targetDates, existingAttendance);
  
  // 3. ユーザー設定の取得
  const userSettings = getUserAttendanceSetting(existingAttendance.userId);
  
  // 4. 各対象日について再生成実行
  const regeneratedDetails = [];
  for (const targetDate of regenerateData.targetDates) {
    // 位置情報の取得
    const locationData = getLocationDataByDate(
      existingAttendance.userId, 
      targetDate
    );
    
    // 勤怠詳細の自動生成
    const newDetail = generateDailyAttendance(
      new Date(targetDate),
      locationData,
      userSettings,
      regenerateData.generateOptions
    );
    
    // 既存詳細の更新または新規作成
    const existingDetail = findDetailByDate(existingAttendance.details, targetDate);
    if (existingDetail) {
      regeneratedDetails.push(updateAttendanceDetail({
        ...existingDetail,
        ...newDetail,
        autoGenerated: true,
        updatedAt: new Date()
      }));
    } else {
      regeneratedDetails.push(createAttendanceDetail(attendanceId, {
        ...newDetail,
        autoGenerated: true
      }));
    }
  }
  
  // 5. サマリの再計算とメタデータ更新
  const allDetails = getAllAttendanceDetails(attendanceId);
  const summary = calculateSummary(allDetails);
  
  updateAttendanceMetadata(attendanceId, {
    summary: summary,
    updatedAt: new Date(),
    lastUpdateType: 'regenerate'
  });
  
  return getAttendanceById(attendanceId);
}
```

### 3.4 個別詳細更新
- 特定の日の勤怠詳細のみを対象とした更新
- 最も軽量で高速な更新方法
- 時刻修正や備考追加などの用途

### 3.5 データ整合性の保証
- 楽観的ロック機能による同時更新の競合回避
- 時刻の論理的整合性チェック（開始時刻 < 終了時刻）
- 勤務時間の自動再計算と妥当性検証
- サマリ情報の自動更新

## 4. セキュリティ要件

### 4.1 アクセス制御
- **本人のみ更新可能**: ユーザーは自分の勤怠情報のみ更新可能
- **管理者権限**: システム管理者は全ユーザーの勤怠情報を更新可能
- **JWT認証**: 全てのAPIリクエストでJWT認証が必須

### 4.2 データ保護
- **提出済み勤怠の保護**: 提出済みの勤怠情報は更新不可
- **監査ログ**: 更新操作の完全な監査ログを記録
- **データバックアップ**: 更新前のデータのバックアップを自動保存

## 5. パフォーマンス要件

### 5.1 応答時間
- **個別詳細更新**: 200ms以内
- **部分更新（5日以内）**: 500ms以内
- **全体更新**: 1秒以内
- **自動再生成**: 2秒以内

### 5.2 同時処理
- **同時更新リクエスト**: ユーザーあたり最大3リクエスト/秒
- **楽観的ロック**: 競合発生時の適切なエラーレスポンス
- **トランザクション処理**: ACID特性の保証

## 6. エラーハンドリング

### 6.1 主要エラーケース
| エラーコード | HTTPステータス | 説明 | 対応方法 |
|------------|---------------|-----|---------|
| ATTENDANCE_NOT_FOUND | 404 | 対象の勤怠情報が存在しない | 正しいattendanceIdを指定 |
| ATTENDANCE_DETAIL_NOT_FOUND | 404 | 対象の勤怠詳細が存在しない | 正しいdetailIdを指定 |
| INVALID_UPDATE_DATA | 400 | 更新データの形式や値が不正 | 正しいデータ形式で再送信 |
| UPDATE_PERMISSION_DENIED | 403 | 更新権限なし | 本人の勤怠情報か確認 |
| ATTENDANCE_ALREADY_SUBMITTED | 409 | 提出済み勤怠情報の更新 | 提出取り消し後に更新 |
| OPTIMISTIC_LOCK_ERROR | 409 | 楽観的ロック競合 | 最新データを取得して再試行 |
| INSUFFICIENT_LOCATION_DATA | 422 | 再生成に必要な位置情報不足 | 手動更新または位置情報追加 |

## 7. テスト方針

### 7.1 単体テスト
- 各更新タイプの正常系・異常系テスト
- データバリデーション機能のテスト
- 権限チェック機能のテスト
- サマリ再計算機能のテスト

### 7.2 統合テスト
- 複数ユーザーでの同時更新テスト
- 楽観的ロック機能のテスト
- データ整合性の保証テスト
- 監査ログ記録のテスト

### 7.3 パフォーマンステスト
- 大量データでの更新性能テスト
- 同時リクエスト処理能力のテスト
- レスポンス時間の測定

## 8. 依存関係

### 8.1 システム内依存
- **勤怠情報登録機能**：勤怠情報の基本構造とバリデーション
- **勤怠情報取得機能**：既存データの参照
- **位置情報登録機能**：自動再生成時の位置情報参照
- **ユーザー勤怠設定参照仕様**：UserAttendanceSettingモデルからの設定情報取得
  - 詳細仕様：`ユーザー勤怠設定参照仕様_機能設計.md`参照
  - 参照項目：regulationStartTime, regulationEndTime, regulationWorkHours等
  - 使用場面：自動再生成更新時の規定時間取得

### 8.2 外部依存
- 祝日マスタAPI：休日判定（再生成時）
- タイムゾーン管理ライブラリ：時刻計算
- 日付処理ライブラリ：カレンダー計算

---

## 変更履歴
| 日付 | 変更者 | 変更内容 |
|-----|-------|---------|
| 2025/06/08 | カーン | 初版作成 - 勤怠情報更新機能の詳細設計 |

※このドキュメントは開発の進行に合わせて随時更新されます。
