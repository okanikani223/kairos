# 位置情報登録機能 機能設計

## 1. 機能概要

位置情報登録機能は、ユーザーの現在地をシステムに記録するためのAPIです。この機能により、勤怠情報の自動作成のための基礎データが提供されます。位置情報はスマートフォンやPCなどのデバイスから定期的に送信され、サーバーに保存されます。

## 2. API仕様

### 2.1 エンドポイント
```
POST /api/v1/locations
```

### 2.2 リクエスト形式
```json
{
  "latitude": "35.681236",
  "longitude": "139.767125",
  "accuracy": 15.0
}
```

| フィールド | 型 | 説明 | 必須 |
|---------|------|------|------|
| latitude | String | 緯度情報 | はい |
| longitude | String | 経度情報 | はい |
| accuracy | Number | 位置精度（メートル） | いいえ |

### 2.3 レスポンス形式
```json
{
  "success": true,
  "locationId": "550e8400-e29b-41d4-a716-446655440000",
  "recordedAt": "2025-06-01T09:00:00+09:00"
}
```

| フィールド | 型 | 説明 |
|---------|------|------|
| success | Boolean | 処理成功フラグ |
| locationId | String (UUID) | 作成された位置情報のID |
| recordedAt | String (ISO8601) | サーバー側で記録した時間 |

### 2.4 エラーレスポンス
```json
{
  "success": false,
  "error": {
    "code": "INVALID_LOCATION",
    "message": "位置情報が不正です"
  }
}
```

## 3. 機能詳細

### 3.1 位置情報の検証
- 緯度・経度の値が有効な範囲内か確認（緯度: -90〜90、経度: -180〜180）
- 精度が一定の閾値以下であるか確認（例：精度が100m以上の場合は警告または情報として記録）

### 3.2 位置情報の保存と記録
- 受け取った位置情報をデータベースに保存
- サーバー側でタイムスタンプを付与
- 関連するユーザーIDと紐付け（認証情報から取得）
- 位置情報を時系列で保存し、後続の勤務情報取得時に利用可能な状態に保持する
- 保存された位置情報は、勤怠情報取得時に日毎の勤怠開始時刻と勤怠終了時刻を算出するために使用される

## 4. 機能特有の非機能要件

### 4.1 位置情報特有のセキュリティ要件
- 位置情報データの保持期間制限: 90日間
- 位置情報のアクセス権限管理: 本人と管理者のみアクセス可能

### 4.2 位置情報特有のプライバシー要件
- 位置情報取得時のユーザー同意取得
- 業務時間外の位置情報収集制限機能

## 5. 技術的実装詳細

### 5.1 距離計算アルゴリズム
Haversine公式を使用して地球上の2点間の距離を計算（勤怠情報作成処理で使用）

```javascript
function calculateDistance(lat1, lon1, lat2, lon2) {
  const R = 6371e3; // 地球の半径（メートル）
  const φ1 = lat1 * Math.PI/180;
  const φ2 = lat2 * Math.PI/180;
  const Δφ = (lat2-lat1) * Math.PI/180;
  const Δλ = (lon2-lon1) * Math.PI/180;

  const a = Math.sin(Δφ/2) * Math.sin(Δφ/2) +
          Math.cos(φ1) * Math.cos(φ2) *
          Math.sin(Δλ/2) * Math.sin(Δλ/2);
  const c = 2 * Math.atan2(Math.sqrt(a), Math.sqrt(1-a));

  return R * c; // メートル単位の距離
}
```

### 5.2 データ連携仕様
- 位置情報の登録頻度はクライアント側で調整可能に設計
- 保存した位置情報は勤怠情報取得APIから参照可能とする

## 6. 拡張性考慮事項

### 6.1 将来的な拡張可能性
- 位置情報の履歴表示機能
- 位置情報の精度向上のため、Wi-Fi、携帯電話基地局情報等の併用
- 複数デバイスからの情報統合機能

### 6.2 制限事項
- GPS信号が取得できない環境（地下など）での動作制限
- バッテリー消費を考慮した最適な位置情報取得頻度の設定必要性

## 7. テスト方針
- 単体テスト: 位置情報の検証ロジックのテスト
- API統合テスト: リクエスト/レスポンスの整合性確認
- 負荷テスト: 同時多数リクエスト時の挙動確認
