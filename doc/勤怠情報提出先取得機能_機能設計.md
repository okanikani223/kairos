# 勤怠情報提出先取得機能 機能設計

## 1. 機能概要

勤怠情報提出先取得機能は、登録済みの勤怠情報提出先（会社・組織）の情報を取得するためのAPIです。この機能では、ユーザーが登録した全ての提出先の一覧表示と、特定の提出先の詳細情報取得をサポートします。

## 2. API仕様

### 2.1 エンドポイント

#### 2.1.1 提出先一覧取得
```
GET /api/v1/companies
```

#### 2.1.2 提出先詳細取得
```
GET /api/v1/companies/{companyId}
```

### 2.2 リクエスト形式

#### 2.2.1 一覧取得リクエスト
```
GET /api/v1/companies?status=active&page=1&limit=10
```

#### 2.2.2 詳細取得リクエスト
```
GET /api/v1/companies/12345678-1234-1234-1234-123456789abc
```

### 2.3 クエリパラメータ（一覧取得）

| パラメータ名 | 型 | 必須 | デフォルト値 | 説明 |
|------------|---|-----|------------|-----|
| status | String | × | active | 取得対象のステータス（active/inactive/all） |
| page | Number | × | 1 | ページ番号（1以上） |
| limit | Number | × | 10 | 1ページあたりの取得件数（1～100） |
| sortBy | String | × | companyName | ソート基準（companyName/createdAt/updatedAt） |
| order | String | × | asc | ソート順序（asc/desc） |

### 2.4 レスポンス形式

#### 2.4.1 一覧取得成功レスポンス（200 OK）
```json
{
  "status": "success",
  "data": {
    "companies": [
      {
        "id": "12345678-1234-1234-1234-123456789abc",
        "companyName": "株式会社サンプル",
        "location": {
          "latitude": "35.6762",
          "longitude": "139.6503"
        },
        "regulationStartTime": "09:00",
        "regulationEndTime": "18:00",
        "regulationRestStartTime": "12:00",
        "regulationRestEndTime": "13:00",
        "affiliationStartDate": "2025-01-01",
        "affiliationEndDate": null,
        "createdAt": "2025-06-08T10:30:00+09:00",
        "updatedAt": "2025-06-08T10:30:00+09:00"
      }
    ],
    "pagination": {
      "currentPage": 1,
      "totalPages": 3,
      "totalCount": 25,
      "hasNext": true,
      "hasPrev": false
    }
  }
}
```

#### 2.4.2 詳細取得成功レスポンス（200 OK）
```json
{
  "status": "success",
  "data": {
    "company": {
      "id": "12345678-1234-1234-1234-123456789abc",
      "companyName": "株式会社サンプル",
      "location": {
        "latitude": "35.6762",
        "longitude": "139.6503"
      },
      "regulationStartTime": "09:00",
      "regulationEndTime": "18:00",
      "regulationRestStartTime": "12:00",
      "regulationRestEndTime": "13:00",
      "affiliationStartDate": "2025-01-01",
      "affiliationEndDate": null,
      "createdAt": "2025-06-08T10:30:00+09:00",
      "updatedAt": "2025-06-08T10:30:00+09:00"
    }
  }
}
```

#### 2.4.3 データ未存在レスポンス（404 Not Found）
```json
{
  "status": "error",
  "error": {
    "code": "COMPANY_NOT_FOUND",
    "message": "指定された勤怠情報提出先が見つかりません"
  }
}
```

#### 2.4.4 エラーレスポンス（400 Bad Request）
```json
{
  "status": "error",
  "error": {
    "code": "VALIDATION_ERROR",
    "message": "クエリパラメータに不正な値が含まれています",
    "details": [
      {
        "field": "limit",
        "message": "limitは1から100の間で指定してください"
      }
    ]
  }
}
```

### 2.5 HTTPステータスコード

| ステータスコード | 説明 |
|---------------|-----|
| 200 OK | データの取得が正常に完了した |
| 400 Bad Request | クエリパラメータに不正な値が含まれている |
| 401 Unauthorized | 認証が必要、または認証に失敗した |
| 403 Forbidden | リクエストしたリソースへのアクセス権限がない |
| 404 Not Found | 指定されたリソースが見つからない |
| 500 Internal Server Error | サーバー内部エラー |

## 3. 機能詳細

### 3.1 一覧取得処理

#### 3.1.1 クエリパラメータ検証
```typescript
const validateListParams = (params: ListParams) => {
  const errors: ValidationError[] = [];
  
  if (params.page && (params.page < 1 || !Number.isInteger(params.page))) {
    errors.push({
      field: 'page',
      message: 'pageは1以上の整数で指定してください'
    });
  }
  
  if (params.limit && (params.limit < 1 || params.limit > 100)) {
    errors.push({
      field: 'limit',
      message: 'limitは1から100の間で指定してください'
    });
  }
  
  return errors;
};
```

#### 3.1.2 データ取得とページネーション
```typescript
const getCompaniesList = async (userId: string, params: ListParams) => {
  const offset = (params.page - 1) * params.limit;
  
  const [companies, totalCount] = await Promise.all([
    CompanyRepository.findByUserId(userId, {
      status: params.status,
      offset,
      limit: params.limit,
      sortBy: params.sortBy,
      order: params.order
    }),
    CompanyRepository.countByUserId(userId, { status: params.status })
  ]);
  
  const totalPages = Math.ceil(totalCount / params.limit);
  
  return {
    companies,
    pagination: {
      currentPage: params.page,
      totalPages,
      totalCount,
      hasNext: params.page < totalPages,
      hasPrev: params.page > 1
    }
  };
};
```

### 3.2 詳細取得処理

#### 3.2.1 パスパラメータ検証
```typescript
const validateCompanyId = (companyId: string) => {
  const uuidRegex = /^[0-9a-f]{8}-[0-9a-f]{4}-[1-5][0-9a-f]{3}-[89ab][0-9a-f]{3}-[0-9a-f]{12}$/i;
  
  if (!uuidRegex.test(companyId)) {
    throw new ValidationError('companyIdは有効なUUID形式で指定してください');
  }
};
```

#### 3.2.2 データ取得と権限確認
```typescript
const getCompanyDetail = async (userId: string, companyId: string) => {
  validateCompanyId(companyId);
  
  const company = await CompanyRepository.findByIdAndUserId(companyId, userId);
  
  if (!company) {
    throw new NotFoundError('指定された勤怠情報提出先が見つかりません');
  }
  
  return company;
};
```

## 4. セキュリティ要件

### 4.1 共通セキュリティ基盤
本機能のセキュリティ要件は「セキュリティ要件記載標準 3節」に従い、以下の共通基盤を適用します：
- JWT認証による本人確認
- HTTPS通信の必須化
- CORS設定による適切なオリジン制御
- レート制限によるAPI保護
- 監査ログの記録

### 4.2 機能固有セキュリティ要件

#### 4.2.1 アクセス制御
- **所有者ベースアクセス制御**: ユーザーは自身が登録した提出先のみ取得可能
- **データフィルタリング**: 論理削除されたデータは結果に含めない

#### 4.2.2 データ保護
- **位置情報の適切な取り扱い**: 提出先の位置情報は認証されたユーザーのみアクセス可能
- **アクセスログ記録**: セキュリティ監査対応のための詳細なアクセスログ記録

## 5. パフォーマンス要件

### 5.1 応答時間
- **一覧取得**: 500ms以内
- **詳細取得**: 300ms以内

### 5.2 データベースクエリ最適化
- **インデックス活用**: userId、status、createdAtにインデックス設定
- **クエリ最適化**: N+1問題の回避、適切なJOIN使用

### 5.3 キャッシュ戦略
- **メモリキャッシュ**: 頻繁にアクセスされるデータのキャッシュ
- **TTL設定**: 5分間のキャッシュ有効期限

## 6. エラーハンドリング

### 6.1 パラメータ検証エラー
```typescript
const handleValidationError = (errors: ValidationError[]) => {
  return {
    status: 'error',
    error: {
      code: 'VALIDATION_ERROR',
      message: 'クエリパラメータに不正な値が含まれています',
      details: errors
    }
  };
};
```

### 6.2 データ不存在エラー
```typescript
const handleNotFoundError = () => {
  return {
    status: 'error',
    error: {
      code: 'COMPANY_NOT_FOUND',
      message: '指定された勤怠情報提出先が見つかりません'
    }
  };
};
```

## 7. テスト方針

### 7.1 単体テスト
- **パラメータ検証**: クエリパラメータの境界値テスト
- **データ取得ロジック**: 正常系・異常系のテストケース
- **ページネーション**: ページ計算ロジックの検証

### 7.2 統合テスト
- **API エンドポイント**: 一覧・詳細取得の統合テスト
- **認証・認可**: 権限制御の確認
- **データベース**: データ整合性の確認

### 7.3 パフォーマンステスト
- **負荷テスト**: 大量データでの応答時間確認
- **同時アクセス**: 複数ユーザーの同時取得処理

## 8. 依存関係

### 8.1 システム内依存
- **認証サービス**: JWT認証による本人確認
- **ユーザー管理サービス**: ユーザー情報の参照
- **データベース**: Company テーブルからのデータ取得

### 8.2 外部依存
- **キャッシュサービス**: Redis等によるパフォーマンス向上
- **ログ集約サービス**: アクセスログの収集・分析

## 9. 変更履歴

| 日付 | 変更者 | 変更内容 |
|-----|-------|---------|
| 2025/06/08 | カーン | 初版作成 |
