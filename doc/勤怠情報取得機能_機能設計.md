# 勤怠情報取得機能 機能設計

## 1. 機能概要

勤怠情報取得機能は、指定した年月の勤怠情報をシステムから取得するためのAPIです。この機能により、ユーザーは過去の勤怠記録を確認したり、提出用のデータを取得したりすることができます。勤怠情報が存在しない場合は、404エラーを返します。勤怠情報の自動作成は「自動勤怠情報作成機能」として別途提供されます。

## 2. API仕様

### 2.1 エンドポイント
```
GET /api/v1/attendances
GET /api/v1/attendances/{year}
GET /api/v1/attendances/{year}/{month}
```

### 2.2 リクエストパラメータ
| パラメータ名 | 型 | 説明 | 必須 | 例 |
|-----------|------|------|------|-----|
| year | Number | 取得対象の年 | いいえ | 2025 |
| month | String | 取得対象の月（2桁、0埋め） | いいえ | 06 |

### 2.3 レスポンス形式
```json
{
  "success": true,
  "attendances": [
    {
      "id": "550e8400-e29b-41d4-a716-446655440000",
      "year": 2025,
      "month": 6,
      "userId": "550e8400-e29b-41d4-a716-446655441234",
      "details": [
      {
        "id": "550e8400-e29b-41d4-a716-446655440002",
        "date": "2025-06-01",
        "holiday": false,
        "leave": "",
        "startDateTime": "2025-06-01T09:00:00+09:00",
        "endDateTime": "2025-06-01T18:00:00+09:00",
        "restHour": "1.0",
        "workHour": "8.0",
        "overHour": "0.0",
        "note": ""
      },
      // 以下、月内の日数分の勤怠詳細が続く
    ],
    "summary": {
      "totalWorkDays": "20",
      "totalPaidLeaveDays": "1",
      "totalCompensatoryDays": "0",
      "totalSpecialLeaveDays": "0",
      "totalWorkHours": "160.0",
      "totalOverHours": "2.5",
      "totalHolidayWorkHours": "0.0"
    },
    "created": false
    }
    // 年月指定がない場合は複数の年月の勤怠情報が含まれる
  ]
}
```

| フィールド | 型 | 説明 |
|---------|------|------|
| success | Boolean | 処理成功フラグ |
| attendances | Array | 勤怠情報オブジェクトの配列 |
| attendances[].id | String (UUID) | 勤怠情報ID |
| attendances[].year | Number | 対象年 |
| attendances[].month | Number | 対象月 |
| attendances[].userId | String (UUID) | ユーザーID |
| attendances[].details | Array | 日毎の勤怠詳細の配列 |
| attendances[].summary | Object | 勤怠情報のサマリ |
| attendances[].created | Boolean | 新規作成されたかどうか（true: 自動作成された、false: 既存データ） |

### 2.4 エラーレスポンス
```json
{
  "success": false,
  "error": {
    "code": "UNAUTHORIZED_ACCESS",
    "message": "この勤怠情報へのアクセス権限がありません"
  }
}
```

## 3. 機能詳細

### 3.1 勤怠情報の取得
- 年月の指定に基づいて、以下のルールで勤怠情報をデータベースから検索:
  - 年月の指定がない場合: ユーザーの全ての作成済み勤怠情報を取得
  - 年のみ指定の場合: 指定された年の全ての月の作成済み勤怠情報を取得
  - 年月の指定がある場合: 指定された年月の勤怠情報のみを取得
- 勤怠情報が存在する場合は、その情報を返却
- 勤怠情報が存在しない場合は、404 Not Foundエラーを返却

### 3.3 勤怠情報のサマリ計算
- 日毎の勤怠情報から月次のサマリ情報を計算
  - 総勤務日数
  - 総有給休暇日数
  - 総代休日数
  - 総特別休暇日数
  - 総勤務時間
  - 総残業時間
  - 総休日出勤時間

## 4. 機能特有の非機能要件

### 4.1 勤怠情報特有のセキュリティ要件
- 勤怠情報の閲覧・編集権限管理：本人、管理者、および権限を付与された者のみアクセス可能
- 勤怠情報のバージョン管理：編集履歴を保持

### 4.2 エラー処理に関する要件
- 勤怠情報が存在しない場合は、HTTPステータスコード404と適切なエラーメッセージを返却する
- 複数年月のデータ取得時、一部の年月のデータが存在しない場合は、存在するデータのみを返却する

## 5. 技術的実装詳細

### 5.1 勤務判定アルゴリズム
位置情報データから勤務時間を判定するアルゴリズム概要：

```javascript
function determineWorkingHours(locationData, workplaceLocation, userSettings) {
  // 1. 位置情報をタイムスタンプでソート
  const sortedLocations = sortByTimestamp(locationData);
  
  // 2. 規定勤務地近辺（100m以内）にいる時間帯を特定
  const proximityPeriods = identifyProximityPeriods(sortedLocations, workplaceLocation, 100);
  
  // 3. 位置情報に基づいて勤務開始・終了時刻を決定
  // 位置情報がない場合は、ユーザー設定の規定時間をデフォルト値として使用
  const workingHours = determineWorkHoursFromProximity(proximityPeriods, userSettings.regulationHours);
  
  return workingHours;
}
```

### 5.2 休暇判定ロジック
- 勤務開始・終了記録がない平日は未入力と判定
- 祝日・休日マスタと照合し、休日判定
- 休暇種別は自動判定を行う：
  - 規定休憩開始時刻までに勤務開始していない場合は自動的に午前有給と判定
  - 規定休憩終了時刻以前に勤怠終了している場合は自動的に午後有給と判定
  - 有給や代休の残日数を参照して消費する休暇種別を決定

## 6. 拡張性考慮事項

### 6.1 将来的な拡張可能性
- カレンダー情報との連携による休暇予定の自動反映
- 複数の規定勤務地に対応した勤怠判定ロジックの拡張

### 6.2 制限事項
- 複数の規定勤務地を短時間で移動する場合の判定精度に限界がある
- 在宅勤務など規定勤務地以外での勤務は自動判定が困難

## 7. テスト方針
- 単体テスト: 勤怠時間判定ロジックのテスト
- API統合テスト: リクエスト/レスポンスの整合性確認
- ケーステスト: 様々な勤務パターンでの自動判定精度の検証
- データ欠損テスト: 位置情報が部分的に欠損している場合の挙動確認
