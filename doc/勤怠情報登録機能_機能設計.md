# 勤怠情報登録機能 機能設計

## 1. 機能概要

勤怠情報登録機能は、月次の勤怠情報をシステムに新規作成・登録するためのAPIです。この機能は手動での勤怠情報作成と、位置情報を基にした自動勤怠情報作成の両方をサポートします。自動生成フラグによって処理方式を切り替え、位置情報から勤務時間を自動算出する機能も含みます。

## 2. API仕様

### 2.1 エンドポイント
```
POST /api/v1/attendances
```

### 2.2 リクエスト形式

#### 2.2.1 手動作成リクエスト
```json
{
  "year": 2025,
  "month": 6,
  "autoGenerate": false,
  "details": [
    {
      "date": "2025-06-01",
      "holiday": false,
      "leave": "",
      "startDateTime": "2025-06-01T09:00:00+09:00",
      "endDateTime": "2025-06-01T18:00:00+09:00",
      "restHour": "1.0",
      "workHour": "8.0",
      "overHour": "0.0",
      "note": ""
    }
  ]
}
```

#### 2.2.2 自動生成リクエスト
```json
{
  "year": 2025,
  "month": 6,
  "autoGenerate": true,
  "generateOptions": {
    "useLocationData": true,
    "fallbackToRegulation": true,
    "autoLeaveDetection": true
  }
}
```

**generateOptions省略時のリクエスト例**：
```json
{
  "year": 2025,
  "month": 6,
  "autoGenerate": true
}
```
この場合、システムは`generateOptions`を`{"useLocationData": true, "fallbackToRegulation": true, "autoLeaveDetection": true}`として補完します。

| フィールド | 型 | 説明 | 必須 |
|---------|------|------|------|
| year | Number | 対象年 | はい |
| month | Number | 対象月 | はい |
| autoGenerate | Boolean | 自動生成フラグ（true: 自動生成, false: 手動） | はい |
| details | Array | 日毎の勤怠詳細（手動作成時のみ） | 条件付き※1 |
| generateOptions | Object | 自動生成オプション（自動生成時のみ） | 条件付き※2 |

**条件付き必須フィールドの詳細**：
- ※1 `autoGenerate: false`の場合は必須。空配列やnullは不可
- ※2 `autoGenerate: true`の場合は任意（省略時はデフォルト値を使用）

#### 2.2.3 自動生成オプション詳細
| フィールド | 型 | 説明 | デフォルト |
|---------|------|------|---------|
| useLocationData | Boolean | 位置情報を勤務判定に使用する | true |
| fallbackToRegulation | Boolean | 位置情報がない場合に規定時間を使用する | true |
| autoLeaveDetection | Boolean | 自動的な休暇判定を行う | true |

**generateOptionsが省略された場合の動作**：
- `autoGenerate: true`でリクエストの`generateOptions`が未指定または`null`の場合、システムは上記のデフォルト値でオプションを補完します
- つまり、`{"useLocationData": true, "fallbackToRegulation": true, "autoLeaveDetection": true}`として処理されます
- これにより、APIエラーは発生せず、位置情報を最大限活用する標準的な自動生成処理が実行されます

**useLocationDataオプションの詳細挙動**：
- `true`: 位置情報を基に勤務開始・終了時刻を自動判定
- `false`: 位置情報を使用せず、規定時間またはデフォルト値で勤怠情報を作成
  - `fallbackToRegulation: true`の場合：規定勤怠開始・終了時刻を使用
  - `fallbackToRegulation: false`の場合：勤務なし（欠勤）として処理

### 2.3 レスポンス形式
```json
{
  "success": true,
  "attendance": {
    "id": "550e8400-e29b-41d4-a716-446655440000",
    "year": 2025,
    "month": 6,
    "userId": "550e8400-e29b-41d4-a716-446655441234",
    "details": [
      {
        "id": "550e8400-e29b-41d4-a716-446655440002",
        "date": "2025-06-01",
        "holiday": false,
        "leave": "",
        "startDateTime": "2025-06-01T09:00:00+09:00",
        "endDateTime": "2025-06-01T18:00:00+09:00",
        "restHour": "1.0",
        "workHour": "8.0",
        "overHour": "0.0",
        "note": "",
        "autoGenerated": true
      }
    ],
    "summary": {
      "totalWorkDays": "20",
      "totalPaidLeaveDays": "1",
      "totalCompensatoryDays": "0",
      "totalSpecialLeaveDays": "0",
      "totalWorkHours": "160.0",
      "totalOverHours": "2.5",
      "totalHolidayWorkHours": "0.0"
    },
    "createdAt": "2025-06-08T10:30:00+09:00",
    "generationMethod": "auto"
  }
}
```

| フィールド | 型 | 説明 |
|---------|------|------|
| success | Boolean | 処理成功フラグ |
| attendance | Object | 作成された勤怠情報オブジェクト |
| attendance.generationMethod | String | 作成方法（"manual": 手動, "auto": 自動生成） |
| details[].autoGenerated | Boolean | 該当日が自動生成されたかどうか |

### 2.4 エラーレスポンス

#### 2.4.1 重複データエラー
```json
{
  "success": false,
  "error": {
    "code": "ATTENDANCE_ALREADY_EXISTS",
    "message": "指定された年月の勤怠情報は既に存在します"
  }
}
```

#### 2.4.2 手動作成時のdetails未指定エラー
```json
{
  "success": false,
  "error": {
    "code": "MISSING_ATTENDANCE_DETAILS",
    "message": "手動作成時はdetails配列が必須です",
    "details": "autoGenerate: falseの場合、details配列に日毎の勤怠情報を指定してください"
  }
}
```

#### 2.4.3 勤怠詳細の不正データエラー
```json
{
  "success": false,
  "error": {
    "code": "INVALID_ATTENDANCE_DETAIL",
    "message": "勤怠詳細に不正な値が含まれています",
    "details": [
      {
        "field": "details[0].startDateTime",
        "message": "勤怠開始時刻は必須です"
      },
      {
        "field": "details[1].date",
        "message": "日付形式が不正です"
      }
    ]
  }
}
```

#### 2.4.4 自動生成オプションの不正データエラー
```json
{
  "success": false,
  "error": {
    "code": "INVALID_GENERATE_OPTIONS",
    "message": "自動生成オプションの形式が不正です",
    "details": [
      {
        "field": "generateOptions.useLocationData",
        "message": "Boolean値で指定してください"
      },
      {
        "field": "generateOptions",
        "message": "オブジェクト形式で指定するか、省略してください"
      }
    ]
  }
}
```

## 3. 機能詳細

### 3.1 手動勤怠情報作成
- リクエストの `autoGenerate` が `false` の場合
- `details` 配列に含まれる日毎の勤怠情報をそのまま登録
- サマリ情報は詳細情報から自動計算して生成

#### 3.1.1 手動作成時のバリデーション
- **details配列の必須チェック**：
  - `details`が`null`、`undefined`、または空配列`[]`の場合はエラー
  - HTTPステータス: 400 Bad Request
  - エラーコード: `MISSING_ATTENDANCE_DETAILS`
- **個別詳細のバリデーション**：
  - 必須フィールドの存在確認（date, startDateTime, endDateTime等）
  - 時刻の論理的整合性チェック（開始時刻 < 終了時刻）
  - 勤務時間の計算妥当性チェック
  - 日付の重複チェック

### 3.2 自動勤怠情報作成
- リクエストの `autoGenerate` が `true` の場合
- 指定された年月の位置情報データを取得
- ユーザー勤怠設定（UserAttendanceSetting）から規定時間や設定を取得
- **注意**: 勤怠情報提出先（Company）機能は保留のため、一時的にユーザー設定から規定時間を取得
- 以下のステップで勤怠情報を自動生成：

#### 3.2.1 位置情報ベースの勤務判定
```javascript
function generateAttendanceFromLocation(userId, year, month, options) {
  // 1. 対象期間の位置情報を取得
  const locationData = getLocationData(userId, year, month);
  
  // 2. ユーザー勤怠設定を取得
  const userSettings = getUserAttendanceSetting(userId);
  
  // 3. 日毎の勤怠詳細を生成
  const details = [];
  const daysInMonth = getDaysInMonth(year, month);
  
  for (let day = 1; day <= daysInMonth; day++) {
    const date = new Date(year, month - 1, day);
    const dayLocationData = locationData.filter(loc => isSameDay(loc.at, date));
    
    const attendanceDetail = generateDailyAttendance(
      date, 
      dayLocationData, 
      userSettings, 
      options
    );
    
    details.push(attendanceDetail);
  }
  
  // 4. サマリ情報を計算
  const summary = calculateSummary(details);
  
  return { details, summary };
}
```

#### 3.2.2 日毎勤怠詳細の生成
```javascript
function generateDailyAttendance(date, locationData, userSettings, options) {
  // 休日判定
  const isHoliday = isHolidayDate(date);
  
  if (isHoliday && locationData.length === 0) {
    // 休日で位置情報がない場合
    return createHolidayAttendance(date);
  }
  
  // useLocationDataオプションの判定
  if (!options.useLocationData) {
    // 位置情報を使用しない場合の処理
    if (options.fallbackToRegulation) {
      // 規定時間を使用した勤怠情報を作成
      return createRegulationAttendance(date, userSettings);
    } else {
      // 位置情報もフォールバックも使用しない場合は欠勤として処理
      return createAbsentAttendance(date);
    }
  }
  
  // 勤務地近辺の位置情報を抽出（useLocationData: trueの場合のみ）
  // 注意: 現在は勤務地情報が保留のため、全位置情報を使用
  const workplaceProximityData = locationData;
  
  if (workplaceProximityData.length === 0) {
    if (options.fallbackToRegulation) {
      // 位置情報がない場合は規定時間を使用
      return createRegulationAttendance(date, userSettings);
    } else {
      // 位置情報がなく、規定時間フォールバックも無効の場合
      return createAbsentAttendance(date);
    }
  }
  
  // 勤務開始・終了時刻を判定
  const workingHours = determineWorkingHours(workplaceProximityData, userSettings);
  
  // 休憩時間を計算
  const restHour = calculateRestHour(workingHours, userSettings);
  
  // 勤務時間・残業時間を計算
  const { workHour, overHour } = calculateWorkAndOverHours(
    workingHours, 
    restHour, 
    userSettings
  );
  
  // 休暇判定
  let leave = "";
  if (options.autoLeaveDetection) {
    leave = detectLeaveType(workingHours, userSettings);
  }
  
  return {
    date: formatDate(date),
    holiday: isHoliday,
    leave: leave,
    startDateTime: workingHours.start,
    endDateTime: workingHours.end,
    restHour: restHour.toString(),
    workHour: workHour.toString(),
    overHour: overHour.toString(),
    note: "自動生成",
    autoGenerated: true
  };
}
```

### 3.3 既存データの重複チェック
- 指定された年月の勤怠情報が既に存在する場合はエラーを返却
- HTTPステータスコード 409 (Conflict) を使用

### 3.3 自動生成オプションの組み合わせ別挙動

| useLocationData | fallbackToRegulation | 挙動 |
|----------------|---------------------|------|
| true | true | 位置情報を優先使用、データなしの場合は規定時間 |
| true | false | 位置情報のみ使用、データなしの場合は欠勤 |
| false | true | 位置情報を使用せず、常に規定時間 |
| false | false | 位置情報を使用せず、常に欠勤 |

**使用シーン例**：
- `useLocationData: false, fallbackToRegulation: true`: 在宅勤務日など位置情報による判定が困難な期間
- `useLocationData: false, fallbackToRegulation: false`: 長期休暇期間など勤務がない期間の一括処理

### 3.4 サマリ情報の自動計算
- 日毎の勤怠詳細から以下を集計：
  - 総勤務日数（休日・休暇以外の日数）
  - 各種休暇日数（有給・代休・特別休暇）
  - 総勤務時間・総残業時間・総休日出勤時間

## 4. 自動勤怠情報作成アルゴリズム詳細

### 4.1 距離計算アルゴリズム（Haversine公式）
```javascript
function calculateDistance(lat1, lon1, lat2, lon2) {
  const R = 6371e3; // 地球の半径（メートル）
  const φ1 = lat1 * Math.PI/180;
  const φ2 = lat2 * Math.PI/180;
  const Δφ = (lat2-lat1) * Math.PI/180;
  const Δλ = (lon2-lon1) * Math.PI/180;

  const a = Math.sin(Δφ/2) * Math.sin(Δφ/2) +
          Math.cos(φ1) * Math.cos(φ2) *
          Math.sin(Δλ/2) * Math.sin(Δλ/2);
  const c = 2 * Math.atan2(Math.sqrt(a), Math.sqrt(1-a));

  return R * c; // メートル単位の距離
}
```

### 4.2 勤務判定アルゴリズム
```javascript
function determineWorkingHours(proximityData, userSettings) {
  if (proximityData.length === 0) {
    return null;
  }
  
  // 位置情報をタイムスタンプでソート
  const sortedData = proximityData.sort((a, b) => new Date(a.at) - new Date(b.at));
  
  // 勤務開始時刻：最初に勤務地近辺に現れた時刻
  const startTime = sortedData[0].at;
  
  // 勤務終了時刻：最後に勤務地近辺にいた時刻
  const endTime = sortedData[sortedData.length - 1].at;
  
  // 規定時間との調整（ユーザー設定から取得）
  const adjustedStart = adjustStartTime(startTime, userSettings.regulationStartTime);
  const adjustedEnd = adjustEndTime(endTime, userSettings.regulationEndTime);
  
  return {
    start: adjustedStart,
    end: adjustedEnd
  };
}
```

### 4.3 休暇自動判定ロジック
```javascript
function detectLeaveType(workingHours, userSettings) {
  if (!workingHours) {
    return ""; // 勤務データがない場合は判定しない
  }
  
  const startTime = new Date(workingHours.start).getHours() * 60 + 
                   new Date(workingHours.start).getMinutes();
  const endTime = new Date(workingHours.end).getHours() * 60 + 
                 new Date(workingHours.end).getMinutes();
  
  // ユーザー設定から規定時間を取得
  const regulationStart = parseTime(userSettings.regulationStartTime);
  const regulationRestStart = parseTime(userSettings.regulationRestStartTime);
  const regulationRestEnd = parseTime(userSettings.regulationRestEndTime);
  
  // 午前有給判定：規定休憩開始時刻までに勤務開始していない
  if (startTime >= regulationRestStart) {
    return "午前有給";
  }
  
  // 午後有給判定：規定休憩終了時刻以前に勤務終了
  if (endTime <= regulationRestEnd) {
    return "午後有給";
  }
  
  return ""; // 通常勤務
}
```

## 5. 機能特有の非機能要件

### 5.1 勤怠情報特有のセキュリティ要件
- 勤怠情報の作成権限：本人のみ可能
- 位置情報へのアクセス権限：本人の位置情報のみ参照可能

### 5.2 データ整合性要件
- 同一年月の勤怠情報の重複作成防止
- 位置情報データの時系列整合性チェック
- 勤務時間計算の論理的妥当性検証

### 5.3 パフォーマンス要件
- 自動生成処理の応答時間：1ヶ月分のデータで5秒以内
- 位置情報の取得・処理：最大1000件の位置情報データまで対応

## 6. エラーハンドリング

### 6.1 主要エラーケース
| エラーコード | HTTPステータス | 説明 | 対応方法 |
|------------|---------------|-----|---------|
| ATTENDANCE_ALREADY_EXISTS | 409 | 既に同年月の勤怠情報が存在 | 更新APIを使用するか、既存データを削除 |
| MISSING_ATTENDANCE_DETAILS | 400 | 手動作成時にdetails配列が空または未指定 | details配列に日毎の勤怠情報を指定 |
| INVALID_ATTENDANCE_DETAIL | 400 | 勤怠詳細の必須フィールド不足または不正な値 | 必須フィールドと正しい形式で指定 |
| INVALID_GENERATE_OPTIONS | 400 | generateOptionsの形式または値が不正 | 正しいオブジェクト形式で指定するか省略 |
| DUPLICATE_DATE | 400 | details配列内で同一日付が重複 | 各日付は1回のみ指定 |
| INSUFFICIENT_LOCATION_DATA | 422 | 自動生成に必要な位置情報が不足 | 手動作成への切り替えを推奨 |
| INVALID_DATE_RANGE | 400 | 不正な年月指定 | 有効な年月を指定 |

## 7. 拡張性考慮事項

### 7.1 将来的な拡張可能性
- 複数の勤怠情報提出先に対する一括作成機能
- 機械学習による勤務パターン学習と精度向上
- 外部カレンダー連携による休暇予定の自動反映
- GPS以外の位置情報ソース（Wi-Fi、Bluetooth）の統合

### 7.2 制限事項
- 位置情報の精度に依存する自動判定の限界
- 複雑な勤務形態（シフト制、フレックス制）への完全対応困難
- 在宅勤務など固定勤務地以外での自動判定制限

## 8. テスト方針

### 8.1 単体テスト
- 距離計算アルゴリズムの精度テスト
- 勤務判定ロジックの各種パターンテスト
- 休暇自動判定の境界値テスト
- サマリ計算の正確性テスト

### 8.2 統合テスト
- 位置情報取得から勤怠情報作成までのエンドツーエンドテスト
- 複数ユーザーでの同時処理テスト
- 異なる勤怠情報提出先での動作確認

### 8.3 パフォーマンステスト
- 大量位置情報データでの処理時間測定
- 同時リクエスト処理性能の確認

## 9. 依存関係

### 9.1 システム内依存
- 位置情報登録機能：位置情報データの参照
- ユーザー勤怠設定管理：設定情報の参照（規定時間等）

### 9.2 外部依存
- 祝日マスタAPI：休日判定
- タイムゾーン管理ライブラリ：時刻計算
- 日付処理ライブラリ：カレンダー計算

---

## 変更履歴
| 日付 | 変更者 | 変更内容 |
|-----|-------|---------|
| 2025/06/08 | カーン | 初版作成 - 勤怠情報登録機能と自動生成機能の統合設計 |
| 2025/06/08 | カーン | generateOptionsの明確化 - デフォルト値動作とエラーハンドリングの詳細追加 |
| 2025/06/08 | カーン | companyIdパラメータ削除 - 提出先機能保留のため、アルゴリズム関数でuserSettings使用に変更 |

※このドキュメントは開発の進行に合わせて随時更新されます。
