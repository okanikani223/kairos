# レスポンスデータ構造統一標準

## 1. 目的・適用範囲

### 1.1. 目的
kairosプロジェクトにおけるAPIレスポンス構造の一貫性を確保し、クライアント実装の効率化と保守性向上を実現する。

### 1.2. 適用範囲
- 全API機能のレスポンス形式
- 成功・エラーレスポンス共通
- HTTP RESTful APIにおける標準化

### 1.3. 準拠基準
- API設計統一ガイドライン
- HTTPステータスコード規格
- JSON API仕様

## 2. 統一レスポンス構造仕様

### 2.1. 成功レスポンス標準形式

#### 2.1.1. 必須フィールド構造
```json
{
  "success": true,
  "data": {
    // リソースデータ
  }
}
```

#### 2.1.2. メタデータ付きレスポンス
```json
{
  "success": true,
  "data": {
    // リソースデータ
  },
  "meta": {
    // ページネーション、統計情報等
  }
}
```

### 2.2. エラーレスポンス標準形式

#### 2.2.1. 基本エラーレスポンス
```json
{
  "success": false,
  "error": {
    "code": "ERROR_CODE",
    "message": "エラーメッセージ"
  }
}
```

#### 2.2.2. 詳細エラーレスポンス
```json
{
  "success": false,
  "error": {
    "code": "ERROR_CODE", 
    "message": "エラーメッセージ",
    "details": [
      {
        "field": "フィールド名",
        "message": "詳細エラーメッセージ",
        "value": "エラー値（任意）"
      }
    ]
  }
}
```

## 3. データ構造統一パターン

### 3.1. 単一リソースレスポンス

#### 3.1.1. 基本パターン
```json
{
  "success": true,
  "data": {
    "{resourceName}": {
      "id": "リソースID",
      // リソース固有フィールド
      "createdAt": "ISO 8601形式日時",
      "updatedAt": "ISO 8601形式日時"
    }
  }
}
```

#### 3.1.2. リソース名対応表
| 機能分類 | リソース名 | 複数形 |
|---------|-----------|-------|
| 勤怠情報 | attendance | attendances |
| 勤怠情報提出先 | company | companies |
| 位置情報 | location | locations |
| ユーザー設定 | userSetting | userSettings |

### 3.2. 複数リソースレスポンス（一覧）

#### 3.2.1. ページネーションなし
```json
{
  "success": true,
  "data": {
    "{resourceNamePlural}": [
      // リソース配列
    ]
  },
  "meta": {
    "total": "総件数"
  }
}
```

#### 3.2.2. ページネーション付き
```json
{
  "success": true,
  "data": {
    "{resourceNamePlural}": [
      // リソース配列
    ]
  },
  "meta": {
    "pagination": {
      "total": "総件数",
      "page": "現在ページ",
      "limit": "ページサイズ",
      "totalPages": "総ページ数",
      "hasNext": true,
      "hasPrev": false
    }
  }
}
```

### 3.3. 階層リソースレスポンス

```json
{
  "success": true,
  "data": {
    "{parentResourceName}": {
      "id": "親リソースID",
      // 親リソースフィールド
      "{childResourceNamePlural}": [
        // 子リソース配列
      ]
    }
  }
}
```

## 4. HTTPステータスコード別レスポンス仕様

### 4.1. 成功レスポンス

| ステータス | 用途 | 必須フィールド | 推奨data構造 |
|-----------|------|--------------|-------------|
| 200 OK | 取得・更新成功 | success, data | 単一または複数リソース |
| 201 Created | 作成成功 | success, data | 単一リソース |
| 204 No Content | 削除成功 | なし | レスポンスボディなし |

### 4.2. エラーレスポンス

| ステータス | エラーコード例 | 必須フィールド | details必要性 |
|-----------|--------------|--------------|-------------|
| 400 Bad Request | VALIDATION_ERROR | success, error | 必須 |
| 401 Unauthorized | AUTHENTICATION_ERROR | success, error | 任意 |
| 403 Forbidden | AUTHORIZATION_ERROR | success, error | 推奨 |
| 404 Not Found | RESOURCE_NOT_FOUND | success, error | 推奨 |
| 409 Conflict | CONFLICT_ERROR | success, error | 必須 |
| 422 Unprocessable Entity | BUSINESS_RULE_ERROR | success, error | 必須 |
| 500 Internal Server Error | INTERNAL_SERVER_ERROR | success, error | 任意 |

## 5. エラーコード・メッセージ統一仕様

### 5.1. エラーコード命名規則

#### 5.1.1. 命名パターン
```
{CATEGORY}_{SPECIFIC_ERROR}

カテゴリ:
- VALIDATION    # バリデーションエラー
- AUTHENTICATION # 認証エラー
- AUTHORIZATION # 認可エラー
- RESOURCE      # リソース関連エラー
- CONFLICT      # 競合エラー
- BUSINESS      # ビジネスルール違反
- INTERNAL      # サーバー内部エラー
```

#### 5.1.2. 標準エラーコード一覧

| エラーコード | HTTPステータス | 使用場面 |
|------------|--------------|---------|
| VALIDATION_ERROR | 400 | 入力値検証失敗 |
| AUTHENTICATION_ERROR | 401 | JWT無効・認証失敗 |
| AUTHORIZATION_ERROR | 403 | 権限不足 |
| RESOURCE_NOT_FOUND | 404 | リソース未存在 |
| CONFLICT_ERROR | 409 | データ重複・楽観的ロック |
| BUSINESS_RULE_ERROR | 422 | 業務ルール違反 |
| INTERNAL_SERVER_ERROR | 500 | システム例外 |

### 5.2. エラーメッセージ作成指針

#### 5.2.1. メッセージ原則
- **具体性**: 何が問題なのかを明確に記述
- **行動指針**: ユーザーが取るべき行動を示唆
- **技術詳細回避**: 内部実装の詳細は露出しない
- **多言語対応考慮**: 翻訳しやすい文体

#### 5.2.2. パターン別メッセージ例

**バリデーションエラー**:
```
"入力データに不正な値が含まれています"
"必須項目が入力されていません"
"指定された形式で入力してください"
```

**権限エラー**:
```
"この操作を実行する権限がありません"
"認証が必要です。ログインしてください"
```

**リソースエラー**:
```
"指定された{リソース名}が見つかりません"
"データが他のユーザーによって更新されています"
```

## 6. 詳細エラー情報（details）仕様

### 6.1. detailsフィールド構造

#### 6.1.1. 標準フィールド
```json
{
  "field": "エラー対象フィールド名",
  "message": "具体的なエラーメッセージ",
  "value": "エラーとなった値（任意）",
  "constraint": "制約情報（任意）"
}
```

#### 6.1.2. 用途別拡張フィールド

**バリデーションエラー**:
```json
{
  "field": "latitude",
  "message": "緯度は-90から90の範囲で入力してください",
  "value": 95.0,
  "constraint": {
    "type": "range",
    "min": -90,
    "max": 90
  }
}
```

**競合エラー**:
```json
{
  "field": "version",
  "message": "データが他のユーザーによって更新されています",
  "expected": 5,
  "actual": 7
}
```

**権限エラー**:
```json
{
  "field": "permission",
  "message": "この操作を実行する権限がありません",
  "required": "attendance:delete:all",
  "current": ["attendance:read:self"]
}
```

### 6.2. details配列の使用指針

#### 6.2.1. 単一エラー
```json
"details": [
  {
    "field": "email",
    "message": "有効なメールアドレス形式で入力してください"
  }
]
```

#### 6.2.2. 複数エラー
```json
"details": [
  {
    "field": "companyName",
    "message": "会社名は必須項目です"
  },
  {
    "field": "latitude",
    "message": "緯度は必須項目です"
  }
]
```

## 7. 非推奨パターンと移行指針

### 7.1. 非推奨パターン

#### 7.1.1. statusフィールド使用
❌ **非推奨**:
```json
{
  "status": "success",  // <- 非推奨
  "data": {}
}
```

✅ **推奨**:
```json
{
  "success": true,     // <- 推奨
  "data": {}
}
```

#### 7.1.2. 非標準エラー構造
❌ **非推奨**:
```json
{
  "error": "エラーメッセージ",  // <- 非推奨
  "code": 400
}
```

✅ **推奨**:
```json
{
  "success": false,
  "error": {
    "code": "VALIDATION_ERROR",
    "message": "エラーメッセージ"
  }
}
```

### 7.2. 移行戦略

#### 7.2.1. 段階的移行計画

**Phase 1（1-2週間）**: 新規機能への適用
- 新規開発機能で統一形式を適用
- 既存機能は現状維持

**Phase 2（3-4週間）**: 既存機能の段階的移行
- 高頻度使用API優先で移行
- クライアント側の対応と並行実施

**Phase 3（5-6週間）**: 完全統一
- 全機能の移行完了
- 非推奨パターンの廃止

#### 7.2.2. 移行チェックリスト

**設計段階**:
- [ ] successフィールドを使用している
- [ ] dataオブジェクト内にリソースを格納
- [ ] エラー時はerror.code/messageを設定
- [ ] detailsは配列形式で実装

**実装段階**:
- [ ] レスポンス生成ヘルパーを使用
- [ ] HTTPステータスコードが適切
- [ ] エラーコードが命名規則に準拠
- [ ] メタデータが適切に設定

**テスト段階**:
- [ ] 成功・エラー両方のレスポンス確認
- [ ] クライアント側の処理に問題なし
- [ ] API文書との整合性確認

## 8. 実装サポート

### 8.1. レスポンス生成ヘルパー

#### 8.1.1. 成功レスポンス生成
```typescript
function successResponse<T>(
  data: T, 
  meta?: any
): SuccessResponse<T> {
  return {
    success: true,
    data,
    ...(meta && { meta })
  };
}

// 使用例
return successResponse({ 
  attendance: attendanceData 
});

return successResponse(
  { attendances: attendanceList },
  { 
    pagination: {
      total: 150,
      page: 1,
      limit: 20,
      totalPages: 8,
      hasNext: true,
      hasPrev: false
    }
  }
);
```

#### 8.1.2. エラーレスポンス生成
```typescript
interface ErrorDetail {
  field: string;
  message: string;
  value?: any;
  constraint?: any;
  expected?: any;
  actual?: any;
}

function errorResponse(
  code: string,
  message: string,
  details?: ErrorDetail[]
): ErrorResponse {
  return {
    success: false,
    error: {
      code,
      message,
      ...(details && { details })
    }
  };
}

// 使用例
return errorResponse(
  'VALIDATION_ERROR',
  '入力データに不正な値が含まれています',
  [
    {
      field: 'latitude',
      message: '緯度は-90から90の範囲で入力してください',
      value: 95.0,
      constraint: { type: 'range', min: -90, max: 90 }
    }
  ]
);
```

### 8.2. TypeScript型定義

```typescript
interface SuccessResponse<T> {
  success: true;
  data: T;
  meta?: {
    pagination?: PaginationMeta;
    [key: string]: any;
  };
}

interface ErrorResponse {
  success: false;
  error: {
    code: string;
    message: string;
    details?: ErrorDetail[];
  };
}

interface PaginationMeta {
  total: number;
  page: number;
  limit: number;
  totalPages: number;
  hasNext: boolean;
  hasPrev: boolean;
}

type ApiResponse<T> = SuccessResponse<T> | ErrorResponse;
```

## 9. 品質確保・検証

### 9.1. 設計段階チェックリスト

#### 9.1.1. レスポンス構造確認
- [ ] successフィールドの使用（statusフィールド禁止）
- [ ] dataオブジェクト内のリソース格納
- [ ] 適切なリソース名使用（単数/複数形）
- [ ] HTTPステータスコードとの整合性

#### 9.1.2. エラーレスポンス確認
- [ ] error.code/messageの設定
- [ ] エラーコード命名規則準拠
- [ ] details配列形式（必要時）
- [ ] 適切なHTTPステータスコード

### 9.2. 実装段階検証

#### 9.2.1. 自動検証ルール
```typescript
// レスポンス構造検証
function validateResponse(response: any): boolean {
  // success必須チェック
  if (typeof response.success !== 'boolean') {
    return false;
  }
  
  // 成功時のdata必須チェック
  if (response.success && !response.data) {
    return false;
  }
  
  // エラー時のerror必須チェック
  if (!response.success && !response.error) {
    return false;
  }
  
  return true;
}
```

#### 9.2.2. 統合テスト項目
- APIレスポンス構造の一貫性
- クライアント側での処理可能性
- エラーハンドリングの適切性
- ページネーション動作の正確性

### 9.3. 継続的改善

#### 9.3.1. 定期レビュー項目
- 新規API機能の準拠状況
- エラーコード体系の拡張需要
- クライアント側でのレスポンス処理効率
- ユーザビリティ観点でのメッセージ改善

#### 9.3.2. メトリクス監視
- レスポンス構造違反の発生件数
- クライアント側エラーハンドリング失敗率
- API文書との整合性維持率

## 10. 付録

### 10.1. 機能分類別レスポンス例

#### 10.1.1. 勤怠情報関連
```json
// 登録成功（201 Created）
{
  "success": true,
  "data": {
    "attendance": {
      "id": "att_001",
      "userId": "usr_001",
      "timestamp": "2025-06-09T09:00:00Z",
      "attendanceType": "attendance",
      "location": {
        "latitude": 35.6762,
        "longitude": 139.6503
      },
      "createdAt": "2025-06-09T09:00:00Z",
      "updatedAt": "2025-06-09T09:00:00Z"
    }
  }
}

// 一覧取得（200 OK）
{
  "success": true,
  "data": {
    "attendances": [
      // 勤怠情報配列
    ]
  },
  "meta": {
    "pagination": {
      "total": 150,
      "page": 1,
      "limit": 20,
      "totalPages": 8,
      "hasNext": true,
      "hasPrev": false
    }
  }
}
```

#### 10.1.2. 勤怠情報提出先関連
```json
// 登録成功（201 Created）
{
  "success": true,
  "data": {
    "company": {
      "id": "cmp_001",
      "companyName": "株式会社サンプル",
      "location": {
        "latitude": "35.6762",
        "longitude": "139.6503"
      },
      "regulationStartTime": "09:00",
      "regulationEndTime": "18:00",
      "createdAt": "2025-06-09T10:30:00Z",
      "updatedAt": "2025-06-09T10:30:00Z"
    }
  }
}

// バリデーションエラー（400 Bad Request）
{
  "success": false,
  "error": {
    "code": "VALIDATION_ERROR",
    "message": "入力データに不正な値が含まれています",
    "details": [
      {
        "field": "companyName",
        "message": "会社名は1文字以上100文字以内で入力してください",
        "value": "",
        "constraint": {
          "type": "length",
          "min": 1,
          "max": 100
        }
      }
    ]
  }
}
```

### 10.2. 関連文書
- API設計統一ガイドライン
- バリデーション仕様記載標準
- セキュリティ要件記載標準
- APIエンドポイント構成統一標準

---

**文書バージョン**: 1.0  
**作成日**: 2025-01-09  
**最終更新**: 2025-01-09  
**承認者**: システム設計責任者
