# ユースケース詳細: ログイン

## 基本情報

| 項目             | 内容                                                                                             |
| ---------------- | ------------------------------------------------------------------------------------------------ |
| ユースケース ID  | UC-001                                                                                           |
| ユースケース名   | ログイン                                                                                         |
| アクター         | 利用者                                                                                           |
| 前提条件         | 利用者がシステムで有効なアカウントを持っていること<br>システムが利用可能な状態であること         |
| 事後条件(成功時) | 利用者がシステムにログインし、認証済セッションが確立されること<br>勤怠表一覧画面が表示されること |
| 事後条件(失敗時) | 利用者が未認証のままであること<br>ログイン画面が表示されること                                   |

## 概要

利用者がシステムにアクセスするための認証を行う。<br>認証に成功すると、利用者はシステムの各機能を利用できるようになる。

## 基本フロー

1. 利用者がログイン画面にアクセスする。
2. システムがログインフォーム(ID、パスワード入力欄)を表示する。
3. 利用者がユーザー ID とパスワードを入力し、「ログイン」ボタンをクリックする
4. システムが入力内容を検証する
5. システムが ID とパスワードを認証 API に送信する
6. 認証 API が認証処理を実行し、アクセストークンとリフレッシュトークンを発行して返す
7. システムが認証 API から発行されたアクセストークンとリフレッシュトークンを保存する
8. システムがホーム画面(勤怠表一覧画面)に遷移する

## 代替フロー

### 代替フロー A: アクセストークンが存在する場合

**分岐条件:** 基本フローのステップ 1 の時点で、アクセストークンが存在している場合

1. システムが認証 API にアクセストークンを送信する
2. 認証 API がアクセストークンの有効性を検証し、検証結果(アクセストークン有効)を返す
3. システムがホーム画面(勤怠表一覧画面)に遷移する

### 代替フロー A-1: アクセストークンが存在するが、無効な場合

**分岐条件:** 代替フロー A のステップ 2 の結果、アクセストークンが無効だった場合

1. システムがアクセストークン再発行 API にリフレッシュトークンを送信する
2. アクセストークン再発行 API がリフレッシュトークンの有効性を検証し、アクセストークンとリフレッシュトークンを再発行し返す
3. システムがアクセストークン再発行 API から再発行されたアクセストークンとリフレッシュトークンを保存する
4. 代替フロー A のステップ 1 に続く

## 例外フロー

### 例外フロー A: 不正な認証情報による認証失敗

**発生条件:** 基本フローのステップ 6 で、ID またはパスワードが誤っていた場合

1. 認証 API がエラーメッセージを返す
2. システムが認証 API から返されたメッセージを表示する
3. 基本フローのステップ 2 に戻る

### 例外フロー B: アカウント一時ロック

**発生条件:** 基本フローのステップ 6 で、連続ログイン失敗回数が上限(5 回)に達した、かつアカウントロック回数が 4 回未満の場合

1. システムが該当アカウントをロックする
2. システムがエラーメッセージ「アカウントが一時的にロックされました。時間をおいて再試行してください」を表示する
3. 基本フローのステップ 2 に戻る

### 例外フロー C: アカウント永続ロック

**発生条件:** 基本フローのステップ 6 で、連続ログイン失敗回数が上限(5 回)に達した、かつアカウントロック回数が 4 回以上の場合

1. システムが該当アカウントをロックする
2. システムがエラーメッセージ「アカウントが永続的にロックされました。管理者にお問い合わせください」を表示する
3. 基本フローのステップ 2 に戻る

### 例外フロー D: 入力値が空

**発生条件:** 基本フローのステップ 4 で、ID またはパスワードが未入力の場合

1. システムがエラーメッセージ「ID とパスワードは必須です。」を示する
2. 基本フローのステップ 2 に戻る

### 例外フロー D: リフレッシュトークンが存在しない場合

**発生条件:** 代替フロー A-1 のステップ 1 の時点で、リフレッシュトークンが存在しない場合

1. システムがアクセストークンを破棄する
2. システムがメッセージ「セッションの有効期限が切れました。再度ログインしてください」を表示する
3. 基本フローのステップ 2 に続く

### 例外フロー E: リフレッシュトークンが無効な場合

**発生条件:** 代替フロー A-1 のステップ 2 の結果、リフレッシュトークンが無効だった場合

1. システムがアクセストークンとリフレッシュトークンを破棄する
2. 基本フローのステップ 2 に続く

### 例外フロー F: 認証 API 接続エラー

**発生条件:** 基本フローのステップ 5、もしくは代替フロー A のステップ 1 で、認証 API との通信に失敗した場合

1. システムがエラーメッセージ「システムエラーが発生しました。しばらく時間をおいて再度お試しください」を表示する。
2. 基本フローのステップ 2 に続く

## ビジネスルール

- BR-001: ユーザー ID とパスワードは必須項目である
- BR-002: 連続ログイン失敗回数の上限は 5 回である
- BR-003: アカウントロック回数の閾値は 4 回である（4 回未満は一時ロック、4 回以上は永続ロック）
- BR-004: 有効なアクセストークンが存在する場合、ID・パスワード入力を省略できる
- BR-005: アクセストークンが無効な場合、リフレッシュトークンによる再発行が可能である
- BR-006: リフレッシュトークンが存在しない場合、再ログインが必要である
- BR-007: リフレッシュトークンが無効な場合、再ログインが必要である
- BR-008: 利用者はシステムで有効なアカウントを保持している必要がある
- BR-009: システムは利用可能な状態である必要がある

## 関連ユースケース

- なし

## 補足事項

- 他サイト連携(XやGithubなど)によるログインについても追加を予定