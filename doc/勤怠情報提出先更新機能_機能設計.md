# 勤怠情報提出先更新機能 機能設計

## 1. 機能概要

勤怠情報提出先更新機能は、既存の勤怠情報提出先（会社・組織）の情報を更新するためのAPIです。この機能では、会社名、位置情報、規定勤務時間、所属期間などの情報を部分的または全体的に更新することができます。

## 2. API仕様

### 2.1 エンドポイント

#### 2.1.1 全体更新
```
PUT /api/v1/companies/{companyId}
```

#### 2.1.2 部分更新
```
PATCH /api/v1/companies/{companyId}
```

### 2.2 リクエスト形式

#### 2.2.1 全体更新リクエスト（PUT）
```json
{
  "companyName": "株式会社サンプル（更新版）",
  "location": {
    "latitude": "35.6895",
    "longitude": "139.6917"
  },
  "regulationStartTime": "08:30",
  "regulationEndTime": "17:30",
  "regulationRestStartTime": "12:00",
  "regulationRestEndTime": "13:00",
  "affiliationStartDate": "2025-01-01",
  "affiliationEndDate": "2025-12-31"
}
```

#### 2.2.2 部分更新リクエスト（PATCH）
```json
{
  "companyName": "株式会社サンプル（更新版）",
  "regulationStartTime": "08:30",
  "regulationEndTime": "17:30"
}
```

### 2.3 パスパラメータ

| パラメータ名 | 型 | 必須 | 説明 |
|------------|---|-----|-----|
| companyId | String | ○ | 更新対象の会社ID（UUID形式） |

### 2.4 リクエストパラメータ

| パラメータ名 | 型 | PUT必須 | PATCH必須 | 説明 |
|------------|---|---------|-----------|-----|
| companyName | String | ○ | × | 会社名（1文字以上100文字以内） |
| location | Object | ○ | × | 勤務地の位置情報 |
| location.latitude | String | ○ | × | 緯度（-90.0～90.0の範囲） |
| location.longitude | String | ○ | × | 経度（-180.0～180.0の範囲） |
| regulationStartTime | String | ○ | × | 規定勤務開始時刻（HH:mm形式） |
| regulationEndTime | String | ○ | × | 規定勤務終了時刻（HH:mm形式） |
| regulationRestStartTime | String | × | × | 規定休憩開始時刻（HH:mm形式） |
| regulationRestEndTime | String | × | × | 規定休憩終了時刻（HH:mm形式） |
| affiliationStartDate | String | ○ | × | 所属開始日（YYYY-MM-DD形式） |
| affiliationEndDate | String | × | × | 所属終了日（YYYY-MM-DD形式、null可） |

### 2.5 レスポンス形式

#### 2.5.1 成功レスポンス（200 OK）
```json
{
  "status": "success",
  "data": {
    "company": {
      "id": "12345678-1234-1234-1234-123456789abc",
      "companyName": "株式会社サンプル（更新版）",
      "location": {
        "latitude": "35.6895",
        "longitude": "139.6917"
      },
      "regulationStartTime": "08:30",
      "regulationEndTime": "17:30",
      "regulationRestStartTime": "12:00",
      "regulationRestEndTime": "13:00",
      "affiliationStartDate": "2025-01-01",
      "affiliationEndDate": "2025-12-31",
      "createdAt": "2025-06-08T10:30:00+09:00",
      "updatedAt": "2025-06-08T15:45:00+09:00"
    }
  }
}
```

#### 2.5.2 エラーレスポンス（400 Bad Request）
```json
{
  "status": "error",
  "error": {
    "code": "VALIDATION_ERROR",
    "message": "入力データに不正な値が含まれています",
    "details": [
      {
        "field": "regulationStartTime",
        "message": "規定勤務開始時刻は終了時刻より前に設定してください"
      }
    ]
  }
}
```

#### 2.5.3 データ未存在レスポンス（404 Not Found）
```json
{
  "status": "error",
  "error": {
    "code": "COMPANY_NOT_FOUND",
    "message": "指定された勤怠情報提出先が見つかりません"
  }
}
```

#### 2.5.4 楽観的ロックエラー（409 Conflict）
```json
{
  "status": "error",
  "error": {
    "code": "OPTIMISTIC_LOCK_ERROR",
    "message": "データが他のユーザーによって更新されています。最新データを取得して再度実行してください"
  }
}
```

### 2.6 HTTPステータスコード

| ステータスコード | 説明 |
|---------------|-----|
| 200 OK | 更新が正常に完了した |
| 400 Bad Request | リクエストパラメータに不正な値が含まれている |
| 401 Unauthorized | 認証が必要、または認証に失敗した |
| 403 Forbidden | リクエストしたリソースへのアクセス権限がない |
| 404 Not Found | 指定されたリソースが見つからない |
| 409 Conflict | 楽観的ロックエラーまたは重複データエラー |
| 500 Internal Server Error | サーバー内部エラー |

## 3. 機能詳細

### 3.1 更新タイプ別処理

#### 3.1.1 全体更新（PUT）処理
```typescript
const putCompany = async (userId: string, companyId: string, data: CompanyUpdateData) => {
  // 1. 権限確認
  const existingCompany = await CompanyRepository.findByIdAndUserId(companyId, userId);
  if (!existingCompany) {
    throw new NotFoundError('指定された勤怠情報提出先が見つかりません');
  }
  
  // 2. 入力値検証
  validateCompanyData(data);
  
  // 3. 全体更新実行
  const updatedCompany = await CompanyRepository.update(companyId, {
    ...data,
    updatedAt: new Date()
  });
  
  return updatedCompany;
};
```

#### 3.1.2 部分更新（PATCH）処理
```typescript
const patchCompany = async (userId: string, companyId: string, data: Partial<CompanyUpdateData>) => {
  // 1. 権限確認
  const existingCompany = await CompanyRepository.findByIdAndUserId(companyId, userId);
  if (!existingCompany) {
    throw new NotFoundError('指定された勤怠情報提出先が見つかりません');
  }
  
  // 2. 部分的入力値検証
  validatePartialCompanyData(data);
  
  // 3. 部分更新実行
  const updatedCompany = await CompanyRepository.partialUpdate(companyId, {
    ...data,
    updatedAt: new Date()
  });
  
  return updatedCompany;
};
```

### 3.2 入力値検証

#### 3.2.1 全体更新用検証
```typescript
const validateCompanyData = (data: CompanyUpdateData) => {
  const errors: ValidationError[] = [];
  
  // 必須項目チェック
  if (!data.companyName || data.companyName.length > 100) {
    errors.push({
      field: 'companyName',
      message: '会社名は1文字以上100文字以内で入力してください'
    });
  }
  
  // 位置情報検証
  if (!isValidLocation(data.location)) {
    errors.push({
      field: 'location',
      message: '位置情報が正しくありません'
    });
  }
  
  // 時刻整合性検証
  if (data.regulationStartTime >= data.regulationEndTime) {
    errors.push({
      field: 'regulationStartTime',
      message: '規定勤務開始時刻は終了時刻より前に設定してください'
    });
  }
  
  if (errors.length > 0) {
    throw new ValidationError('入力データに不正な値が含まれています', errors);
  }
};
```

#### 3.2.2 部分更新用検証
```typescript
const validatePartialCompanyData = (data: Partial<CompanyUpdateData>) => {
  const errors: ValidationError[] = [];
  
  // 提供されたフィールドのみ検証
  if (data.companyName !== undefined) {
    if (!data.companyName || data.companyName.length > 100) {
      errors.push({
        field: 'companyName',
        message: '会社名は1文字以上100文字以内で入力してください'
      });
    }
  }
  
  if (data.location !== undefined && !isValidLocation(data.location)) {
    errors.push({
      field: 'location',
      message: '位置情報が正しくありません'
    });
  }
  
  // 時刻の整合性チェック（両方提供された場合のみ）
  if (data.regulationStartTime !== undefined && data.regulationEndTime !== undefined) {
    if (data.regulationStartTime >= data.regulationEndTime) {
      errors.push({
        field: 'regulationStartTime',
        message: '規定勤務開始時刻は終了時刻より前に設定してください'
      });
    }
  }
  
  if (errors.length > 0) {
    throw new ValidationError('入力データに不正な値が含まれています', errors);
  }
};
```

### 3.3 楽観的ロック制御

#### 3.3.1 バージョン管理
```typescript
const updateWithOptimisticLock = async (companyId: string, data: CompanyUpdateData, expectedVersion: number) => {
  const result = await CompanyRepository.updateWithVersion(
    companyId,
    data,
    expectedVersion
  );
  
  if (!result.success) {
    throw new OptimisticLockError(
      'データが他のユーザーによって更新されています。最新データを取得して再度実行してください'
    );
  }
  
  return result.data;
};
```

## 4. セキュリティ要件

### 4.1 共通セキュリティ基盤
**参照**: セキュリティ要件記載標準 3節
- 認証・認可: JWT ベース認証、役割ベースアクセス制御
- 通信セキュリティ: HTTPS必須、CORS設定
- 監査・ログ: アクセスログ、操作ログ、セキュリティログ

### 4.2 機能固有セキュリティ要件

#### 4.2.1 アクセス制御
**所有者ベースアクセス制御**:
- 基本原則: ユーザーは自分のデータのみアクセス可能
- 例外権限: 管理者権限・上司権限による他ユーザーデータアクセス
- 権限チェック: APIレベル・サービスレベルでの二重チェック

#### 4.2.2 データ保護
**提出先更新権限**:
- 所有者権限確認: ユーザーは自身の提出先のみ更新可能
- 入力値サニタイゼーション: XSS、SQLインジェクション対策

**データ整合性**:
- 楽観的ロック: 同時更新によるデータ破損を防止
- トランザクション管理: データベース更新の原子性保証
- 監査ログ: 更新操作の記録とトレーサビリティ

## 5. パフォーマンス要件

### 5.1 応答時間
- **全体更新**: 800ms以内
- **部分更新**: 500ms以内

### 5.2 同時処理
- **同時更新処理**: 楽観的ロックによる安全な同時更新
- **データベース負荷**: 適切なインデックス活用による高速化

## 6. エラーハンドリング

### 6.1 検証エラー処理
```typescript
const handleValidationError = (error: ValidationError) => {
  return {
    status: 'error',
    error: {
      code: 'VALIDATION_ERROR',
      message: error.message,
      details: error.details
    }
  };
};
```

### 6.2 楽観的ロックエラー処理
```typescript
const handleOptimisticLockError = () => {
  return {
    status: 'error',
    error: {
      code: 'OPTIMISTIC_LOCK_ERROR',
      message: 'データが他のユーザーによって更新されています。最新データを取得して再度実行してください'
    }
  };
};
```

## 7. テスト方針

### 7.1 単体テスト
- **データ更新テスト**: 正常データの更新確認
- **入力値検証**: 全パラメータの境界値・形式テスト
- **業務ロジック**: 時刻整合性・期間整合性の検証
- **部分更新**: PATCHリクエストの動作確認
- **全体更新**: PUTリクエストの動作確認
- **楽観的ロック**: 同時更新シナリオのテスト
- **エラーハンドリング**: 各エラーケースの適切な処理確認

### 7.2 統合テスト
- **API エンドポイント**: PUT/PATCH の統合テスト
- **権限制御**: 詳細な権限パターンの確認
- **データベース**: トランザクション処理・制約条件の確認
- **認証連携**: JWT認証システムとの連携確認

### 7.3 パフォーマンステスト
- **負荷テスト**: 同時更新処理での性能確認
- **応答時間**: 3秒以内での処理完了確認
- **同時処理**: 楽観的ロックの性能影響測定

## 8. 依存関係

### 8.1 システム内依存
- **認証サービス**: JWT認証による本人確認
- **ユーザー管理サービス**: ユーザー権限の確認
- **データベース**: Company テーブルの更新操作
- **監査ログサービス**: 更新操作の記録

### 8.2 外部依存
- **位置情報検証サービス**: 更新された位置情報の妥当性確認
- **通知サービス**: 重要な変更に対する通知送信

## 9. 変更履歴

| 日付 | 変更者 | 変更内容 |
|-----|-------|---------|
| 2025/06/08 | カーン | 初版作成 |
