# アクセス権限管理設計書

## 1. 概要

本ドキュメントは、kairosプロジェクトにおけるアクセス権限管理の体系的な設計を定義し、セキュリティ要件を満たしつつ運用しやすい権限制御システムを実現するためのガイドラインです。

### 1.1. 目的
- 権限管理の仕組みと粒度の明確化
- アクセス制御マトリクスの定義
- 権限付与・剥奪の運用方法確立
- セキュリティリスクの最小化

### 1.2. 対象範囲
- ユーザー役割（ロール）定義
- 機能別アクセス権限
- データアクセス権限
- API認可制御

## 2. ユーザー役割定義

### 2.1. 基本役割

#### 2.1.1. 一般ユーザー（User）
- **対象**: 勤怠管理を行う従業員
- **基本権限**: 
  - 自分の勤怠情報の登録・参照・更新
  - 自分の位置情報登録
  - 自分の勤怠設定の参照・更新

#### 2.1.2. 管理者（Manager）
- **対象**: チーム・部署の管理者
- **基本権限**: 
  - 一般ユーザーの全権限
  - 配下ユーザーの勤怠情報参照
  - 配下ユーザーの勤怠情報修正（承認）
  - 勤怠レポートの生成・出力

#### 2.1.3. システム管理者（Admin）
- **対象**: システム運用管理者
- **基本権限**: 
  - 全ユーザーの情報管理
  - システム設定管理
  - 監査ログ参照
  - マスタデータ管理

### 2.2. 特殊役割

#### 2.2.1. 人事担当者（HR）
- **対象**: 人事部門担当者
- **基本権限**: 
  - 全従業員の勤怠情報参照
  - 勤怠データの一括出力
  - 勤怠集計レポート参照
  - ユーザー勤怠設定の管理

#### 2.2.2. 監査担当者（Auditor）
- **対象**: 内部監査・コンプライアンス担当者
- **基本権限**: 
  - 全データの参照（読み取り専用）
  - 監査ログの詳細参照
  - データ整合性チェック
  - セキュリティレポート参照

## 3. アクセス権限マトリクス

### 3.1. 機能別アクセス権限

| 機能 | User | Manager | Admin | HR | Auditor |
|------|------|---------|-------|----|---------| 
| **勤怠情報登録** | 自分のみ | 自分のみ | 全て | 不可 | 不可 |
| **勤怠情報参照** | 自分のみ | 自分+配下 | 全て | 全て | 全て |
| **勤怠情報更新** | 自分のみ | 自分+配下 | 全て | 承認済みのみ | 不可 |
| **勤怠情報削除** | 自分のみ | 配下のみ | 全て | 不可 | 不可 |
| **位置情報登録** | 自分のみ | 自分のみ | 全て | 不可 | 不可 |
| **位置情報参照** | 自分のみ | 自分+配下 | 全て | 配下のみ | 全て |
| **勤怠設定管理** | 自分のみ | 自分+配下 | 全て | 全て | 参照のみ |
| **勤怠情報提出先管理** | 参照のみ | 参照のみ | 全て | 全て | 参照のみ |
| **ユーザー管理** | 不可 | 配下のみ | 全て | 全て | 参照のみ |
| **システム設定** | 不可 | 不可 | 全て | 不可 | 不可 |
| **監査ログ** | 不可 | 不可 | 全て | 不可 | 全て |

### 3.2. データアクセス権限詳細

#### 3.2.1. 勤怠情報データ

**ユーザー（User）**:
```typescript
// 自分のデータのみアクセス可能
GET /api/v1/attendances?user_id={current_user_id}
POST /api/v1/attendances // current_user_idで自動制限
PUT /api/v1/attendances/{id} // 自分のIDのみ許可
DELETE /api/v1/attendances/{id} // 自分のIDのみ許可
```

**管理者（Manager）**:
```typescript
// 自分 + 配下のデータにアクセス可能
GET /api/v1/attendances?user_id IN ({current_user_id}, {subordinate_ids})
POST /api/v1/attendances // current_user_idで自動制限
PUT /api/v1/attendances/{id} // 自分+配下のIDのみ許可
DELETE /api/v1/attendances/{id} // 配下のIDのみ許可
```

**システム管理者（Admin）**:
```typescript
// 全データにアクセス可能
GET /api/v1/attendances // 制限なし
POST /api/v1/attendances // 制限なし
PUT /api/v1/attendances/{id} // 制限なし
DELETE /api/v1/attendances/{id} // 制限なし
```

#### 3.2.2. 位置情報データ

**ユーザー（User）**:
```typescript
// 自分の位置情報のみ
POST /api/v1/locations // current_user_idで自動制限
GET /api/v1/locations?user_id={current_user_id}
DELETE /api/v1/locations/{id} // 自分のIDのみ許可
```

**管理者（Manager）**:
```typescript
// 自分 + 配下の位置情報
POST /api/v1/locations // current_user_idで自動制限
GET /api/v1/locations?user_id IN ({current_user_id}, {subordinate_ids})
DELETE /api/v1/locations/{id} // 自分+配下のIDのみ許可
```

## 4. 権限制御実装方式

### 4.1. JWT ベース認証・認可

#### 4.1.1. JWT クレーム構造
```json
{
  "sub": "user_12345",
  "role": "manager",
  "permissions": [
    "attendance:read:self",
    "attendance:write:self", 
    "attendance:read:subordinates",
    "attendance:write:subordinates"
  ],
  "subordinates": ["user_67890", "user_11111"],
  "department": "engineering",
  "iat": 1623456789,
  "exp": 1623460389
}
```

#### 4.1.2. 権限チェック middleware
```typescript
interface PermissionCheck {
  resource: string;     // 'attendance', 'location', 'user'
  action: string;       // 'read', 'write', 'delete'
  scope: string;        // 'self', 'subordinates', 'all'
  targetUserId?: string; // 対象ユーザーID（必要時）
}

function checkPermission(
  userToken: JWTPayload,
  permission: PermissionCheck
): boolean {
  const { resource, action, scope, targetUserId } = permission;
  const permissionKey = `${resource}:${action}:${scope}`;
  
  // 基本権限チェック
  if (!userToken.permissions.includes(permissionKey)) {
    return false;
  }
  
  // スコープ別追加チェック
  if (scope === 'self') {
    return targetUserId === userToken.sub;
  } else if (scope === 'subordinates') {
    return targetUserId === userToken.sub || 
           userToken.subordinates.includes(targetUserId);
  } else if (scope === 'all') {
    return userToken.role === 'admin' || userToken.role === 'hr';
  }
  
  return false;
}
```

### 4.2. データベースレベル権限制御

#### 4.2.1. Row Level Security (RLS)
```sql
-- 勤怠情報テーブルのRLS設定例
CREATE POLICY attendance_access_policy ON attendances
  FOR ALL
  TO application_role
  USING (
    -- 自分のデータは常にアクセス可能
    user_id = current_setting('app.current_user_id')::uuid
    OR
    -- 管理者は配下のデータにアクセス可能
    (
      current_setting('app.current_user_role') = 'manager'
      AND user_id = ANY(
        string_to_array(current_setting('app.subordinates'), ',')::uuid[]
      )
    )
    OR
    -- Admin/HRは全データにアクセス可能
    current_setting('app.current_user_role') IN ('admin', 'hr')
  );
```

#### 4.2.2. コンテキスト設定
```typescript
async function setDatabaseContext(userToken: JWTPayload) {
  await db.query('SET app.current_user_id = $1', [userToken.sub]);
  await db.query('SET app.current_user_role = $1', [userToken.role]);
  await db.query('SET app.subordinates = $1', [userToken.subordinates.join(',')]);
}
```

## 5. API認可実装

### 5.1. エンドポイント別認可制御

#### 5.1.1. 勤怠情報関連API
```typescript
// GET /api/v1/attendances
app.get('/api/v1/attendances', 
  authenticateJWT,
  requirePermission({
    resource: 'attendance',
    action: 'read',
    scope: 'self' // デフォルトは自分のみ
  }),
  async (req, res) => {
    // クエリパラメータによる権限拡張チェック
    const requestedUserId = req.query.user_id;
    if (requestedUserId && requestedUserId !== req.user.sub) {
      // 他ユーザーのデータが要求された場合、追加権限チェック
      const hasSubordinateAccess = checkPermission(req.user, {
        resource: 'attendance',
        action: 'read', 
        scope: 'subordinates',
        targetUserId: requestedUserId
      });
      const hasAllAccess = checkPermission(req.user, {
        resource: 'attendance',
        action: 'read',
        scope: 'all'
      });
      
      if (!hasSubordinateAccess && !hasAllAccess) {
        return res.status(403).json({
          success: false,
          error: {
            code: 'AUTHORIZATION_ERROR',
            message: '指定されたユーザーの勤怠情報にアクセスする権限がありません'
          }
        });
      }
    }
    
    // データ取得処理
    // ...
  }
);
```

#### 5.1.2. 位置情報関連API
```typescript
// POST /api/v1/locations
app.post('/api/v1/locations',
  authenticateJWT,
  requirePermission({
    resource: 'location',
    action: 'write',
    scope: 'self'
  }),
  async (req, res) => {
    // 位置情報登録は常に自分のみ
    req.body.user_id = req.user.sub; // 強制的に自分のIDを設定
    
    // 登録処理
    // ...
  }
);
```

### 5.2. 権限エラーハンドリング

#### 5.2.1. 統一エラーレスポンス
```json
{
  "success": false,
  "error": {
    "code": "AUTHORIZATION_ERROR",
    "message": "この操作を実行する権限がありません",
    "details": [
      {
        "resource": "attendance",
        "action": "delete",
        "required_permission": "attendance:delete:subordinates",
        "current_permissions": ["attendance:read:self", "attendance:write:self"]
      }
    ]
  }
}
```

## 6. 権限管理運用

### 6.1. 権限付与プロセス

#### 6.1.1. 新規ユーザー
1. **デフォルト権限付与**: 全新規ユーザーに`User`役割を自動付与
2. **部署・チーム配属**: 管理者の配下に設定
3. **特別権限申請**: 必要に応じて追加権限を申請・承認

#### 6.1.2. 役割変更
1. **昇進・異動**: HR担当者が役割変更申請
2. **承認プロセス**: システム管理者が承認
3. **権限有効化**: 承認後、次回ログイン時に権限反映

### 6.2. 権限監査

#### 6.2.1. 定期監査項目
- 不要権限の定期見直し（四半期）
- 休職・退職者の権限無効化確認
- 管理者権限の妥当性確認
- アクセスログによる異常検知

#### 6.2.2. 監査ログ記録
```typescript
interface AuditLog {
  timestamp: string;
  user_id: string;
  action: string;
  resource: string;
  target_user_id?: string;
  result: 'success' | 'denied';
  ip_address: string;
  user_agent: string;
  request_id: string;
}

// 監査ログ記録例
function logAccess(auditInfo: AuditLog) {
  logger.info('ACCESS_AUDIT', {
    ...auditInfo,
    severity: auditInfo.result === 'denied' ? 'WARNING' : 'INFO'
  });
}
```

## 7. セキュリティ考慮事項

### 7.1. 最小権限の原則
- ユーザーには必要最小限の権限のみを付与
- 権限の組み合わせによる権限昇格の防止
- 定期的な権限見直しによる不要権限の削除

### 7.2. 権限境界の明確化
- 役割間の権限重複の最小化
- 例外権限の明確な文書化
- 緊急時アクセス手順の確立

### 7.3. データ保護
- 個人情報アクセスの厳格な制御
- 位置情報の適切な保護レベル設定
- 機密度に応じたアクセス制御粒度の調整

## 8. 実装チェックリスト

### 8.1. 認証・認可基盤
- [ ] JWT ベース認証システムの実装
- [ ] 権限チェック middleware の実装
- [ ] データベース RLS の設定
- [ ] API エンドポイント認可制御の実装

### 8.2. 権限管理機能
- [ ] 役割管理画面の実装
- [ ] 権限付与・剥奪機能の実装
- [ ] 権限継承機能（管理者-配下関係）の実装
- [ ] 監査ログ機能の実装

### 8.3. 運用機能
- [ ] 権限レポート機能の実装
- [ ] 定期監査機能の実装
- [ ] 緊急アクセス機能の実装
- [ ] 権限変更通知機能の実装

## 9. 今後の拡張計画

### 9.1. 動的権限制御
- 時間・場所に基づく権限制御
- プロジェクト単位での権限管理
- 一時的権限付与機能

### 9.2. 外部システム連携
- Active Directory連携
- SAML/OAuth2.0 対応
- シングルサインオン（SSO）対応

### 9.3. 高度な監査機能
- 機械学習による異常アクセス検知
- リアルタイム監査アラート
- 権限使用状況の可視化

## 10. 変更履歴

| 日付 | バージョン | 変更内容 | 作成者 |
|------|-----------|---------|-------|
| 2025/06/09 | 1.0 | 初版作成 | カーン |

---

※このドキュメントは、システムのセキュリティ要件と運用要件を満たすために定期的に見直し・更新を行います。
