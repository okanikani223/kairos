# APIエンドポイント構成統一標準

## 1. 概要

### 1.1. 目的
- APIエンドポイント構成パターンの統一
- 機能横断での設計一貫性の確保
- 複数パターン混在による混乱の解決
- 実装・運用・保守性の向上

### 1.2. 対象範囲
- 全APIエンドポイント設計
- エンドポイント構成パターンの分類
- パターン選択基準の明確化
- 機能設計書での記載形式統一

### 1.3. 関連ドキュメント
- `API設計統一ガイドライン.md`: 基本的なAPI設計規則
- `バリデーション仕様記載標準.md`: バリデーション関連の標準
- `セキュリティ要件記載標準.md`: セキュリティ関連の標準

## 2. エンドポイント構成パターン分類

### 2.1. パターン分類体系

#### 2.1.1. レベル1: 基本RESTfulパターン（必須）
**適用対象**: 全機能の基本CRUD操作
**特徴**: RESTful APIの標準的な設計パターン

```
GET    /api/v1/{resource}              # 一覧取得
GET    /api/v1/{resource}/{id}         # 詳細取得
POST   /api/v1/{resource}              # 新規作成
PUT    /api/v1/{resource}/{id}         # 完全更新
PATCH  /api/v1/{resource}/{id}         # 部分更新
DELETE /api/v1/{resource}/{id}         # 削除
```

**記載要件**:
- 全6つの基本操作エンドポイントを明記
- HTTPメソッドとステータスコードの対応
- リクエスト・レスポンス形式の詳細

#### 2.1.2. レベル2: 階層リソースパターン（推奨）
**適用対象**: 親子関係がある複合リソース操作
**特徴**: リソース間の関係性を表現する階層構造

```
# 親リソース
GET    /api/v1/{parent}                           # 親リソース一覧
GET    /api/v1/{parent}/{parent-id}               # 親リソース詳細
POST   /api/v1/{parent}                           # 親リソース作成

# 子リソース（最大3階層まで）
GET    /api/v1/{parent}/{parent-id}/{child}       # 子リソース一覧
GET    /api/v1/{parent}/{parent-id}/{child}/{child-id}  # 子リソース詳細
POST   /api/v1/{parent}/{parent-id}/{child}       # 子リソース作成
PUT    /api/v1/{parent}/{parent-id}/{child}/{child-id}  # 子リソース更新
DELETE /api/v1/{parent}/{parent-id}/{child}/{child-id}  # 子リソース削除
```

**記載要件**:
- 親子関係の明確な定義
- 階層ごとの権限・バリデーション仕様
- カスケード操作の動作仕様

#### 2.1.3. レベル3: 業務特化パターン（条件付き）
**適用対象**: RESTfulパターンでは表現困難な業務操作
**特徴**: 動詞を含むカスタムエンドポイント

```
# 状態変更操作
PATCH  /api/v1/{resource}/{id}/disable          # 無効化
PATCH  /api/v1/{resource}/{id}/enable           # 有効化
PATCH  /api/v1/{resource}/{id}/archive          # アーカイブ化

# 複合操作
POST   /api/v1/{resource}/{id}/regenerate       # 再生成
POST   /api/v1/{resource}/{id}/duplicate        # 複製
POST   /api/v1/{resource}/bulk-import           # 一括インポート

# 特殊検索・分析
GET    /api/v1/{resource}/search                # 高度な検索
GET    /api/v1/{resource}/analytics             # 分析データ取得
GET    /api/v1/{resource}/export                # データエクスポート
```

**記載要件**:
- 動詞使用の必要性説明
- RESTfulパターンとの使い分け基準
- 業務ロジック詳細の明記

### 2.2. パターン適用基準

#### 2.2.1. 機能複雑度による分類

**シンプル機能（レベル1のみ）**:
- 単一リソースのCRUD操作のみ
- 業務ロジックが複雑でない
- 例: 基本的なマスタデータ管理

**標準機能（レベル1 + レベル2）**:
- 複数リソースの関連操作
- 親子関係がある複合データ
- 例: 勤怠情報と勤怠詳細

**複合機能（レベル1 + レベル2 + レベル3）**:
- 複雑な業務ロジック
- 状態遷移・ワークフロー
- 例: 勤怠情報の自動生成・無効化

#### 2.2.2. レベル3使用可否判定チェックリスト

**使用可能な条件（すべて満たす必要）**:
- [ ] RESTfulパターンでは業務要件を適切に表現できない
- [ ] 複数のリソースにまたがる複合操作である
- [ ] ユーザビリティ向上に明確に寄与する
- [ ] セキュリティリスクが適切に管理されている
- [ ] APIドキュメントで明確に説明可能である

**使用すべきでない例**:
- 単純な検索条件の追加（クエリパラメータで対応）
- 既存の更新操作で代替可能な処理
- セキュリティ上のリスクが高い操作

## 3. 機能分類別統一パターン

### 3.1. 勤怠情報関連機能
**パターン**: レベル1 + レベル2 + レベル3（複合機能）

```
# レベル1: 基本CRUD
GET    /api/v1/attendances                     # 一覧取得
GET    /api/v1/attendances/{attendance-id}     # 詳細取得
POST   /api/v1/attendances                     # 新規登録
PUT    /api/v1/attendances/{attendance-id}     # 完全更新
PATCH  /api/v1/attendances/{attendance-id}     # 部分更新
DELETE /api/v1/attendances/{attendance-id}     # 削除

# レベル2: 階層リソース（勤怠詳細）
GET    /api/v1/attendances/{attendance-id}/details           # 詳細一覧
GET    /api/v1/attendances/{attendance-id}/details/{detail-id} # 詳細取得
POST   /api/v1/attendances/{attendance-id}/details           # 詳細作成
PATCH  /api/v1/attendances/{attendance-id}/details/{detail-id} # 詳細更新
DELETE /api/v1/attendances/{attendance-id}/details/{detail-id} # 詳細削除

# レベル3: 業務特化操作
PATCH  /api/v1/attendances/{attendance-id}/disable          # 論理削除
POST   /api/v1/attendances/{attendance-id}/regenerate       # 自動再生成
GET    /api/v1/attendances/search                           # 高度な検索
```

### 3.2. 勤怠情報提出先関連機能
**パターン**: レベル1（標準機能）

```
# レベル1: 基本CRUD
GET    /api/v1/companies                       # 一覧取得
GET    /api/v1/companies/{company-id}          # 詳細取得
POST   /api/v1/companies                       # 新規登録
PUT    /api/v1/companies/{company-id}          # 完全更新
PATCH  /api/v1/companies/{company-id}          # 部分更新
DELETE /api/v1/companies/{company-id}          # 削除
```

### 3.3. 位置情報関連機能
**パターン**: レベル1（シンプル機能）

```
# レベル1: 基本操作（業務特性によりCRUDの一部のみ）
POST   /api/v1/locations                       # 位置情報登録
GET    /api/v1/locations                       # 位置履歴取得
DELETE /api/v1/locations/{location-id}         # 位置情報削除
```

### 3.4. ユーザー設定関連機能
**パターン**: レベル1 + レベル2（標準機能）

```
# レベル1: 基本CRUD
GET    /api/v1/user-settings                   # 設定一覧
GET    /api/v1/user-settings/{setting-id}      # 設定詳細
POST   /api/v1/user-settings                   # 設定作成
PUT    /api/v1/user-settings/{setting-id}      # 設定更新
DELETE /api/v1/user-settings/{setting-id}     # 設定削除

# レベル2: 階層リソース（設定項目）
GET    /api/v1/user-settings/{setting-id}/items         # 設定項目一覧
PATCH  /api/v1/user-settings/{setting-id}/items/{item-id} # 設定項目更新
```

## 4. 機能設計書記載統一基準

### 4.1. エンドポイント構成記載形式

#### 4.1.1. セクション構成（必須）
```markdown
## 2. API仕様

### 2.1 エンドポイント構成概要
- **構成パターン**: [レベル1|レベル1+2|レベル1+2+3]
- **パターン選択理由**: [選択理由の説明]

### 2.2 レベル1: 基本CRUD操作
[基本6操作の詳細仕様]

### 2.3 レベル2: 階層リソース操作（該当する場合）
[親子関係リソースの詳細仕様]

### 2.4 レベル3: 業務特化操作（該当する場合）
[カスタムエンドポイントの詳細仕様]
```

#### 4.1.2. 各レベルの必須記載項目

**レベル1（基本CRUD）の記載項目**:
- HTTPメソッド・URL・説明の一覧表
- 各操作のリクエスト・レスポンス仕様
- HTTPステータスコード対応表
- エラーハンドリング仕様

**レベル2（階層リソース）の記載項目**:
- 親子関係の定義と制約
- 階層ごとの権限制御仕様
- カスケード操作の動作仕様
- データ整合性確保の仕組み

**レベル3（業務特化）の記載項目**:
- 動詞使用の必要性説明
- 業務ロジックの詳細フロー
- セキュリティ考慮事項
- パフォーマンス影響評価

### 4.2. クエリパラメータ統一基準

#### 4.2.1. 共通パラメータ（全機能必須）
| パラメータ | 型 | デフォルト値 | 説明 | 記載レベル |
|-----------|---|------------|------|-----------|
| page | integer | 1 | ページ番号（1から開始） | 必須 |
| limit | integer | 20 | 1ページあたりのアイテム数 | 必須 |
| sort | string | - | ソートフィールド | 推奨 |
| order | string | "asc" | ソート順序（asc/desc） | 推奨 |

#### 4.2.2. フィルタリングパラメータ（機能固有）
| パラメータ分類 | 記載要件 | 例 |
|--------------|---------|---|
| 日付範囲 | 必須（業務系機能） | start_date, end_date |
| ステータス | 必須（状態管理機能） | status, is_active |
| 関連性 | 推奨（関連機能） | user_id, company_id |

#### 4.2.3. デフォルト値記載形式（統一）
```markdown
| パラメータ | 型 | デフォルト値 | 説明 | 制約 |
|-----------|---|------------|------|------|
| limit | integer | 20 | 1ページあたりのアイテム数 | 1-100 |
| sort | string | "createdAt" | ソートフィールド | フィールド名 |
```

### 4.3. レスポンス形式記載統一

#### 4.3.1. データ構造記載レベル
**Level A（基本記載）**: 全機能必須
- 成功レスポンスの基本構造
- エラーレスポンスの基本構造
- HTTPステータスコードと対応

**Level B（詳細記載）**: 複雑な機能
- ネストしたデータ構造の詳細
- 関連データの包含ルール
- ページネーション詳細仕様

**Level C（完全記載）**: 最重要機能
- 全フィールドの型・制約・説明
- エラー詳細情報の構造
- バリデーション仕様との連携

#### 4.3.2. 統一データ包含パターン

**単一リソース**:
```json
{
  "success": true,
  "data": {
    "{resourceName}": {
      // リソースデータ
    }
  }
}
```

**複数リソース（一覧）**:
```json
{
  "success": true,
  "data": {
    "{resourceNamePlural}": [
      // リソース配列
    ]
  },
  "meta": {
    "total": "総件数",
    "page": "現在ページ",
    "limit": "ページサイズ",
    "hasNext": "次ページ有無"
  }
}
```

**階層リソース**:
```json
{
  "success": true,
  "data": {
    "{parentResourceName}": {
      // 親リソースデータ
      "{childResourceNamePlural}": [
        // 子リソース配列
      ]
    }
  }
}
```

## 5. 移行・適用戦略

### 5.1. 段階的適用計画

#### 5.1.1. フェーズ1（即時適用対象）
**対象**: 新規機能設計
- 本標準の完全適用
- パターン選択基準の厳格適用
- 記載形式の統一

#### 5.1.2. フェーズ2（3ヶ月以内）
**対象**: 既存機能設計書の更新
- エンドポイント構成の再分類
- 記載形式の統一化
- 不整合部分の修正

#### 5.1.3. フェーズ3（6ヶ月以内）
**対象**: 実装への反映
- 既存APIの段階的統一
- 下位互換性の考慮
- 移行計画の策定

### 5.2. 品質確保プロセス

#### 5.2.1. 設計段階チェックリスト
**エンドポイント構成設計時**:
- [ ] パターン分類が適切に選択されている
- [ ] レベル3使用の必要性が明確に説明されている
- [ ] 階層構造が3レベル以下に収まっている
- [ ] 命名規則が統一されている

**機能設計書記載時**:
- [ ] 必須セクション構成に従っている
- [ ] 各レベルの必須記載項目が網羅されている
- [ ] クエリパラメータが統一基準に準拠している
- [ ] レスポンス形式が統一パターンに従っている

#### 5.2.2. レビュー基準
**Level 1レビュー（全機能）**:
- 基本RESTfulパターンの準拠確認
- 命名規則・HTTPメソッド使用の適切性
- レスポンス形式の統一性

**Level 2レビュー（階層リソース機能）**:
- 親子関係定義の明確性
- 権限制御・データ整合性の設計
- カスケード操作の妥当性

**Level 3レビュー（業務特化機能）**:
- カスタムエンドポイント使用の必要性
- セキュリティリスクの評価
- パフォーマンス影響の分析

### 5.3. 継続的改善プロセス

#### 5.3.1. 定期見直し（四半期）
- 新たなパターンの発見・分類
- 既存パターンの有効性評価
- 業界標準・技術動向の反映

#### 5.3.2. フィードバック収集
- 開発チームからの改善要望
- 運用チームからの課題報告
- ユーザビリティの評価結果

## 6. 実装支援ツール

### 6.1. 設計支援テンプレート

#### 6.1.1. エンドポイント構成決定フローチャート
```
機能要件の分析
　　↓
単一リソースのCRUDのみ？ → Yes → レベル1適用
　　↓ No
親子関係のあるリソース？ → Yes → レベル1+2適用
　　↓ No  
RESTfulで表現困難な業務操作？ → Yes → レベル1+2+3適用
　　↓ No
レベル1+2で再設計を検討
```

#### 6.1.2. 機能設計書テンプレート
```markdown
## 2. API仕様

### 2.1 エンドポイント構成概要
- **構成パターン**: [選択したパターン]
- **パターン選択理由**: [理由説明]
- **適用チェック結果**: [チェックリスト結果]

### 2.2 レベル1: 基本CRUD操作
[テンプレートに従った記載]

### 2.3 レベル2: 階層リソース操作（該当時）
[テンプレートに従った記載]

### 2.4 レベル3: 業務特化操作（該当時）
[テンプレートに従った記載]
```

### 6.2. 自動チェックツール仕様

#### 6.2.1. 構成パターンチェック
- エンドポイントURL形式の妥当性
- HTTPメソッドとパスの対応確認
- 階層レベル制限の確認

#### 6.2.2. 記載完整性チェック
- 必須セクションの存在確認
- 必須記載項目の網羅確認
- 統一形式への準拠確認

## 7. 今後の拡張計画

### 7.1. 新技術対応
- GraphQL APIパターンの検討
- gRPC APIパターンの検討
- WebSocket APIパターンの検討

### 7.2. 業務拡張対応
- 新規業務ドメインでのパターン適用
- 外部システム連携パターンの標準化
- マイクロサービス間通信パターンの整備

## 8. 関連資料

### 8.1. 参考標準・ガイドライン
- [RESTful API設計ベストプラクティス](https://example.com)
- [HTTPステータスコード使用指針](https://example.com)
- [API命名規則標準](https://example.com)

### 8.2. 社内関連ドキュメント
- `API設計統一ガイドライン.md`: 基本的なAPI設計規則
- `バリデーション仕様記載標準.md`: バリデーション関連標準
- `セキュリティ要件記載標準.md`: セキュリティ関連標準
- `非機能要件記載標準.md`: 非機能要件標準

## 9. 変更履歴

| バージョン | 日付 | 変更者 | 変更内容 |
|-----------|------|-------|---------|
| 1.0 | 2025-06-09 | システム設計チーム | 初版作成 |

---

**注記**: 本標準は `API設計統一ガイドライン.md` を補完する位置づけで、エンドポイント構成パターンの統一に特化した内容となっています。基本的なAPI設計ルールについては、引き続き `API設計統一ガイドライン.md` を参照してください。
