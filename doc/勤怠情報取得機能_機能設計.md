# 勤怠情報取得機能 機能設計

## 1. 機能概要

勤怠情報取得機能は、指定した年月の勤怠情報をシステムから取得するためのAPIです。この機能により、ユーザーは過去の勤怠記録を確認したり、提出用のデータを取得したりすることができます。また、指定された年月の勤怠情報が存在しない場合は、位置情報データを基に自動的に勤怠情報を作成する処理も含みます。

## 2. API仕様

### 2.1 エンドポイント
```
GET /api/v1/attendances/{year}/{month}
```

### 2.2 リクエストパラメータ
| パラメータ名 | 型 | 説明 | 必須 | 例 |
|-----------|------|------|------|-----|
| year | Number | 取得対象の年 | はい | 2025 |
| month | String | 取得対象の月（2桁、0埋め） | はい | 06 |
| companyId | UUID | 勤怠情報提出先ID（クエリパラメータ） | いいえ | 550e8400-e29b-41d4-a716-446655440000 |

### 2.3 レスポンス形式
```json
{
  "success": true,
  "attendances": [
    {
      "id": "550e8400-e29b-41d4-a716-446655440000",
      "year": 2025,
      "month": 6,
      "companyId": "550e8400-e29b-41d4-a716-446655440001",
      "details": [
      {
        "id": "550e8400-e29b-41d4-a716-446655440002",
        "date": "2025-06-01",
        "holiday": false,
        "leave": "",
        "startDateTime": "2025-06-01T09:00:00+09:00",
        "endDateTime": "2025-06-01T18:00:00+09:00",
        "restHour": "1.0",
        "workHour": "8.0",
        "overHour": "0.0",
        "note": "",
        "locationIds": ["550e8400-e29b-41d4-a716-446655440003", "550e8400-e29b-41d4-a716-446655440004"]
      },
      // 以下、月内の日数分の勤怠詳細が続く
    ],
    "summary": {
      "totalWorkDays": "20",
      "totalPaidLeaveDays": "1",
      "totalCompensatoryDays": "0",
      "totalSpecialLeaveDays": "0",
      "totalWorkHours": "160.0",
      "totalOverHours": "2.5",
      "totalHolidayWorkHours": "0.0"
    },
    "created": false
    }
    // companyIdが指定されていない場合は、複数の会社の勤怠情報が含まれる
  ]
}
```

| フィールド | 型 | 説明 |
|---------|------|------|
| success | Boolean | 処理成功フラグ |
| attendances | Array | 勤怠情報オブジェクトの配列 |
| attendances[].id | String (UUID) | 勤怠情報ID |
| attendances[].year | Number | 対象年 |
| attendances[].month | Number | 対象月 |
| attendances[].companyId | String (UUID) | 勤怠情報提出先ID |
| attendances[].details | Array | 日毎の勤怠詳細の配列 |
| attendances[].summary | Object | 勤怠情報のサマリ |
| attendances[].created | Boolean | 新規作成されたかどうか（true: 自動作成された、false: 既存データ） |

### 2.4 エラーレスポンス
```json
{
  "success": false,
  "error": {
    "code": "UNAUTHORIZED_ACCESS",
    "message": "この勤怠情報へのアクセス権限がありません"
  }
}
```

## 3. 機能詳細

### 3.1 勤怠情報の取得
- 指定された年月に基づいて勤怠情報をデータベースから検索
- companyIdが指定されている場合は、そのcompanyIdの勤怠情報のみを検索
- companyIdが指定されていない場合は、指定された年月の全ての会社の勤怠情報を検索
- 勤怠情報が存在する場合は、その情報を返却（created=false）
- 勤怠情報が存在しない場合は、自動勤怠情報作成処理を実行

### 3.2 自動勤怠情報作成
- 指定された年月の位置情報データを時系列で取得
- 位置情報と勤怠情報提出先の位置情報を照合
- 勤怠提出先の位置情報への接近・離脱パターンから勤務開始・終了時刻を判定
- 勤怠情報提出先の規定勤怠時間も参考に勤務時間を算出
- 以下の条件で判定を行う：
  1. 勤怠提出先の近接判定（閾値: 100m以内）
- 勤怠情報を新規作成し、データベースに保存（created=true）

### 3.3 勤怠情報のサマリ計算
- 日毎の勤怠情報から月次のサマリ情報を計算
  - 総勤務日数
  - 総有給休暇日数
  - 総代休日数
  - 総特別休暇日数
  - 総勤務時間
  - 総残業時間
  - 総休日出勤時間

## 4. 機能特有の非機能要件

### 4.1 勤怠情報特有のセキュリティ要件
- 勤怠情報の閲覧・編集権限管理：本人、管理者、および権限を付与された者のみアクセス可能
- 勤怠情報のバージョン管理：編集履歴を保持

### 4.2 自動作成に関する要件
- 位置情報が不足している場合は、勤怠情報提出先の規定勤怠開始・終了時刻からデフォルトの値を生成する
- 自動作成された勤怠情報は「自動作成フラグ」を付与し、手動での確認・修正を促す

## 5. 技術的実装詳細

### 5.1 勤務判定アルゴリズム
位置情報データから勤務時間を判定するアルゴリズム概要：

```javascript
function determineWorkingHours(locationData, companyLocation) {
  // 1. 位置情報をタイムスタンプでソート
  const sortedLocations = sortByTimestamp(locationData);
  
  // 2. 会社近辺（100m以内）にいる時間帯を特定
  const proximityPeriods = identifyProximityPeriods(sortedLocations, companyLocation, 100);
  
  // 3. 位置情報に基づいて勤務開始・終了時刻を決定
  // 位置情報がない場合は、規定時間をデフォルト値として使用
  const workingHours = determineWorkHoursFromProximity(proximityPeriods, companyRegulationHours);
  
  return workingHours;
}
```

### 5.2 休暇判定ロジック
- 勤務開始・終了記録がない平日は未入力と判定
- 祝日・休日マスタと照合し、休日判定
- 休暇種別は自動判定を行う：
  - 規定休憩開始時刻までに勤務開始していない場合は自動的に午前有給と判定
  - 規定休憩終了時刻以前に勤怠終了している場合は自動的に午後有給と判定
  - 有給や代休の残日数を参照して消費する休暇種別を決定

## 6. 拡張性考慮事項

### 6.1 将来的な拡張可能性
- カレンダー情報との連携による休暇予定の自動反映
- 複数の勤務地に対応した勤怠判定ロジックの拡張

### 6.2 制限事項
- 複数の勤務地を短時間で移動する場合の判定精度に限界がある
- 在宅勤務など固定の勤務地以外での勤務は自動判定が困難

## 7. テスト方針
- 単体テスト: 勤怠時間判定ロジックのテスト
- API統合テスト: リクエスト/レスポンスの整合性確認
- ケーステスト: 様々な勤務パターンでの自動判定精度の検証
- データ欠損テスト: 位置情報が部分的に欠損している場合の挙動確認
