# 勤怠情報提出先登録機能 機能設計

## 1. 機能概要

勤怠情報提出先登録機能は、新しい勤怠情報提出先（会社・組織）をシステムに登録するためのAPIです。この機能では、提出先の基本情報（会社名、所在地）、規定勤務時間、所属期間などを設定し、ユーザーが複数の提出先に対応できるようにします。

## 2. API仕様

### 2.1 エンドポイント
```
POST /api/v1/companies
```

### 2.2 リクエスト形式

```json
{
  "companyName": "株式会社サンプル",
  "location": {
    "latitude": "35.6762",
    "longitude": "139.6503"
  },
  "regulationStartTime": "09:00",
  "regulationEndTime": "18:00",
  "regulationRestStartTime": "12:00",
  "regulationRestEndTime": "13:00",
  "affiliationStartDate": "2025-01-01",
  "affiliationEndDate": null
}
```

### 2.3 リクエストパラメータ

| パラメータ名 | 型 | 必須 | 説明 |
|------------|---|-----|-----|
| companyName | String | ○ | 会社名（1文字以上100文字以内） |
| location | Object | ○ | 勤務地の位置情報 |
| location.latitude | String | ○ | 緯度（-90.0～90.0の範囲） |
| location.longitude | String | ○ | 経度（-180.0～180.0の範囲） |
| regulationStartTime | String | ○ | 規定勤務開始時刻（HH:mm形式） |
| regulationEndTime | String | ○ | 規定勤務終了時刻（HH:mm形式） |
| regulationRestStartTime | String | × | 規定休憩開始時刻（HH:mm形式） |
| regulationRestEndTime | String | × | 規定休憩終了時刻（HH:mm形式） |
| affiliationStartDate | String | ○ | 所属開始日（YYYY-MM-DD形式） |
| affiliationEndDate | String | × | 所属終了日（YYYY-MM-DD形式、null可） |

### 2.4 レスポンス形式

#### 2.4.1 成功レスポンス（201 Created）
```json
{
  "status": "success",
  "data": {
    "company": {
      "id": "12345678-1234-1234-1234-123456789abc",
      "companyName": "株式会社サンプル",
      "location": {
        "latitude": "35.6762",
        "longitude": "139.6503"
      },
      "regulationStartTime": "09:00",
      "regulationEndTime": "18:00",
      "regulationRestStartTime": "12:00",
      "regulationRestEndTime": "13:00",
      "affiliationStartDate": "2025-01-01",
      "affiliationEndDate": null,
      "createdAt": "2025-06-08T10:30:00+09:00",
      "updatedAt": "2025-06-08T10:30:00+09:00"
    }
  }
}
```

#### 2.4.2 エラーレスポンス（400 Bad Request）
```json
{
  "status": "error",
  "error": {
    "code": "VALIDATION_ERROR",
    "message": "入力データに不正な値が含まれています",
    "details": [
      {
        "field": "companyName",
        "message": "会社名は1文字以上100文字以内で入力してください"
      },
      {
        "field": "location.latitude",
        "message": "緯度は-90.0から90.0の範囲で入力してください"
      }
    ]
  }
}
```

### 2.5 HTTPステータスコード

| ステータスコード | 説明 |
|---------------|-----|
| 201 Created | 勤怠情報提出先が正常に作成された |
| 400 Bad Request | リクエストパラメータに不正な値が含まれている |
| 401 Unauthorized | 認証が必要、または認証に失敗した |
| 403 Forbidden | リクエストしたリソースへのアクセス権限がない |
| 409 Conflict | 同じ会社名が既に存在している |
| 500 Internal Server Error | サーバー内部エラー |

## 3. 機能詳細

### 3.1 入力値検証

#### 3.1.1 基本検証
- **会社名**: 1文字以上100文字以内、特殊文字制限
- **位置情報**: 緯度(-90.0～90.0)、経度(-180.0～180.0)の数値範囲チェック
- **時刻フォーマット**: HH:mm形式（24時間制）の妥当性チェック
- **日付フォーマット**: YYYY-MM-DD形式の妥当性チェック

#### 3.1.2 業務ロジック検証
- **勤務時間整合性**: 開始時刻 < 終了時刻の確認
- **休憩時間整合性**: 休憩開始時刻 < 休憩終了時刻、勤務時間内の確認
- **所属期間整合性**: 開始日 ≤ 終了日（終了日指定時）の確認
- **重複チェック**: 同一ユーザーの同じ会社名の重複登録を防止

### 3.2 データ保存処理

#### 3.2.1 UUID生成
```typescript
import { v4 as uuidv4 } from 'uuid';

const companyId = uuidv4();
```

#### 3.2.2 位置情報の正規化
```typescript
const normalizeLocation = (location: LocationInput) => {
  return {
    latitude: parseFloat(location.latitude).toFixed(6),
    longitude: parseFloat(location.longitude).toFixed(6)
  };
};
```

#### 3.2.3 データベース保存
```typescript
const company = {
  id: companyId,
  userId: authenticatedUserId,
  companyName: request.companyName,
  location: normalizeLocation(request.location),
  regulationStartTime: request.regulationStartTime,
  regulationEndTime: request.regulationEndTime,
  regulationRestStartTime: request.regulationRestStartTime || null,
  regulationRestEndTime: request.regulationRestEndTime || null,
  affiliationStartDate: new Date(request.affiliationStartDate),
  affiliationEndDate: request.affiliationEndDate ? new Date(request.affiliationEndDate) : null,
  createdAt: new Date(),
  updatedAt: new Date()
};
```

## 4. セキュリティ要件

### 4.1 共通セキュリティ基盤
**参照**: セキュリティ要件記載標準 3節
- 認証・認可: JWT ベース認証、役割ベースアクセス制御
- 通信セキュリティ: HTTPS必須、CORS設定
- 監査・ログ: アクセスログ、操作ログ、セキュリティログ

### 4.2 機能固有セキュリティ要件

#### 4.2.1 アクセス制御
**所有者ベースアクセス制御**:
- 基本原則: ユーザーは自分のデータのみアクセス可能
- 例外権限: 管理者権限・上司権限による他ユーザーデータアクセス
- 権限チェック: APIレベル・サービスレベルでの二重チェック

#### 4.2.2 データ保護
**提出先登録権限**:
- ユーザー単位のアクセス制御: ユーザーは自身の提出先のみ登録可能
- 入力値サニタイゼーション: XSS、SQLインジェクション対策

**位置情報セキュリティ**:
- 位置情報の暗号化: 機密性の高い位置情報は暗号化して保存
- 会社情報の機密性: 会社名や勤務規定は適切なアクセス制御下で管理

## 5. パフォーマンス要件

### 5.1 応答時間
- **通常登録処理**: 500ms以内
- **複雑検証処理**: 1秒以内
- **バッチ処理**: 2秒以内

### 5.2 スループット
- **同時リクエスト**: 50リクエスト/秒まで対応
- **ピーク時負荷**: 通常時の120%まで対応
- **ユーザー単位制限**: 3リクエスト/秒

### 5.3 処理効率化
- **データベースクエリ**: インデックス活用による高速化
- **キャッシュ戦略**: 会社情報の一時キャッシュ
- **同時処理制御**: ユーザー単位での排他制御

### 5.4 リソース使用量
- **CPU使用率**: 50%以下
- **メモリ使用量**: 70%以下
- **DB接続数**: 30接続以下

## 6. エラーハンドリング

### 6.1 バリデーションエラー
```typescript
const validateCompanyData = (data: CompanyInput) => {
  const errors: ValidationError[] = [];
  
  if (!data.companyName || data.companyName.length > 100) {
    errors.push({
      field: 'companyName',
      message: '会社名は1文字以上100文字以内で入力してください'
    });
  }
  
  if (!isValidLatitude(data.location.latitude)) {
    errors.push({
      field: 'location.latitude',
      message: '緯度は-90.0から90.0の範囲で入力してください'
    });
  }
  
  return errors;
};
```

### 6.2 重複エラー
```typescript
const checkDuplicate = async (userId: string, companyName: string) => {
  const existing = await CompanyRepository.findByUserAndName(userId, companyName);
  if (existing) {
    throw new ConflictError('同じ会社名が既に登録されています');
  }
};
```

## 7. テスト方針

### 7.1 単体テスト
- **入力値検証**: 各パラメータの境界値テスト
- **業務ロジック**: 時刻整合性、期間整合性の検証テスト
- **エラーハンドリング**: 異常系のテストケース

### 7.2 統合テスト
- **API エンドポイント**: 正常系・異常系の統合テスト
- **データベース**: トランザクション処理、制約条件の確認

### 7.3 パフォーマンステスト
- **負荷テスト**: 同時リクエスト処理の性能確認
- **応答時間**: 規定時間内での処理完了確認

## 8. 依存関係

### 8.1 システム内依存
- **認証サービス**: JWT認証による本人確認
- **ユーザー管理サービス**: ユーザー情報の参照
- **データベース**: Company テーブルへのデータ保存

### 8.2 外部依存
- **位置情報検証サービス**: 位置情報の妥当性検証（オプション）
- **地図サービス**: 住所から位置情報への変換（将来機能）

## 9. 変更履歴

| 日付 | 変更者 | 変更内容 |
|-----|-------|---------|
| 2025/06/08 | カーン | 初版作成 |
